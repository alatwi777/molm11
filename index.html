<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <style>
        /* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… ===== */
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 20px rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
            --radius-xl: 20px;
            --radius-lg: 15px;
            --radius-md: 10px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            min-height: 100vh;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ===== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .splash-logo {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        
        .splash-logo i {
            font-size: 60px;
            color: white;
        }
        
        .splash-text {
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .loader {
            display: flex;
            gap: 10px;
        }
        
        .loader-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* ===== Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ===== */
        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: var(--gradient-primary);
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 50px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .login-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
        }
        
        .login-icon i {
            font-size: 36px;
            color: white;
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid #e9ecef;
        }
        
        .login-tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .login-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .form-group {
            margin-bottom: 25px;
            text-align: right;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: white;
            color: var(--dark);
            border: 2px solid #e9ecef;
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .alert {
            padding: 15px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-right: 4px solid #ef4444;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-right: 4px solid #10b981;
        }
        
        /* ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ===== */
        .student-container {
            min-height: 100vh;
            background: white;
        }
        
        .student-header {
            background: var(--gradient-primary);
            color: white;
            padding: 25px;
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            box-shadow: var(--shadow-md);
        }
        
        .student-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: var(--radius-md);
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* ===== ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ===== */
        .exam-container {
            padding: 30px 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .exam-header {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .exam-timer {
            background: var(--danger);
            color: white;
            padding: 15px 25px;
            border-radius: var(--radius-md);
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            border-right: 5px solid var(--primary);
            display: none;
        }
        
        .question-card.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .question-number {
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-left: 20px;
        }
        
        .question-text {
            font-size: 1.3rem;
            line-height: 1.6;
            flex: 1;
        }
        
        .options-container {
            margin: 25px 0;
        }
        
        .option-label {
            display: block;
            padding: 18px 20px;
            margin-bottom: 12px;
            border: 2px solid #e9ecef;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-size: 1.1rem;
        }
        
        .option-label:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .option-label.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .option-input {
            margin-left: 10px;
        }
        
        /* ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… ===== */
        .drawing-container {
            margin: 25px 0;
            border: 2px solid #e9ecef;
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .drawing-tools {
            background: #f8f9fa;
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tool-btn {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }
        
        .tool-btn.active {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .drawing-canvas {
            width: 100%;
            height: 400px;
            background: white;
            cursor: crosshair;
            touch-action: none;
        }
        
        /* ===== Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… ===== */
        .exam-controls {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-top: 30px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-container {
            flex: 1;
            margin: 0 30px;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ===== Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ===== */
        .finish-exam-btn {
            background: var(--success);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            text-align: center;
            justify-content: center;
        }
        
        .finish-exam-btn:hover {
            background: #3a8bc8;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù„Ù… ===== */
        .teacher-container {
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .teacher-header {
            background: var(--gradient-primary);
            color: white;
            padding: 25px;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .teacher-nav {
            background: white;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .teacher-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .teacher-tab {
            padding: 12px 25px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: var(--radius-md);
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .teacher-tab:hover {
            border-color: var(--primary);
        }
        
        .teacher-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .teacher-content {
            display: none;
            padding: 20px;
        }
        
        .teacher-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ===== Ø§Ù„ÙƒØ±ÙˆØª ===== */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ===== Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ===== */
        .table-responsive {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: right;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #e9ecef;
        }
        
        .table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        /* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ===== */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 8px 15px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-edit {
            background: #4cc9f0;
            color: white;
        }
        
        .btn-delete {
            background: #f72585;
            color: white;
        }
        
        .btn-correct {
            background: #f8961e;
            color: white;
        }
        
        .btn-view {
            background: #4361ee;
            color: white;
        }
        
        .btn-print {
            background: #3a0ca3;
            color: white;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        /* ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel ===== */
        .excel-upload {
            border: 3px dashed #dee2e6;
            border-radius: var(--radius-md);
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .excel-upload:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .excel-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        /* ===== Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØµØ­ÙŠØ­ ===== */
        .correction-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .correction-modal.active {
            display: flex;
        }
        
        .correction-container {
            background: white;
            width: 95%;
            height: 90vh;
            border-radius: var(--radius-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .correction-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .correction-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            gap: 20px;
        }
        
        .correction-info {
            flex: 1;
            max-width: 300px;
        }
        
        .correction-canvas-container {
            flex: 2;
            background: #f8f9fa;
            border-radius: var(--radius-md);
            padding: 20px;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        /* ===== Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ===== */
        .completion-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .completion-message.active {
            display: flex;
        }
        
        .message-card {
            background: white;
            padding: 50px;
            border-radius: var(--radius-xl);
            text-align: center;
            max-width: 500px;
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* ===== Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===== */
        .exam-creation-form {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }
        
        .exam-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .question-builder {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
            border: 2px solid #e9ecef;
        }
        
        .questions-preview {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: var(--radius-md);
        }
        
        .preview-question-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: var(--radius-md);
            border-right: 3px solid var(--primary);
        }
        
        /* ===== Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„Ù„Ø·Ø§Ù„Ø¨ ===== */
        .student-success-message {
            background: white;
            border-radius: var(--radius-xl);
            padding: 50px;
            text-align: center;
            max-width: 600px;
            margin: 50px auto;
            box-shadow: var(--shadow-lg);
        }
        
        .success-icon {
            font-size: 80px;
            color: var(--success);
            margin-bottom: 20px;
        }
        
        /* ===== Ø§Ù„ØªØ¬Ø§ÙˆØ¨ÙŠØ© ===== */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .login-card {
                padding: 30px 20px;
            }
            
            .student-info-grid {
                grid-template-columns: 1fr;
            }
            
            .exam-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .exam-controls {
                flex-direction: column;
                gap: 20px;
            }
            
            .progress-container {
                width: 100%;
                margin: 0;
            }
            
            .teacher-tabs {
                flex-wrap: wrap;
            }
            
            .correction-body {
                flex-direction: column;
            }
            
            .correction-info {
                max-width: 100%;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .exam-form-grid {
                grid-template-columns: 1fr;
            }
            
            .drawing-canvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="splash-text">Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</div>
        <div class="loader">
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
            <div class="loader-dot"></div>
        </div>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 style="margin-bottom: 30px; color: var(--primary);">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©</h2>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="showLoginTab('student')">Ø·Ø§Ù„Ø¨</button>
                <button class="login-tab" onclick="showLoginTab('teacher')">Ù…Ø¹Ù„Ù…</button>
            </div>
            
            <!-- ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
            <div id="studentLogin" class="login-form">
                <div class="alert alert-danger" id="studentLoginError" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="studentErrorMsg"></span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
                    <input type="text" class="form-control" id="studentCivilId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                    <input type="text" class="form-control" id="examCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
                </div>
                
                <button class="btn btn-primary" onclick="studentLogin()">
                    <i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                </button>
            </div>
            
            <!-- ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… -->
            <div id="teacherLogin" class="login-form" style="display: none;">
                <div class="alert alert-danger" id="teacherLoginError" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="teacherErrorMsg"></span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…</label>
                    <input type="text" class="form-control" id="teacherCivilId" placeholder="1234">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                    <input type="password" class="form-control" id="teacherCode" placeholder="100">
                </div>
                
                <button class="btn btn-primary" onclick="teacherLogin()">
                    <i class="fas fa-chalkboard-teacher"></i> Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
            </div>
        </div>
    </div>
    
    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ -->
    <div class="student-container" id="studentContainer" style="display: none;">
        <div class="student-header">
            <h1><i class="fas fa-user-graduate"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>
            <div class="student-info-grid" id="studentInfoGrid"></div>
        </div>
        
        <div class="exam-container" id="examContainer">
            <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
        </div>
    </div>
    
    <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„Ù„Ø·Ø§Ù„Ø¨ -->
    <div class="student-success-message" id="studentSuccessMessage" style="display: none;">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h2 style="margin-bottom: 20px; color: var(--primary);">Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­</h2>
        <p style="margin-bottom: 30px; color: #666; font-size: 1.2rem; line-height: 1.6;">
            Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>
            Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
        </p>
        <button class="btn btn-primary" onclick="returnToLogin()" style="padding: 15px 50px;">
            <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
    </div>
    
    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù„Ù… -->
    <div class="teacher-container" id="teacherContainer" style="display: none;">
        <div class="teacher-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="color: white; margin-bottom: 5px;">
                        <i class="fas fa-chalkboard-teacher"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…
                    </h1>
                    <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">
                        Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate"></span>
                    </p>
                </div>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
        
        <div class="teacher-nav">
            <div class="teacher-tabs">
                <button class="teacher-tab active" onclick="showTeacherTab('students')">
                    <i class="fas fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                </button>
                <button class="teacher-tab" onclick="showTeacherTab('exams')">
                    <i class="fas fa-file-alt"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                </button>
                <button class="teacher-tab" onclick="showTeacherTab('results')">
                    <i class="fas fa-chart-bar"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØµØ­ÙŠØ­
                </button>
            </div>
        </div>
        
        <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
        <div class="teacher-content active" id="studentsTab">
            <div class="card">
                <h2><i class="fas fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary btn-sm" onclick="showAddStudentModal()" style="margin-left: 10px;">
                        <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨
                    </button>
                    <label class="btn btn-primary btn-sm" style="cursor: pointer;">
                        <i class="fas fa-file-excel"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" 
                               style="display: none;" onchange="importStudentsFromExcel(event)">
                    </label>
                </div>
                
                <div class="table-responsive">
                    <table class="table" id="studentsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„ØµÙ</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª -->
        <div class="teacher-content" id="examsTab">
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
                
                <div class="exam-creation-form">
                    <div class="exam-form-grid">
                        <div class="form-group">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                            <input type="text" class="form-control" id="examName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <select class="form-control" id="examYear">
                                <option value="1445">1445Ù‡Ù€</option>
                                <option value="1446">1446Ù‡Ù€</option>
                                <option value="1447">1447Ù‡Ù€</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                            <input type="text" class="form-control" id="examSubject" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ø²Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                            <input type="number" class="form-control" id="examDuration" value="60" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                            <input type="text" class="form-control" id="examCodeInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="createNewExam()">
                        <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                </div>
                
                <!-- Ù…Ù†Ø´Ø¦ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
                <div id="questionBuilderContainer" style="display: none;">
                    <div class="question-builder">
                        <h3><i class="fas fa-question-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                                <select class="form-control" id="questionType" onchange="toggleQuestionOptions()">
                                    <option value="mcq">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                                    <option value="essay">Ù…Ù‚Ø§Ù„ÙŠ</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                                <input type="number" class="form-control" id="questionScore" value="1" min="1">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                            <textarea class="form-control" id="questionText" rows="3" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"></textarea>
                        </div>
                        
                        <div id="mcqOptionsContainer" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 15px;">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h4>
                            <div id="optionsContainer">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="radio" name="correctOption" value="0" checked>
                                    <input type="text" class="form-control" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„" id="option0">
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="radio" name="correctOption" value="1">
                                    <input type="text" class="form-control" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ" id="option1">
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addOption()" style="margin-top: 10px;">
                                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±
                            </button>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="addQuestionToExam()">
                                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„
                            </button>
                            <button class="btn btn-success" onclick="saveExamWithQuestions()">
                                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
                    <div class="questions-preview" id="questionsPreview">
                        <h4 style="margin-bottom: 15px;">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h4>
                        <div id="questionsList">
                            <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </div>
                    </div>
                </div>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª -->
                <div style="margin-top: 40px;">
                    <h2><i class="fas fa-list"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
                    <div class="table-responsive">
                        <table class="table" id="examsTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                    <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="examsTableBody">
                                <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØµØ­ÙŠØ­ -->
        <div class="teacher-content" id="resultsTab">
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØµØ­ÙŠØ­</h2>
                
                <div class="table-responsive">
                    <table class="table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ù†Ø§ÙØ°Ø© ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ -->
    <div class="correction-modal" id="correctionModal">
        <div class="correction-container">
            <div class="correction-header">
                <div>
                    <h2 style="color: white; margin: 0;">
                        <i class="fas fa-pen-alt"></i> ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©
                    </h2>
                    <p style="color: rgba(255, 255, 255, 0.9); margin-top: 5px;">
                        Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="correctionStudentName"></span> | Ø§Ù„Ø³Ø¤Ø§Ù„: <span id="correctionQuestionNum"></span>
                    </p>
                </div>
                <div>
                    <button class="btn-action btn-view" onclick="saveCorrection()">
                        <i class="fas fa-save"></i> Ø­ÙØ¸
                    </button>
                    <button class="btn-action btn-delete" onclick="closeCorrection()" style="margin-right: 10px;">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
            
            <div class="correction-body">
                <div class="correction-info">
                    <div class="card">
                        <h3><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­</h3>
                        <div style="margin-bottom: 15px;">
                            <div style="color: #666; font-size: 0.9rem;">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="currentEssayScore">0</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="color: #666; font-size: 0.9rem;">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</div>
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--success);" id="maxEssayScore">10</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ØªØ¹ÙŠÙŠÙ† Ø¯Ø±Ø¬Ø© Ø¬Ø¯ÙŠØ¯Ø©</label>
                            <input type="number" class="form-control" id="newEssayScore" min="0">
                        </div>
                        <button class="btn btn-primary" onclick="updateEssayScore()">
                            <i class="fas fa-check"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø¬Ø©
                        </button>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                        <div id="essayQuestionsList"></div>
                    </div>
                </div>
                
                <div class="correction-canvas-container">
                    <div style="background: white; padding: 20px; border-radius: var(--radius-md); margin-bottom: 20px;">
                        <h3 id="essayQuestionText"></h3>
                        <div id="essayAnswerText" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: var(--radius-md);"></div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-paint-brush"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØµØ­ÙŠØ­</h3>
                        <div class="drawing-tools">
                            <button class="tool-btn active" onclick="selectCorrectionTool('pen')">
                                <i class="fas fa-pen"></i> Ù‚Ù„Ù… ØªØµØ­ÙŠØ­
                            </button>
                            <button class="tool-btn" onclick="selectCorrectionTool('eraser')">
                                <i class="fas fa-eraser"></i> Ù…Ù…Ø­Ø§Ø©
                            </button>
                            <input type="color" id="correctionColor" value="#f72585" onchange="changeCorrectionColor(this.value)">
                            <input type="range" id="correctionSize" min="1" max="10" value="3" onchange="changeCorrectionSize(this.value)">
                            <button class="tool-btn" onclick="clearCorrectionCanvas()">
                                <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                            </button>
                        </div>
                        <canvas id="correctionCanvas" class="drawing-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn-action btn-view" onclick="previousEssay()">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                <span id="correctionPosition">1 / 1</span>
                <button class="btn-action btn-view" onclick="nextEssay()">
                    Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ğŸ”¥ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAvdFgW-zTkZ7oq7wI3MjgKfX-TqgAUnyQ",
            authDomain: "teacher-app-1a576.firebaseapp.com",
            projectId: "teacher-app-1a576",
            storageBucket: "teacher-app-1a576.firebasestorage.app",
            messagingSenderId: "194924958624",
            appId: "1:194924958624:web:aa1096b5d70444850413a1"
        };
        
        // ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =====
        let db;
        let isOnline = false;
        let students = [];
        let questions = [];
        let exams = [];
        let results = [];
        let currentStudent = null;
        let currentExam = null;
        let studentAnswers = [];
        let currentQuestionIndex = 0;
        let examTimer = null;
        let timeRemaining = 0;
        let currentCorrectionResult = null;
        let currentEssayIndex = 0;
        let correctionCtx = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let drawingHistory = [];
        let currentTool = 'pen';
        let currentCreatingExam = null;
        let examQuestions = [];
        
        // ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                }, 500);
            }, 1500);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isOnline = true;
                console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase');
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                await loadDataFromFirebase();
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                setupRealtimeListeners();
                
            } catch (error) {
                console.log('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');
                isOnline = false;
                loadDataFromLocalStorage();
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-SA');
        });
        
        // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© =====
        async function loadDataFromFirebase() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
                const studentsSnapshot = await db.collection('students').get();
                const studentsData = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                students = removeDuplicates(studentsData, 'civilId');
                localStorage.setItem('students', JSON.stringify(students));
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                const questionsSnapshot = await db.collection('questions').get();
                questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('questions', JSON.stringify(questions));
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                const examsSnapshot = await db.collection('exams').get();
                exams = examsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('exams', JSON.stringify(exams));
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const resultsSnapshot = await db.collection('results').get();
                results = resultsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('results', JSON.stringify(results));
                
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }
        
        function loadDataFromLocalStorage() {
            const studentsData = JSON.parse(localStorage.getItem('students')) || [];
            students = removeDuplicates(studentsData, 'civilId');
            questions = JSON.parse(localStorage.getItem('questions')) || [];
            exams = JSON.parse(localStorage.getItem('exams')) || [];
            results = JSON.parse(localStorage.getItem('results')) || [];
        }
        
        function removeDuplicates(array, key) {
            const seen = new Set();
            return array.filter(item => {
                const value = item[key];
                if (seen.has(value)) {
                    return false;
                }
                seen.add(value);
                return true;
            });
        }
        
        function setupRealtimeListeners() {
            if (!isOnline) return;
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
            db.collection('students').onSnapshot((snapshot) => {
                const updatedStudents = [];
                snapshot.forEach(doc => {
                    updatedStudents.push({ id: doc.id, ...doc.data() });
                });
                
                students = removeDuplicates(updatedStudents, 'civilId');
                localStorage.setItem('students', JSON.stringify(students));
                
                if (currentMode === 'teacher') updateStudentsTable();
            });
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            db.collection('questions').onSnapshot((snapshot) => {
                questions = [];
                snapshot.forEach(doc => {
                    questions.push({ id: doc.id, ...doc.data() });
                });
                localStorage.setItem('questions', JSON.stringify(questions));
            });
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            db.collection('exams').onSnapshot((snapshot) => {
                exams = [];
                snapshot.forEach(doc => {
                    exams.push({ id: doc.id, ...doc.data() });
                });
                localStorage.setItem('exams', JSON.stringify(exams));
                if (currentMode === 'teacher') updateExamsTable();
            });
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            db.collection('results').onSnapshot((snapshot) => {
                results = [];
                snapshot.forEach(doc => {
                    results.push({ id: doc.id, ...doc.data() });
                });
                localStorage.setItem('results', JSON.stringify(results));
                if (currentMode === 'teacher') updateResultsTable();
            });
        }
        
        async function saveToFirebase(collection, data) {
            if (!isOnline) return data.id || 'local_' + Date.now();
            
            try {
                let docRef;
                if (data.id && !data.id.startsWith('local_')) {
                    const { id, ...dataWithoutId } = data;
                    await db.collection(collection).doc(id).set(dataWithoutId);
                    return id;
                } else {
                    docRef = await db.collection(collection).add(data);
                    return docRef.id;
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
                return 'local_' + Date.now();
            }
        }
        
        async function deleteFromFirebase(collection, id) {
            if (!isOnline || id.startsWith('local_')) return true;
            
            try {
                await db.collection(collection).doc(id).delete();
                return true;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', error);
                return false;
            }
        }
        
        // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª =====
        let currentMode = 'login';
        
        function showLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.style.display = 'none');
            
            if (tab === 'student') {
                document.querySelector('.login-tab[onclick="showLoginTab(\'student\')"]').classList.add('active');
                document.getElementById('studentLogin').style.display = 'block';
            } else {
                document.querySelector('.login-tab[onclick="showLoginTab(\'teacher\')"]').classList.add('active');
                document.getElementById('teacherLogin').style.display = 'block';
            }
        }
        
        function studentLogin() {
            const civilId = document.getElementById('studentCivilId').value.trim();
            const examCode = document.getElementById('examCode').value.trim();
            
            if (!civilId || !examCode) {
                showError('studentLoginError', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
            const student = students.find(s => s.civilId === civilId);
            if (!student) {
                showError('studentLoginError', 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„');
                return;
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            const exam = exams.find(e => e.code === examCode && e.status === 'active');
            if (!exam) {
                showError('studentLoginError', 'ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± ÙØ¹Ø§Ù„');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù… ÙŠØ¤Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ù‚Ø¨Ù„
            const existingResult = results.find(r => 
                r.studentCivilId === civilId && r.examCode === examCode
            );
            
            if (existingResult) {
                showError('studentLoginError', 'Ù„Ù‚Ø¯ Ø£Ø¯ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ù‚Ø¨Ù„');
                return;
            }
            
            currentStudent = student;
            currentExam = exam;
            studentAnswers = [];
            currentQuestionIndex = 0;
            
            // ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            currentExam.questionsData = [];
            if (currentExam.questions && Array.isArray(currentExam.questions)) {
                currentExam.questionsData = currentExam.questions.map(qId => 
                    questions.find(q => q.id === qId)
                ).filter(q => q);
            }
            
            if (currentExam.questionsData.length === 0) {
                showError('studentLoginError', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
                return;
            }
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
            currentExam.questionsData.forEach((question) => {
                studentAnswers.push({
                    questionId: question.id,
                    questionText: question.text,
                    type: question.type,
                    answer: '',
                    score: 0,
                    maxScore: question.score
                });
            });
            
            // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('studentContainer').style.display = 'block';
            currentMode = 'student';
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
            updateStudentInfo();
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
            startTimer();
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„
            displayQuestion(0);
        }
        
        function teacherLogin() {
            const civilId = document.getElementById('teacherCivilId').value.trim();
            const code = document.getElementById('teacherCode').value.trim();
            
            if (civilId === '1234' && code === '100') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('teacherContainer').style.display = 'block';
                currentMode = 'teacher';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                updateStudentsTable();
                updateExamsTable();
                updateResultsTable();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-SA');
            } else {
                showError('teacherLoginError', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        }
        
        function logout() {
            document.getElementById('teacherContainer').style.display = 'none';
            document.getElementById('studentContainer').style.display = 'none';
            document.getElementById('studentSuccessMessage').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            currentMode = 'login';
            
            // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('teacherCivilId').value = '';
            document.getElementById('teacherCode').value = '';
            document.getElementById('studentCivilId').value = '';
            document.getElementById('examCode').value = '';
            showLoginTab('teacher');
        }
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.querySelector('span').textContent = message;
            element.style.display = 'flex';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        // ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ =====
        function updateStudentInfo() {
            const grid = document.getElementById('studentInfoGrid');
            grid.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Ø§Ù„Ø·Ø§Ù„Ø¨</div>
                    <div class="info-value">${currentStudent.name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                    <div class="info-value">${currentExam.name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø§Ù„Ù…Ø§Ø¯Ø©</div>
                    <div class="info-value">${currentExam.subject}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                    <div class="info-value">${currentExam.code}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø§Ù„ØµÙ</div>
                    <div class="info-value">${currentStudent.class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div>
                    <div class="info-value">${currentExam.year || '1445Ù‡Ù€'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                    <div class="info-value">${currentExam.duration} Ø¯Ù‚ÙŠÙ‚Ø©</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                    <div class="info-value">${currentExam.questionsData.length}</div>
                </div>
            `;
        }
        
        function startTimer() {
            timeRemaining = currentExam.duration * 60;
            updateTimerDisplay();
            
            examTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(examTimer);
                    submitExam();
                    alert('â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!');
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            let timerElement = document.querySelector('.exam-timer');
            if (!timerElement) {
                const examContainer = document.getElementById('examContainer');
                const headerHTML = `
                    <div class="exam-header">
                        <h2 style="margin: 0;">${currentExam.name}</h2>
                        <div class="exam-timer">
                            <i class="fas fa-clock"></i>
                            <span>${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>
                        </div>
                    </div>
                `;
                examContainer.innerHTML = headerHTML;
            } else {
                timerElement.querySelector('span').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function displayQuestion(index) {
            const container = document.getElementById('examContainer');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const oldQuestions = container.querySelectorAll('.question-card');
            oldQuestions.forEach(card => card.remove());
            
            const question = currentExam.questionsData[index];
            if (!question) return;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card active';
            
            let questionHTML = `
                <div class="question-header">
                    <div class="question-number">${index + 1}</div>
                    <div class="question-text">${question.text}</div>
                </div>
            `;
            
            if (question.type === 'mcq' && question.options) {
                questionHTML += `<div class="options-container">`;
                question.options.forEach((option, optIndex) => {
                    const isSelected = studentAnswers[index].answer === option.text;
                    questionHTML += `
                        <label class="option-label ${isSelected ? 'selected' : ''}">
                            <input type="radio" name="question_${index}" 
                                   value="${option.text}" class="option-input"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="selectAnswer(${index}, '${option.text}')">
                            <span>${option.text}</span>
                        </label>
                    `;
                });
                questionHTML += `</div>`;
            } else if (question.type === 'essay') {
                questionHTML += `
                    <div class="drawing-container">
                        <div class="drawing-tools">
                            <button class="tool-btn active" onclick="selectDrawingTool('pen')">
                                <i class="fas fa-pen"></i> Ù‚Ù„Ù…
                            </button>
                            <button class="tool-btn" onclick="selectDrawingTool('eraser')">
                                <i class="fas fa-eraser"></i> Ù…Ù…Ø­Ø§Ø©
                            </button>
                            <input type="color" id="drawingColor" value="#000000" onchange="changeDrawingColor(this.value)">
                            <input type="range" id="drawingSize" min="1" max="10" value="3" onchange="changeDrawingSize(this.value)">
                            <button class="tool-btn" onclick="clearDrawingCanvas()">
                                <i class="fas fa-trash"></i> Ù…Ø³Ø­
                            </button>
                        </div>
                        <canvas id="drawingCanvas" class="drawing-canvas"></canvas>
                    </div>
                `;
            }
            
            questionCard.innerHTML = questionHTML;
            container.appendChild(questionCard);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø¤Ø§Ù„ Ù…Ù‚Ø§Ù„ÙŠØŒ ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù…
            if (question.type === 'essay') {
                setTimeout(() => initDrawingCanvas(index), 100);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            updateProgressBar();
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
            updateNavigationButtons(index);
        }
        
        function initDrawingCanvas(questionIndex) {
            const canvas = document.getElementById('drawingCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
            const savedDrawing = studentAnswers[questionIndex].answer;
            if (savedDrawing && savedDrawing.startsWith('data:')) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = savedDrawing;
            }
            
            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø³Ù…
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ù…Ø³
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                
                if (e.type === 'touchstart') {
                    const touch = e.touches[0];
                    lastX = touch.clientX - rect.left;
                    lastY = touch.clientY - rect.top;
                } else {
                    lastX = e.clientX - rect.left;
                    lastY = e.clientY - rect.top;
                }
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                let x, y;
                
                if (e.type === 'touchmove') {
                    const touch = e.touches[0];
                    x = touch.clientX - rect.left;
                    y = touch.clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                
                ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : document.getElementById('drawingColor').value;
                ctx.lineWidth = document.getElementById('drawingSize').value;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
                
                // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…
                studentAnswers[questionIndex].answer = canvas.toDataURL();
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                startDrawing(e);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                draw(e);
            }
        }
        
        function selectDrawingTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.drawing-tools .tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tool-btn').classList.add('active');
        }
        
        function changeDrawingColor(color) {
            // ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
        }
        
        function changeDrawingSize(size) {
            // ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
        }
        
        function clearDrawingCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            studentAnswers[currentQuestionIndex].answer = '';
            drawingHistory = [];
        }
        
        function selectAnswer(questionIndex, answer) {
            studentAnswers[questionIndex].answer = answer;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¸Ù‡Ø±
            const labels = document.querySelectorAll(`.question-card .option-label`);
            labels.forEach(label => label.classList.remove('selected'));
            event.target.closest('.option-label').classList.add('selected');
        }
        
        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / currentExam.questionsData.length) * 100;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªÙ‚Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            let progressFill = document.querySelector('.progress-fill');
            if (!progressFill) {
                const container = document.getElementById('examContainer');
                const controlsHTML = `
                    <div class="exam-controls">
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">
                            <i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
                        </button>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <div style="text-align: center; margin-top: 5px; font-size: 0.9rem;">
                                ${currentQuestionIndex + 1} / ${currentExam.questionsData.length}
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="nextBtn" onclick="nextQuestion()">
                            Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                `;
                container.innerHTML += controlsHTML;
                progressFill = document.querySelector('.progress-fill');
            }
            
            progressFill.style.width = `${progress}%`;
        }
        
        function updateNavigationButtons(index) {
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = index === 0;
                prevBtn.style.opacity = index === 0 ? '0.5' : '1';
            }
            
            if (nextBtn) {
                const isLastQuestion = index === currentExam.questionsData.length - 1;
                nextBtn.disabled = isLastQuestion;
                nextBtn.style.opacity = isLastQuestion ? '0.5' : '1';
                nextBtn.innerHTML = isLastQuestion ? 
                    '<i class="fas fa-flag-checkered"></i> Ø¥Ù†Ù‡Ø§Ø¡' : 
                    'Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i>';
                nextBtn.onclick = isLastQuestion ? finishExam : nextQuestion;
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ø®ÙŠØ±
            if (index === currentExam.questionsData.length - 1) {
                let finishBtn = document.querySelector('.finish-exam-btn');
                if (!finishBtn) {
                    const container = document.getElementById('examContainer');
                    const finishHTML = `
                        <button class="finish-exam-btn" onclick="finishExam()">
                            <i class="fas fa-paper-plane"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                        </button>
                    `;
                    container.innerHTML += finishHTML;
                }
            }
        }
        
        function previousQuestion() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const currentAnswer = studentAnswers[currentQuestionIndex];
            if (!currentAnswer.answer || currentAnswer.answer.trim() === '') {
                alert('âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø§Ø¨Ù‚');
                return;
            }
            
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
            }
        }
        
        function nextQuestion() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const currentAnswer = studentAnswers[currentQuestionIndex];
            if (!currentAnswer.answer || currentAnswer.answer.trim() === '') {
                alert('âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„');
                return;
            }
            
            if (currentQuestionIndex < currentExam.questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            }
        }
        
        function finishExam() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            const unanswered = studentAnswers.filter(a => !a.answer || a.answer.trim() === '');
            if (unanswered.length > 0) {
                const confirmFinish = confirm(`âŒ ÙŠÙˆØ¬Ø¯ ${unanswered.length} Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…Ø¬Ø§Ø¨\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Ø¨Ù‚Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¬Ø§Ø¨Ø©ØŸ`);
                if (!confirmFinish) return;
            }
            
            submitExam();
        }
        
        async function submitExam() {
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª
            clearInterval(examTimer);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
            let totalScore = 0;
            let totalMaxScore = 0;
            
            studentAnswers.forEach((answer, index) => {
                const question = currentExam.questionsData[index];
                totalMaxScore += question.score;
                
                if (question.type === 'mcq' && question.options) {
                    const correctOption = question.options.find(opt => opt.isCorrect);
                    if (correctOption && answer.answer === correctOption.text) {
                        answer.score = question.score;
                        totalScore += question.score;
                    }
                }
            });
            
            // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            const result = {
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                studentCivilId: currentStudent.civilId,
                examId: currentExam.id,
                examName: currentExam.name,
                examCode: currentExam.code,
                score: totalScore,
                totalScore: totalMaxScore,
                answers: studentAnswers,
                status: studentAnswers.some(a => a.type === 'essay') ? 'pending' : 'graded',
                submittedAt: new Date().toISOString(),
                hasEssay: studentAnswers.some(a => a.type === 'essay')
            };
            
            const resultId = await saveToFirebase('results', result);
            result.id = resultId;
            results.push(result);
            localStorage.setItem('results', JSON.stringify(results));
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            document.getElementById('studentContainer').style.display = 'none';
            document.getElementById('studentSuccessMessage').style.display = 'block';
        }
        
        function returnToLogin() {
            document.getElementById('studentSuccessMessage').style.display = 'none';
            document.getElementById('studentContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            
            // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('studentCivilId').value = '';
            document.getElementById('examCode').value = '';
            showLoginTab('student');
        }
        
        // ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ù„Ù… =====
        function showTeacherTab(tabId) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
            document.querySelectorAll('.teacher-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.teacher-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø¯Ø¯
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
            event.target.classList.add('active');
        }
        
        // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ =====
        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.civilId}</td>
                    <td>${student.name}</td>
                    <td>${student.class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${new Date(student.createdAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="editStudent('${student.id}')">
                                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteStudent('${student.id}')">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function showAddStudentModal() {
            const name = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:');
            if (!name) return;
            
            const civilId = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ:');
            if (!civilId) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ
            if (students.some(s => s.civilId === civilId)) {
                alert('âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }
            
            const className = prompt('Ø§Ø®ØªØ± Ø§Ù„ØµÙ:', 'Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·,Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·,Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·');
            
            const newStudent = {
                name,
                civilId,
                class: className || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                createdAt: new Date().toISOString()
            };
            
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
            saveToFirebase('students', newStudent).then(firebaseId => {
                newStudent.id = firebaseId;
                students.push(newStudent);
                localStorage.setItem('students', JSON.stringify(students));
                updateStudentsTable();
                alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            });
        }
        
        async function importStudentsFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    let importedCount = 0;
                    let duplicateCount = 0;
                    
                    for (const row of jsonData) {
                        const civilId = row['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ']?.toString().trim() || row['civilId']?.toString().trim();
                        const name = row['Ø§Ù„Ø§Ø³Ù…']?.toString().trim() || row['name']?.toString().trim();
                        const className = row['Ø§Ù„ØµÙ']?.toString().trim() || row['class']?.toString().trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        
                        if (civilId && name && civilId !== 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ') {
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
                            if (students.some(s => s.civilId === civilId)) {
                                duplicateCount++;
                                continue;
                            }
                            
                            const newStudent = {
                                civilId,
                                name,
                                class: className,
                                createdAt: new Date().toISOString()
                            };
                            
                            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                            const firebaseId = await saveToFirebase('students', newStudent);
                            newStudent.id = firebaseId;
                            students.push(newStudent);
                            importedCount++;
                        }
                    }
                    
                    localStorage.setItem('students', JSON.stringify(students));
                    updateStudentsTable();
                    
                    let message = `âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`;
                    if (duplicateCount > 0) {
                        message += `\nØªÙ… ØªØ®Ø·ÙŠ ${duplicateCount} Ø·Ø§Ù„Ø¨ (Ù…ÙƒØ±Ø±)`;
                    }
                    alert(message);
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù:', error);
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù');
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯Ø®Ù„
                event.target.value = '';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const newName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', student.name);
            if (!newName) return;
            
            const newClass = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', student.class);
            
            student.name = newName;
            student.class = newClass || student.class;
            
            saveToFirebase('students', student);
            localStorage.setItem('students', JSON.stringify(students));
            updateStudentsTable();
            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');
        }
        
        async function deleteStudent(studentId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) return;
            
            // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
            await deleteFromFirebase('students', studentId);
            
            // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ
            students = students.filter(s => s.id !== studentId);
            localStorage.setItem('students', JSON.stringify(students));
            
            updateStudentsTable();
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© =====
        function createNewExam() {
            const name = document.getElementById('examName').value.trim();
            const year = document.getElementById('examYear').value;
            const subject = document.getElementById('examSubject').value.trim();
            const duration = parseInt(document.getElementById('examDuration').value);
            const code = document.getElementById('examCodeInput').value.trim();
            
            if (!name || !subject || !code || !duration) {
                alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            if (exams.some(e => e.code === code)) {
                alert('âŒ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }
            
            currentCreatingExam = {
                name,
                year,
                subject,
                duration,
                code,
                status: 'draft',
                createdAt: new Date().toISOString()
            };
            
            examQuestions = [];
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø´Ø¦ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            document.getElementById('questionBuilderContainer').style.display = 'block';
            document.getElementById('questionsList').innerHTML = '';
            document.getElementById('questionsPreview').scrollIntoView({ behavior: 'smooth' });
            
            // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„
            document.getElementById('questionText').value = '';
            document.getElementById('questionScore').value = '1';
            toggleQuestionOptions();
            
            alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
        }
        
        function toggleQuestionOptions() {
            const type = document.getElementById('questionType').value;
            document.getElementById('mcqOptionsContainer').style.display = type === 'mcq' ? 'block' : 'none';
            
            if (type === 'mcq') {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                for (let i = 0; i < 2; i++) {
                    const optionDiv = document.createElement('div');
                    optionDiv.style.display = 'flex';
                    optionDiv.style.alignItems = 'center';
                    optionDiv.style.gap = '10px';
                    optionDiv.style.marginBottom = '10px';
                    optionDiv.innerHTML = `
                        <input type="radio" name="correctOption" value="${i}" ${i === 0 ? 'checked' : ''}>
                        <input type="text" class="form-control" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± ${i + 1}" id="option${i}">
                    `;
                    optionsContainer.appendChild(optionDiv);
                }
            }
        }
        
        function addOption() {
            const container = document.getElementById('optionsContainer');
            const count = container.children.length;
            
            const optionDiv = document.createElement('div');
            optionDiv.style.display = 'flex';
            optionDiv.style.alignItems = 'center';
            optionDiv.style.gap = '10px';
            optionDiv.style.marginBottom = '10px';
            optionDiv.innerHTML = `
                <input type="radio" name="correctOption" value="${count}">
                <input type="text" class="form-control" placeholder="Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯" id="option${count}">
            `;
            
            container.appendChild(optionDiv);
        }
        
        function addQuestionToExam() {
            const text = document.getElementById('questionText').value.trim();
            const type = document.getElementById('questionType').value;
            const score = parseInt(document.getElementById('questionScore').value);
            
            if (!text || !score) {
                alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ¯Ø±Ø¬ØªÙ‡');
                return;
            }
            
            const question = {
                text,
                type,
                score,
                createdAt: new Date().toISOString()
            };
            
            if (type === 'mcq') {
                const options = [];
                const optionInputs = document.querySelectorAll('#optionsContainer input[type="text"]');
                const correctIndex = parseInt(document.querySelector('input[name="correctOption"]:checked').value);
                
                optionInputs.forEach((input, index) => {
                    if (input.value.trim()) {
                        options.push({
                            text: input.value.trim(),
                            isCorrect: index === correctIndex
                        });
                    }
                });
                
                if (options.length < 2) {
                    alert('âŒ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }
                
                question.options = options;
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            examQuestions.push(question);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            const questionItem = document.createElement('div');
            questionItem.className = 'preview-question-item';
            questionItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${examQuestions.length}. ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ${type === 'mcq' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 'Ù…Ù‚Ø§Ù„ÙŠ'} - ${score} Ø¯Ø±Ø¬Ø©
                        </div>
                    </div>
                    <button onclick="removeQuestionFromExam(${examQuestions.length - 1})" 
                            style="background: none; border: none; color: #f72585; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('questionsList').appendChild(questionItem);
            
            // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('questionText').value = '';
            if (type === 'mcq') {
                document.querySelectorAll('#optionsContainer input[type="text"]').forEach(input => input.value = '');
            }
            
            // ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰
            document.getElementById('questionsPreview').scrollTop = document.getElementById('questionsPreview').scrollHeight;
            
            alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„. Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¢Ù†: ${examQuestions.length}`);
        }
        
        function removeQuestionFromExam(index) {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
                examQuestions.splice(index, 1);
                updateQuestionsPreview();
            }
        }
        
        function updateQuestionsPreview() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '';
            
            examQuestions.forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.className = 'preview-question-item';
                questionItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${index + 1}. ${question.text.substring(0, 50)}${question.text.length > 50 ? '...' : ''}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${question.type === 'mcq' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 'Ù…Ù‚Ø§Ù„ÙŠ'} - ${question.score} Ø¯Ø±Ø¬Ø©
                            </div>
                        </div>
                        <button onclick="removeQuestionFromExam(${index})" 
                                style="background: none; border: none; color: #f72585; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(questionItem);
            });
        }
        
        async function saveExamWithQuestions() {
            if (!currentCreatingExam) {
                alert('âŒ ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (examQuestions.length === 0) {
                alert('âŒ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const questionIds = [];
            for (const question of examQuestions) {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø³Ø¤Ø§Ù„
                question.examCode = currentCreatingExam.code;
                question.subject = currentCreatingExam.subject;
                question.year = currentCreatingExam.year;
                
                // Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„
                const questionId = await saveToFirebase('questions', question);
                question.id = questionId;
                questionIds.push(questionId);
                
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¹Ø§Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (!questions.some(q => q.id === questionId)) {
                    questions.push(question);
                }
            }
            
            localStorage.setItem('questions', JSON.stringify(questions));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            currentCreatingExam.questions = questionIds;
            currentCreatingExam.status = 'active';
            currentCreatingExam.questionCount = examQuestions.length;
            
            // Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            const examId = await saveToFirebase('exams', currentCreatingExam);
            currentCreatingExam.id = examId;
            
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
            exams.push(currentCreatingExam);
            localStorage.setItem('exams', JSON.stringify(exams));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            updateExamsTable();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            document.getElementById('questionBuilderContainer').style.display = 'none';
            document.getElementById('examName').value = '';
            document.getElementById('examSubject').value = '';
            document.getElementById('examCodeInput').value = '';
            document.getElementById('examDuration').value = '60';
            examQuestions = [];
            
            alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­\nØ§Ù„ÙƒÙˆØ¯: ${currentCreatingExam.code}\nØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${questionIds.length}`);
            
            currentCreatingExam = null;
        }
        
        function updateExamsTable() {
            const tbody = document.getElementById('examsTableBody');
            tbody.innerHTML = '';
            
            exams.forEach((exam, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${exam.name}</td>
                    <td>${exam.subject}</td>
                    <td><strong>${exam.code}</strong></td>
                    <td>${exam.questionCount || 0}</td>
                    <td>
                        <span style="background: ${exam.status === 'active' ? '#4cc9f0' : '#f72585'}; 
                              color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                            ${exam.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…ØºÙ„Ù‚'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="editExam('${exam.id}')">
                                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteExam('${exam.id}')">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function editExam(examId) {
            const exam = exams.find(e => e.id === examId);
            if (!exam) return;
            
            const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯:', exam.name);
            if (!newName) return;
            
            const newStatus = prompt('Ø§Ù„Ø­Ø§Ù„Ø© (active Ø£Ùˆ inactive):', exam.status);
            if (!newStatus || !['active', 'inactive'].includes(newStatus)) {
                alert('âŒ Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† active Ø£Ùˆ inactive');
                return;
            }
            
            exam.name = newName;
            exam.status = newStatus;
            
            saveToFirebase('exams', exam);
            localStorage.setItem('exams', JSON.stringify(exams));
            updateExamsTable();
            alert('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        async function deleteExam(examId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) return;
            
            // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
            await deleteFromFirebase('exams', examId);
            
            // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ
            exams = exams.filter(e => e.id !== examId);
            localStorage.setItem('exams', JSON.stringify(exams));
            
            updateExamsTable();
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        // ===== Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØµØ­ÙŠØ­ =====
        function updateResultsTable() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            results.forEach((result, index) => {
                const percentage = ((result.score / result.totalScore) * 100).toFixed(1);
                const needsCorrection = result.hasEssay && result.status === 'pending';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${result.studentName}</td>
                    <td>${result.examName}</td>
                    <td>${result.score}/${result.totalScore}</td>
                    <td style="color: ${percentage >= 50 ? '#4cc9f0' : '#f72585'}; font-weight: 600;">
                        ${percentage}%
                    </td>
                    <td>${new Date(result.submittedAt).toLocaleDateString('ar-SA')}</td>
                    <td>
                        ${needsCorrection ? 
                            '<span style="color: #f8961e; font-weight: 600;">ÙŠØ­ØªØ§Ø¬ ØªØµØ­ÙŠØ­</span>' : 
                            '<span style="color: #4cc9f0;">Ù…ÙƒØªÙ…Ù„</span>'
                        }
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${needsCorrection ? 
                                `<button class="btn-action btn-correct" onclick="startCorrection(${index})">
                                    <i class="fas fa-pen-alt"></i> ØªØµØ­ÙŠØ­
                                </button>` : ''
                            }
                            <button class="btn-action btn-view" onclick="viewResultDetails(${index})">
                                <i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©
                            </button>
                            <button class="btn-action btn-print" onclick="printResult(${index})">
                                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteResult(${index})">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function deleteResult(resultIndex) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ')) return;
            
            const result = results[resultIndex];
            
            // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
            await deleteFromFirebase('results', result.id);
            
            // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ
            results.splice(resultIndex, 1);
            localStorage.setItem('results', JSON.stringify(results));
            
            updateResultsTable();
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        function startCorrection(resultIndex) {
            currentCorrectionResult = results[resultIndex];
            currentEssayIndex = 0;
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©
            const essayAnswers = currentCorrectionResult.answers.filter(a => a.type === 'essay');
            if (essayAnswers.length === 0) {
                alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚Ø§Ù„ÙŠØ© ØªØ­ØªØ§Ø¬ Ù„Ù„ØªØµØ­ÙŠØ­');
                return;
            }
            
            // ØªÙ‡ÙŠØ¦Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØµØ­ÙŠØ­
            document.getElementById('correctionStudentName').textContent = currentCorrectionResult.studentName;
            updateCorrectionView();
            
            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØµØ­ÙŠØ­
            document.getElementById('correctionModal').classList.add('active');
        }
        
        function updateCorrectionView() {
            const essayAnswers = currentCorrectionResult.answers.filter(a => a.type === 'essay');
            if (essayAnswers.length === 0) return;
            
            const currentEssay = essayAnswers[currentEssayIndex];
            const questionNumber = currentCorrectionResult.answers.findIndex(a => a.questionId === currentEssay.questionId) + 1;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            document.getElementById('correctionQuestionNum').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${questionNumber}`;
            document.getElementById('currentEssayScore').textContent = currentEssay.score || '0';
            document.getElementById('maxEssayScore').textContent = currentEssay.maxScore;
            document.getElementById('newEssayScore').value = currentEssay.score || '0';
            document.getElementById('newEssayScore').max = currentEssay.maxScore;
            document.getElementById('correctionPosition').textContent = `${currentEssayIndex + 1} / ${essayAnswers.length}`;
            
            // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            const question = questions.find(q => q.id === currentEssay.questionId);
            document.getElementById('essayQuestionText').textContent = question?.text || currentEssay.questionText;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙƒØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ù…
            const answerDiv = document.getElementById('essayAnswerText');
            if (currentEssay.answer && currentEssay.answer.startsWith('data:')) {
                answerDiv.innerHTML = `<img src="${currentEssay.answer}" style="max-width: 100%; border: 1px solid #dee2e6; border-radius: 8px;">`;
            } else {
                answerDiv.textContent = currentEssay.answer || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            const listDiv = document.getElementById('essayQuestionsList');
            listDiv.innerHTML = '';
            
            essayAnswers.forEach((essay, index) => {
                const item = document.createElement('div');
                item.style.padding = '10px';
                item.style.margin = '5px 0';
                item.style.borderRadius = '5px';
                item.style.background = index === currentEssayIndex ? '#e3f2fd' : '#f8f9fa';
                item.style.cursor = 'pointer';
                item.onclick = () => {
                    currentEssayIndex = index;
                    updateCorrectionView();
                };
                item.innerHTML = `
                    <div style="font-weight: 600;">Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentCorrectionResult.answers.findIndex(a => a.questionId === essay.questionId) + 1}</div>
                    <div style="font-size: 0.9rem; color: #666;">Ø§Ù„Ø¯Ø±Ø¬Ø©: ${essay.score || 0}/${essay.maxScore}</div>
                `;
                listDiv.appendChild(item);
            });
            
            // ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØµØ­ÙŠØ­
            initCorrectionCanvas();
        }
        
        function initCorrectionCanvas() {
            const canvas = document.getElementById('correctionCanvas');
            if (!canvas) return;
            
            correctionCtx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©
            correctionCtx.fillStyle = 'white';
            correctionCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµÙˆØ±Ø©
            const essayAnswers = currentCorrectionResult.answers.filter(a => a.type === 'essay');
            const currentEssay = essayAnswers[currentEssayIndex];
            
            if (currentEssay.answer && currentEssay.answer.startsWith('data:')) {
                const img = new Image();
                img.onload = function() {
                    correctionCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = currentEssay.answer;
            }
        }
        
        function selectCorrectionTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.correction-canvas-container .tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function changeCorrectionColor(color) {
            // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
        }
        
        function changeCorrectionSize(size) {
            // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
        }
        
        function clearCorrectionCanvas() {
            const canvas = document.getElementById('correctionCanvas');
            correctionCtx.fillStyle = 'white';
            correctionCtx.fillRect(0, 0, canvas.width, canvas.height);
            initCorrectionCanvas(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        }
        
        function updateEssayScore() {
            const newScore = parseInt(document.getElementById('newEssayScore').value);
            if (isNaN(newScore)) return;
            
            const essayAnswers = currentCorrectionResult.answers.filter(a => a.type === 'essay');
            const currentEssay = essayAnswers[currentEssayIndex];
            
            if (newScore > currentEssay.maxScore) {
                alert(`âŒ Ø§Ù„Ø¯Ø±Ø¬Ø© ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² ${currentEssay.maxScore}`);
                return;
            }
            
            currentEssay.score = newScore;
            document.getElementById('currentEssayScore').textContent = newScore;
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©
            let totalScore = 0;
            currentCorrectionResult.answers.forEach(answer => {
                totalScore += answer.score || 0;
            });
            currentCorrectionResult.score = totalScore;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ØªÙ… ØªØµØ­ÙŠØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
            const allCorrected = currentCorrectionResult.answers
                .filter(a => a.type === 'essay')
                .every(a => a.score !== undefined && a.score !== null);
            
            if (allCorrected) {
                currentCorrectionResult.status = 'graded';
            }
            
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        function saveCorrection() {
            // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            const resultIndex = results.findIndex(r => r.id === currentCorrectionResult.id);
            if (resultIndex !== -1) {
                results[resultIndex] = currentCorrectionResult;
                localStorage.setItem('results', JSON.stringify(results));
                
                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                saveToFirebase('results', currentCorrectionResult);
                
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØµØ­ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }
        
        function previousEssay() {
            const essayAnswers = currentCorrectionResult.answers.filter(a => a.type === 'essay');
            if (currentEssayIndex > 0) {
                currentEssayIndex--;
                updateCorrectionView();
            }
        }
        
        function nextEssay() {
            const essayAnswers = currentCorrectionResult.answers.filter(a => a.type === 'essay');
            if (currentEssayIndex < essayAnswers.length - 1) {
                currentEssayIndex++;
                updateCorrectionView();
            }
        }
        
        function closeCorrection() {
            document.getElementById('correctionModal').classList.remove('active');
            updateResultsTable();
        }
        
        function viewResultDetails(resultIndex) {
            const result = results[resultIndex];
            
            let details = `
                <h2>ØªÙØ§ØµÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: ${result.studentName}</h2>
                <p><strong>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> ${result.examName}</p>
                <p><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> ${result.examCode}</p>
                <p><strong>Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong> ${result.score}/${result.totalScore}</p>
                <p><strong>Ø§Ù„Ù†Ø³Ø¨Ø©:</strong> ${((result.score / result.totalScore) * 100).toFixed(1)}%</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(result.submittedAt).toLocaleString('ar-SA')}</p>
                <hr>
                <h3>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h3>
            `;
            
            result.answers.forEach((answer, index) => {
                const question = questions.find(q => q.id === answer.questionId);
                details += `
                    <div style="border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 8px;">
                        <p><strong>Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</strong> ${answer.questionText}</p>
                        <p><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</strong> ${answer.answer || '(Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©)'}</p>
                        <p><strong>Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong> ${answer.score || 0}/${answer.maxScore}</p>
                    </div>
                `;
            });
            
            const detailsWindow = window.open('', '_blank');
            detailsWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© - ${result.studentName}</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; }
                        h2 { color: #4361ee; }
                        hr { margin: 20px 0; border: 1px solid #dee2e6; }
                    </style>
                </head>
                <body>${details}</body>
                </html>
            `);
            detailsWindow.document.close();
        }
        
        function printResult(resultIndex) {
            const result = results[resultIndex];
            const printWindow = window.open('', '_blank');
            
            let content = `
                <html dir="rtl">
                <head>
                    <title>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - ${result.studentName}</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 30px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .info { margin-bottom: 20px; }
                        .question { border: 1px solid #000; padding: 10px; margin: 10px 0; page-break-inside: avoid; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
                        <h2>${result.examName}</h2>
                    </div>
                    <div class="info">
                        <p><strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${result.studentName}</p>
                        <p><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ:</strong> ${result.studentCivilId}</p>
                        <p><strong>Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong> ${result.score}/${result.totalScore}</p>
                        <p><strong>Ø§Ù„Ù†Ø³Ø¨Ø©:</strong> ${((result.score / result.totalScore) * 100).toFixed(1)}%</p>
                        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(result.submittedAt).toLocaleString('ar-SA')}</p>
                    </div>
                    <h3>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h3>
            `;
            
            result.answers.forEach((answer, index) => {
                content += `
                    <div class="question">
                        <p><strong>Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</strong> ${answer.questionText}</p>
                        <p><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</strong> ${answer.answer || '(Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©)'}</p>
                        <p><strong>Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong> ${answer.score || 0}/${answer.maxScore}</p>
                    </div>
                `;
            });
            
            content += `
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(content);
            printWindow.document.close();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        setInterval(() => {
            if (document.getElementById('lastUpdate')) {
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ar-SA');
            }
        }, 60000);
    </script>
</body>
</html>

```html
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الاختبارات - لوحة المعلم</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(to right, #1a237e, #283593);
            color: white;
            padding: 25px 40px;
            border-bottom: 5px solid #4a6fa5;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 36px;
            color: #4fc3f7;
        }
        
        .logo h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }
        
        .header-info {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .info-item i {
            color: #4fc3f7;
        }
        
        .test-header-form {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .header-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .header-form-group {
            margin-bottom: 10px;
        }
        
        .header-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e3f2fd;
            font-weight: 600;
            font-size: 14px;
        }
        
        .header-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            font-size: 15px;
            color: #333;
        }
        
        .tabs-container {
            background: #fff;
            border-bottom: 2px solid #e1e5eb;
            overflow-x: auto;
            display: flex;
        }
        
        .tabs {
            display: flex;
            min-width: max-content;
            padding: 0 40px;
        }
        
        .tab {
            padding: 20px 35px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #555;
            position: relative;
            white-space: nowrap;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            color: #1a237e;
            background: #f8f9fa;
        }
        
        .tab.active {
            color: #1a237e;
            border-bottom-color: #1a237e;
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-top: 5px solid #4a6fa5;
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card i {
            font-size: 40px;
            color: #4a6fa5;
            margin-bottom: 20px;
        }
        
        .dashboard-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 24px;
        }
        
        .dashboard-card p {
            margin: 0;
            color: #666;
            font-size: 15px;
        }
        
        .create-test-form {
            background: white;
            border-radius: 12px;
            padding: 35px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #1a237e;
            margin-top: 0;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f0fe;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 15px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a6fa5;
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        .datetime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .question-type-container {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .question-type-btn {
            padding: 12px 25px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-type-btn:hover {
            border-color: #4a6fa5;
            color: #4a6fa5;
        }
        
        .question-type-btn.active {
            border-color: #4a6fa5;
            background: #e8f0fe;
            color: #4a6fa5;
        }
        
        .options-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
        }
        
        .option-item input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .correct-option {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .essay-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        
        .essay-container textarea {
            min-height: 150px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #4a6fa5, #3a5a85);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #3a5a85, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 90, 133, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(to right, #28a745, #218838);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(to right, #218838, #1e7e34);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #dc3545, #c82333);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(to right, #c82333, #bd2130);
            transform: translateY(-2px);
        }
        
        .btn-excel {
            background: linear-gradient(to right, #1d6f42, #165a34);
            color: white;
        }
        
        .btn-excel:hover {
            background: linear-gradient(to right, #165a34, #0d4526);
            transform: translateY(-2px);
        }
        
        .btn-publish {
            background: linear-gradient(to right, #9c27b0, #7b1fa2);
            color: white;
        }
        
        .btn-publish:hover {
            background: linear-gradient(to right, #7b1fa2, #6a1b9a);
            transform: translateY(-2px);
        }
        
        .questions-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #e1e5eb;
            border-radius: 10px;
            background: #f8f9fa;
            margin-top: 25px;
        }
        
        .question-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4a6fa5;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .question-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .question-type-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .badge-mcq {
            background: #e8f0fe;
            color: #4a6fa5;
        }
        
        .badge-essay {
            background: #f3e5f5;
            color: #9c27b0;
        }
        
        .publish-controls {
            background: #e8f0fe;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #4a6fa5;
        }
        
        .publish-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .test-card {
            background: white;
            border: 1px solid #e1e5eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .test-card.published {
            border-color: #28a745;
            background: linear-gradient(to bottom right, #ffffff, #f8fff9);
        }
        
        .test-card.published::before {
            content: 'منشور';
            position: absolute;
            top: 15px;
            left: 15px;
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .test-card h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 22px;
        }
        
        .test-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .test-meta p {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 3px dashed #4a6fa5;
            border-radius: 12px;
            padding: 60px 30px;
            text-align: center;
            background: #f8fafc;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #e8f0fe;
            border-color: #3a5a85;
        }
        
        .students-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            border: 1px solid #e1e5eb;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .students-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .students-table th {
            background: #2c3e50;
            color: white;
            padding: 18px 15px;
            text-align: right;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .students-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #e1e5eb;
            text-align: right;
        }
        
        .alert {
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: none;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
            
            .tabs {
                padding: 0 20px;
            }
            
            .tab-content {
                padding: 30px 20px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }
            
            .header-top {
                flex-direction: column;
                text-align: center;
            }
            
            .header-info {
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
                width: 100%;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tests-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="logo">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h1>نظام إدارة الاختبارات الإلكترونية</h1>
                </div>
                <div class="header-info">
                    <div class="info-item">
                        <i class="fas fa-user-tie"></i>
                        <span>لوحة تحكم المعلم</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="currentDate"></span>
                    </div>
                </div>
            </div>
            
            <div class="test-header-form">
                <div class="header-form-grid">
                    <div class="header-form-group">
                        <label><i class="fas fa-flag"></i> الدولة</label>
                        <input type="text" id="country" placeholder="المملكة العربية السعودية">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-building"></i> الإدارة</label>
                        <input type="text" id="administration" placeholder="إدارة التعليم">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-school"></i> المدرسة</label>
                        <input type="text" id="school" placeholder="اسم المدرسة">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-book"></i> المادة</label>
                        <input type="text" id="subject" placeholder="اسم المادة">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</button>
                <button class="tab" onclick="switchTab('createTest')"><i class="fas fa-plus-circle"></i> إنشاء اختبار</button>
                <button class="tab" onclick="switchTab('manageStudents')"><i class="fas fa-users"></i> إدارة الطلاب</button>
                <button class="tab" onclick="switchTab('viewTests')"><i class="fas fa-clipboard-list"></i> الاختبارات</button>
                <button class="tab" onclick="switchTab('results')"><i class="fas fa-chart-bar"></i> النتائج</button>
            </div>
        </div>
        
        <!-- لوحة التحكم -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <i class="fas fa-clipboard-list"></i>
                    <h3 id="totalTests">0</h3>
                    <p>إختبار منشور</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-users"></i>
                    <h3 id="totalStudents">0</h3>
                    <p>طالب مسجل</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-question-circle"></i>
                    <h3 id="totalQuestions">0</h3>
                    <p>سؤال مخزن</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-check-circle"></i>
                    <h3 id="completedTests">0</h3>
                    <p>إختبار مكتمل</p>
                </div>
            </div>
        </div>
        
        <!-- إنشاء اختبار -->
        <div id="createTest" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> إنشاء اختبار جديد</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="testTitle"><i class="fas fa-heading"></i> عنوان الاختبار:</label>
                        <input type="text" id="testTitle" placeholder="أدخل عنوان واضح للاختبار">
                    </div>
                    
                    <div class="form-group">
                        <label for="testSubject"><i class="fas fa-book"></i> المادة الدراسية:</label>
                        <input type="text" id="testSubject" placeholder="مثل: الرياضيات، العلوم، اللغة العربية">
                    </div>
                    
                    <div class="form-group">
                        <label for="testDuration"><i class="fas fa-clock"></i> زمن الاختبار (دقائق):</label>
                        <input type="number" id="testDuration" min="1" value="45">
                    </div>
                    
                    <div class="form-group">
                        <label for="passingScore"><i class="fas fa-graduation-cap"></i> درجة النجاح (%):</label>
                        <input type="number" id="passingScore" min="0" max="100" value="60">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="testDescription"><i class="fas fa-align-left"></i> وصف الاختبار:</label>
                    <textarea id="testDescription" placeholder="صف محتوى الاختبار والأهداف التعليمية" rows="3"></textarea>
                </div>
                
                <h3 class="section-title"><i class="fas fa-calendar-alt"></i> توقيت الاختبار</h3>
                <div class="datetime-grid">
                    <div class="form-group">
                        <label for="startDate"><i class="fas fa-calendar-plus"></i> تاريخ البدء:</label>
                        <input type="datetime-local" id="startTime">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate"><i class="fas fa-calendar-minus"></i> تاريخ الانتهاء:</label>
                        <input type="datetime-local" id="endTime">
                    </div>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-question-circle"></i> إضافة سؤال جديد</h2>
                
                <div class="form-group">
                    <label><i class="fas fa-tasks"></i> نوع السؤال:</label>
                    <div class="question-type-container">
                        <button class="question-type-btn active" onclick="setQuestionType('mcq')">
                            <i class="fas fa-list-ol"></i> اختيار من متعدد
                        </button>
                        <button class="question-type-btn" onclick="setQuestionType('essay')">
                            <i class="fas fa-edit"></i> مقالي (رسم وكتابة)
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="questionText"><i class="fas fa-pencil-alt"></i> نص السؤال:</label>
                    <textarea id="questionText" placeholder="اكتب نص السؤال هنا..." rows="3"></textarea>
                </div>
                
                <!-- قسم اختيار من متعدد -->
                <div id="mcqOptions" class="options-container">
                    <label style="display: block; margin-bottom: 15px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-list-ol"></i> خيارات الإجابة:
                    </label>
                    <div id="optionsList">
                        <div class="option-item">
                            <input type="radio" name="correctOption" value="0" class="correct-option" checked>
                            <input type="text" class="option-input" placeholder="الخيار الأول">
                            <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="correctOption" value="1" class="correct-option">
                            <input type="text" class="option-input" placeholder="الخيار الثاني">
                            <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button onclick="addOption()" class="btn btn-secondary" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> إضافة خيار جديد
                    </button>
                </div>
                
                <!-- قسم السؤال المقالي -->
                <div id="essayOptions" class="essay-container" style="display: none;">
                    <label style="display: block; margin-bottom: 15px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-edit"></i> تعليمات السؤال المقالي:
                    </label>
                    <textarea id="essayInstructions" placeholder="أدخل تعليمات الإجابة أو تركها فارغة..." rows="2"></textarea>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="questionPoints"><i class="fas fa-star"></i> درجة السؤال:</label>
                        <input type="number" id="questionPoints" min="1" value="5">
                    </div>
                </div>
                
                <button onclick="addQuestion()" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> إضافة السؤال إلى الاختبار
                </button>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-list-check"></i> الأسئلة المضافة (<span id="questionsCount">0</span>)</h2>
                
                <div id="questionsList" class="questions-list">
                    <p style="text-align: center; color: #666; padding: 40px;">لم تتم إضافة أي أسئلة بعد</p>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button onclick="saveTest()" class="btn btn-success" id="saveTestBtn" disabled>
                        <i class="fas fa-save"></i> حفظ الاختبار
                    </button>
                    <button onclick="clearTest()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> مسح الكل
                    </button>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-share-square"></i> نشر الاختبار</h2>
                
                <div id="publishSection" style="display: none;">
                    <div class="publish-info">
                        <div>
                            <p style="margin: 0; color: #2c3e50;"><strong>عنوان الاختبار:</strong> <span id="publishTitle"></span></p>
                        </div>
                        <div>
                            <p style="margin: 0; color: #2c3e50;"><strong>وقت البدء:</strong> <span id="publishStart"></span></p>
                        </div>
                        <div>
                            <p style="margin: 0; color: #2c3e50;"><strong>وقت الانتهاء:</strong> <span id="publishEnd"></span></p>
                        </div>
                    </div>
                    
                    <button onclick="publishTest()" class="btn btn-publish" id="publishTestBtn">
                        <i class="fas fa-paper-plane"></i> نشر الاختبار للطلاب
                    </button>
                </div>
                
                <div id="noTestSaved" style="text-align: center; padding: 20px;">
                    <i class="fas fa-clipboard" style="font-size: 50px; color: #ddd; margin-bottom: 15px;"></i>
                    <p style="color: #666;">يجب حفظ الاختبار أولاً قبل نشره</p>
                </div>
            </div>
        </div>
        
        <!-- إدارة الطلاب -->
        <div id="manageStudents" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-users"></i> إدارة الطلاب</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
                    <div style="background: #f3e5f5; padding: 25px; border-radius: 10px;">
                        <h3 style="margin-top: 0; color: #2c3e50;"><i class="fas fa-plus-circle"></i> إضافة طالب جديد</h3>
                        <div class="form-group">
                            <label for="studentSsn"><i class="fas fa-id-card"></i> السجل المدني:</label>
                            <input type="text" id="studentSsn" placeholder="10 أرقام على الأقل" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="studentName"><i class="fas fa-user"></i> الاسم الكامل:</label>
                            <input type="text" id="studentName" placeholder="الاسم ثلاثي">
                        </div>
                        <button onclick="addStudent()" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> إضافة طالب
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-file-import"></i> استيراد الطلاب من Excel</h2>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-excel"></i>
                    <h3>انقر لرفع ملف Excel</h3>
                    <p>اسحب وأسقط ملف Excel هنا أو انقر للاختيار</p>
                    <p style="color: #4a6fa5; font-weight: 600;">
                        <i class="fas fa-download"></i> 
                        <a href="#" onclick="downloadTemplate()" style="color: #2c3e50; text-decoration: none;">تحميل ملف نموذج</a>
                    </p>
                </div>
                
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
                
                <div id="importAlert" class="alert"></div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button onclick="exportToExcel()" class="btn btn-excel">
                        <i class="fas fa-file-export"></i> تصدير إلى Excel
                    </button>
                    <button onclick="clearAllStudents()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> حذف جميع الطلاب
                    </button>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-list"></i> قائمة الطلاب (<span id="studentsCount">0</span>)</h2>
                
                <div id="studentsTableContainer">
                    <p style="text-align: center; color: #666; padding: 40px;">لا توجد طلاب مسجلين بعد</p>
                </div>
            </div>
        </div>
        
        <!-- عرض الاختبارات -->
        <div id="viewTests" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> الاختبارات</h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button onclick="filterTests('all')" class="btn btn-secondary">
                        <i class="fas fa-list"></i> الكل
                    </button>
                    <button onclick="filterTests('published')" class="btn btn-success">
                        <i class="fas fa-check-circle"></i> المنشورة
                    </button>
                    <button onclick="filterTests('draft')" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> المسودة
                    </button>
                    <button onclick="filterTests('active')" class="btn btn-primary">
                        <i class="fas fa-play-circle"></i> النشطة الآن
                    </button>
                </div>
                
                <div id="testsList" class="tests-grid">
                    <!-- سيتم عرض الاختبارات هنا -->
                </div>
            </div>
        </div>
        
        <!-- النتائج -->
        <div id="results" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> نتائج الاختبارات</h2>
                
                <div id="resultsContainer">
                    <p style="text-align: center; color: #666; padding: 60px;">لا توجد نتائج متاحة بعد</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // متغيرات التطبيق
        let currentTest = {
            id: '',
            title: '',
            subject: '',
            description: '',
            duration: 45,
            passingScore: 60,
            startTime: '',
            endTime: '',
            questions: [],
            createdAt: '',
            isPublished: false,
            publishedAt: ''
        };
        
        let studentsList = [];
        let testsList = [];
        let resultsList = [];
        let currentQuestionType = 'mcq';
        let savedTestId = null; // إضافة متغير لتتبع الاختبار المحفوظ
        
        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تحديث التاريخ الحالي
            updateCurrentDate();
            
            // تعيين تواريخ افتراضية
            setDefaultDates();
            
            // تحميل البيانات
            loadAllData();
            
            // تحديث لوحة التحكم
            updateDashboard();
            
            // تحميل بيانات الرأس المحفوظة
            loadHeaderData();
        });
        
        // تحديث التاريخ الحالي
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('ar-SA', options);
        }
        
        // تعيين التواريخ الافتراضية
        function setDefaultDates() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // تنسيق التاريخ لـ input type="datetime-local"
            const formatDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            document.getElementById('startTime').value = formatDateTime(now);
            document.getElementById('endTime').value = formatDateTime(tomorrow);
        }
        
        // تحميل بيانات الرأس
        function loadHeaderData() {
            const savedCountry = localStorage.getItem('teacher_country');
            const savedAdmin = localStorage.getItem('teacher_administration');
            const savedSchool = localStorage.getItem('teacher_school');
            const savedSubject = localStorage.getItem('teacher_subject');
            
            if (savedCountry) document.getElementById('country').value = savedCountry;
            if (savedAdmin) document.getElementById('administration').value = savedAdmin;
            if (savedSchool) document.getElementById('school').value = savedSchool;
            if (savedSubject) document.getElementById('subject').value = savedSubject;
        }
        
        // حفظ بيانات الرأس
        function saveHeaderData() {
            const country = document.getElementById('country').value;
            const administration = document.getElementById('administration').value;
            const school = document.getElementById('school').value;
            const subject = document.getElementById('subject').value;
            
            localStorage.setItem('teacher_country', country);
            localStorage.setItem('teacher_administration', administration);
            localStorage.setItem('teacher_school', school);
            localStorage.setItem('teacher_subject', subject);
            
            showAlert('تم حفظ بيانات الرأس بنجاح', 'success');
        }
        
        // تحميل جميع البيانات
        function loadAllData() {
            try {
                studentsList = JSON.parse(localStorage.getItem('teacher_students')) || [];
                testsList = JSON.parse(localStorage.getItem('teacher_tests')) || [];
                resultsList = JSON.parse(localStorage.getItem('teacher_results')) || [];
                
                updateStudentsTable();
                updateTestsList();
                updateResultsList();
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showAlert('حدث خطأ في تحميل البيانات', 'error');
            }
        }
        
        // تحديث لوحة التحكم
        function updateDashboard() {
            try {
                document.getElementById('totalTests').textContent = 
                    testsList.filter(t => t.isPublished).length;
                document.getElementById('totalStudents').textContent = studentsList.length;
                
                let totalQuestions = 0;
                testsList.forEach(test => {
                    totalQuestions += test.questions.length;
                });
                document.getElementById('totalQuestions').textContent = totalQuestions;
                
                document.getElementById('completedTests').textContent = resultsList.length;
            } catch (error) {
                console.error('خطأ في تحديث لوحة التحكم:', error);
            }
        }
        
        // التبديل بين التبويبات
        function switchTab(tabName) {
            try {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');
                
                if (tabName === 'viewTests') {
                    updateTestsList();
                } else if (tabName === 'results') {
                    updateResultsList();
                }
            } catch (error) {
                console.error('خطأ في تبديل التبويبات:', error);
            }
        }
        
        // تعيين نوع السؤال
        function setQuestionType(type) {
            currentQuestionType = type;
            
            document.querySelectorAll('.question-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (type === 'mcq') {
                document.getElementById('mcqOptions').style.display = 'block';
                document.getElementById('essayOptions').style.display = 'none';
            } else {
                document.getElementById('mcqOptions').style.display = 'none';
                document.getElementById('essayOptions').style.display = 'block';
            }
        }
        
        // إضافة خيار جديد
        function addOption() {
            const optionsList = document.getElementById('optionsList');
            const optionCount = optionsList.children.length;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'option-item';
            optionItem.innerHTML = `
                <input type="radio" name="correctOption" value="${optionCount}" class="correct-option">
                <input type="text" class="option-input" placeholder="الخيار ${optionCount + 1}">
                <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            optionsList.appendChild(optionItem);
        }
        
        // حذف خيار
        function removeOption(button) {
            const optionsList = document.getElementById('optionsList');
            if (optionsList.children.length > 2) {
                button.closest('.option-item').remove();
            } else {
                showAlert('يجب أن يحتوي السؤال على خيارين على الأقل', 'error');
            }
        }
        
        // إضافة سؤال
        function addQuestion() {
            try {
                const questionText = document.getElementById('questionText').value.trim();
                const questionPoints = parseInt(document.getElementById('questionPoints').value) || 1;
                
                if (!questionText) {
                    showAlert('يرجى إدخال نص السؤال', 'error');
                    return;
                }
                
                let question;
                
                if (currentQuestionType === 'mcq') {
                    // جمع الخيارات
                    const options = [];
                    const optionInputs = document.querySelectorAll('.option-input');
                    optionInputs.forEach(input => {
                        if (input.value.trim() !== '') {
                            options.push(input.value.trim());
                        }
                    });
                    
                    if (options.length < 2) {
                        showAlert('يجب إدخال خيارين على الأقل', 'error');
                        return;
                    }
                    
                    // الحصول على الإجابة الصحيحة
                    const correctAnswer = parseInt(document.querySelector('input[name="correctOption"]:checked').value);
                    
                    question = {
                        id: Date.now(),
                        type: 'mcq',
                        text: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        points: questionPoints
                    };
                    
                } else {
                    const essayInstructions = document.getElementById('essayInstructions').value.trim();
                    
                    question = {
                        id: Date.now(),
                        type: 'essay',
                        text: questionText,
                        instructions: essayInstructions,
                        points: questionPoints
                    };
                }
                
                // إضافة السؤال
                currentTest.questions.push(question);
                
                // تحديث العرض
                updateQuestionsList();
                
                // تفعيل زر الحفظ
                document.getElementById('saveTestBtn').disabled = false;
                
                // مسح الحقول
                document.getElementById('questionText').value = '';
                document.getElementById('essayInstructions').value = '';
                
                if (currentQuestionType === 'mcq') {
                    document.querySelectorAll('.option-input').forEach(input => {
                        input.value = '';
                    });
                    document.querySelectorAll('input[name="correctOption"]')[0].checked = true;
                }
                
                showAlert('تمت إضافة السؤال بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في إضافة السؤال:', error);
                showAlert('حدث خطأ في إضافة السؤال', 'error');
            }
        }
        
        // تحديث قائمة الأسئلة
        function updateQuestionsList() {
            try {
                const container = document.getElementById('questionsList');
                const countElement = document.getElementById('questionsCount');
                
                if (currentTest.questions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">لم تتم إضافة أي أسئلة بعد</p>';
                    countElement.textContent = '0';
                    return;
                }
                
                let html = '';
                currentTest.questions.forEach((question, index) => {
                    html += `
                        <div class="question-card">
                            <span class="question-type-badge ${question.type === 'mcq' ? 'badge-mcq' : 'badge-essay'}">
                                ${question.type === 'mcq' ? 'اختيار من متعدد' : 'مقالي'}
                            </span>
                            <h4>سؤال ${index + 1}: ${question.text}</h4>
                            <p><strong>الدرجة:</strong> ${question.points}</p>
                    `;
                    
                    if (question.type === 'mcq') {
                        html += '<div style="margin-top: 15px;">';
                        question.options.forEach((option, optIndex) => {
                            const isCorrect = optIndex === question.correctAnswer;
                            html += `
                                <div style="padding: 10px; margin-bottom: 8px; background: ${isCorrect ? '#d4edda' : '#f8f9fa'}; 
                                     border-radius: 5px; border-right: 3px solid ${isCorrect ? '#28a745' : '#ddd'};">
                                    ${option} ${isCorrect ? ' ✓' : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html += `<p><strong>التعليمات:</strong> ${question.instructions || 'بدون تعليمات'}</p>`;
                    }
                    
                    html += `
                            <button onclick="removeQuestion(${index})" class="btn btn-danger" style="padding: 8px 15px; font-size: 14px; margin-top: 15px;">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                countElement.textContent = currentTest.questions.length;
            } catch (error) {
                console.error('خطأ في تحديث قائمة الأسئلة:', error);
                showAlert('حدث خطأ في تحديث قائمة الأسئلة', 'error');
            }
        }
        
        // حذف سؤال
        function removeQuestion(index) {
            try {
                if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
                    currentTest.questions.splice(index, 1);
                    updateQuestionsList();
                    
                    if (currentTest.questions.length === 0) {
                        document.getElementById('saveTestBtn').disabled = true;
                    }
                }
            } catch (error) {
                console.error('خطأ في حذف السؤال:', error);
                showAlert('حدث خطأ في حذف السؤال', 'error');
            }
        }
        
        // حفظ الاختبار
        function saveTest() {
            try {
                // حفظ بيانات الرأس أولاً
                saveHeaderData();
                
                // جمع بيانات الاختبار
                currentTest.title = document.getElementById('testTitle').value.trim();
                currentTest.subject = document.getElementById('testSubject').value.trim();
                currentTest.description = document.getElementById('testDescription').value.trim();
                currentTest.duration = parseInt(document.getElementById('testDuration').value) || 45;
                currentTest.passingScore = parseInt(document.getElementById('passingScore').value) || 60;
                
                // جمع توقيت الاختبار
                currentTest.startTime = document.getElementById('startTime').value;
                currentTest.endTime = document.getElementById('endTime').value;
                
                // التحقق من البيانات
                if (!currentTest.title || !currentTest.subject || currentTest.questions.length === 0) {
                    showAlert('يرجى إدخال عنوان الاختبار والمادة وإضافة أسئلة على الأقل', 'error');
                    return;
                }
                
                if (!currentTest.startTime || !currentTest.endTime) {
                    showAlert('يرجى تحديد توقيت بدء وانتهاء الاختبار', 'error');
                    return;
                }
                
                // التحقق من صحة التوقيت
                const start = new Date(currentTest.startTime);
                const end = new Date(currentTest.endTime);
                
                if (start >= end) {
                    showAlert('وقت الانتهاء يجب أن يكون بعد وقت البدء', 'error');
                    return;
                }
                
                // إنشاء معرف جديد إذا كان الاختبار جديداً
                if (!currentTest.id) {
                    currentTest.id = 'TEST-' + Date.now();
                    currentTest.createdAt = new Date().toISOString();
                }
                
                // تحديث وقت التعديل
                currentTest.updatedAt = new Date().toISOString();
                currentTest.isPublished = false;
                
                // حفظ في localStorage
                // التحقق مما إذا كان الاختبار موجوداً مسبقاً
                const existingTestIndex = testsList.findIndex(t => t.id === currentTest.id);
                
                if (existingTestIndex !== -1) {
                    // تحديث الاختبار الموجود
                    testsList[existingTestIndex] = JSON.parse(JSON.stringify(currentTest));
                } else {
                    // إضافة اختبار جديد
                    testsList.push(JSON.parse(JSON.stringify(currentTest)));
                }
                
                localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                
                // حفظ معرف الاختبار
                savedTestId = currentTest.id;
                
                // عرض معلومات النشر
                document.getElementById('publishTitle').textContent = currentTest.title;
                document.getElementById('publishStart').textContent = 
                    new Date(currentTest.startTime).toLocaleString('ar-SA');
                document.getElementById('publishEnd').textContent = 
                    new Date(currentTest.endTime).toLocaleString('ar-SA');
                
                document.getElementById('publishSection').style.display = 'block';
                document.getElementById('noTestSaved').style.display = 'none';
                
                // تحديث زر الحفظ
                document.getElementById('saveTestBtn').innerHTML = '<i class="fas fa-sync-alt"></i> تحديث الاختبار';
                
                showAlert('تم حفظ الاختبار بنجاح! يمكنك الآن نشره للطلاب', 'success');
                
                // تحديث قائمة الاختبارات
                updateTestsList();
                
                // تحديث لوحة التحكم
                updateDashboard();
                
            } catch (error) {
                console.error('خطأ في حفظ الاختبار:', error);
                showAlert('حدث خطأ في حفظ الاختبار', 'error');
            }
        }
        
        // مسح كل الأسئلة
        function clearTest() {
            try {
                if (confirm('هل أنت متأكد من حذف جميع الأسئلة؟')) {
                    currentTest.questions = [];
                    updateQuestionsList();
                    document.getElementById('saveTestBtn').disabled = true;
                }
            } catch (error) {
                console.error('خطأ في مسح الأسئلة:', error);
                showAlert('حدث خطأ في مسح الأسئلة', 'error');
            }
        }
        
        // نشر الاختبار
        function publishTest() {
            try {
                if (!currentTest.id && !savedTestId) {
                    showAlert('يجب حفظ الاختبار أولاً قبل نشره', 'error');
                    return;
                }
                
                // استخدام savedTestId إذا كان currentTest.id غير موجود
                const testId = currentTest.id || savedTestId;
                
                // العثور على الاختبار في القائمة وتحديثه
                const testIndex = testsList.findIndex(t => t.id === testId);
                if (testIndex !== -1) {
                    testsList[testIndex].isPublished = true;
                    testsList[testIndex].publishedAt = new Date().toISOString();
                    localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                    
                    // تحديث currentTest أيضاً
                    if (currentTest.id === testId) {
                        currentTest.isPublished = true;
                        currentTest.publishedAt = testsList[testIndex].publishedAt;
                    }
                    
                    showAlert('تم نشر الاختبار بنجاح! يمكن للطلاب الآن الوصول إليه', 'success');
                    
                    // تحديث قائمة الاختبارات
                    updateTestsList();
                    updateDashboard();
                    
                    // تحديث زر النشر
                    const publishBtn = document.getElementById('publishTestBtn');
                    if (publishBtn) {
                        publishBtn.innerHTML = '<i class="fas fa-check"></i> تم النشر';
                        publishBtn.disabled = true;
                    }
                } else {
                    showAlert('لم يتم العثور على الاختبار المحفوظ. يرجى حفظه مرة أخرى', 'error');
                }
            } catch (error) {
                console.error('خطأ في نشر الاختبار:', error);
                showAlert('حدث خطأ في نشر الاختبار', 'error');
            }
        }
        
        // إعادة تعيين نموذج الاختبار
        function resetTestForm() {
            document.getElementById('testTitle').value = '';
            document.getElementById('testSubject').value = '';
            document.getElementById('testDescription').value = '';
            document.getElementById('testDuration').value = '45';
            document.getElementById('passingScore').value = '60';
            document.getElementById('questionText').value = '';
            document.getElementById('questionPoints').value = '5';
            document.getElementById('essayInstructions').value = '';
            
            // إعادة تعيين الخيارات
            const container = document.getElementById('optionsList');
            container.innerHTML = `
                <div class="option-item">
                    <input type="radio" name="correctOption" value="0" class="correct-option" checked>
                    <input type="text" class="option-input" placeholder="الخيار الأول">
                    <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="option-item">
                    <input type="radio" name="correctOption" value="1" class="correct-option">
                    <input type="text" class="option-input" placeholder="الخيار الثاني">
                    <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // إعادة تعيين currentTest مع الاحتفاظ بالمعرف إذا كان محفوظاً
            if (currentTest.id) {
                currentTest = {
                    id: currentTest.id,
                    title: '',
                    subject: '',
                    description: '',
                    duration: 45,
                    passingScore: 60,
                    startTime: '',
                    endTime: '',
                    questions: [],
                    createdAt: currentTest.createdAt,
                    isPublished: false,
                    publishedAt: ''
                };
            } else {
                currentTest = {
                    id: '',
                    title: '',
                    subject: '',
                    description: '',
                    duration: 45,
                    passingScore: 60,
                    startTime: '',
                    endTime: '',
                    questions: [],
                    createdAt: '',
                    isPublished: false,
                    publishedAt: ''
                };
            }
            
            updateQuestionsList();
            document.getElementById('saveTestBtn').disabled = true;
            document.getElementById('saveTestBtn').innerHTML = '<i class="fas fa-save"></i> حفظ الاختبار';
            
            // إعادة تعيين زر النشر
            const publishBtn = document.getElementById('publishTestBtn');
            if (publishBtn) {
                publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> نشر الاختبار للطلاب';
                publishBtn.disabled = false;
            }
            
            // إخفاء قسم النشر
            document.getElementById('publishSection').style.display = 'none';
            document.getElementById('noTestSaved').style.display = 'block';
        }
        
        // إضافة طالب يدوياً
        function addStudent() {
            try {
                const ssn = document.getElementById('studentSsn').value.trim();
                const name = document.getElementById('studentName').value.trim();
                
                if (!ssn || !name) {
                    showAlert('يرجى إدخال السجل المدني والاسم', 'error');
                    return;
                }
                
                if (ssn.length < 10) {
                    showAlert('رقم السجل المدني يجب أن يكون 10 أرقام على الأقل', 'error');
                    return;
                }
                
                // التحقق من عدم تكرار السجل المدني
                if (studentsList.some(student => student.ssn === ssn)) {
                    showAlert('رقم السجل المدني مسجل مسبقاً', 'error');
                    return;
                }
                
                const student = {
                    id: 'STU-' + Date.now(),
                    ssn: ssn,
                    name: name,
                    registeredAt: new Date().toLocaleString('ar-SA')
                };
                
                studentsList.push(student);
                localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                
                updateStudentsTable();
                
                // مسح الحقول
                document.getElementById('studentSsn').value = '';
                document.getElementById('studentName').value = '';
                
                showAlert('تمت إضافة الطالب بنجاح', 'success');
                updateDashboard();
            } catch (error) {
                console.error('خطأ في إضافة الطالب:', error);
                showAlert('حدث خطأ في إضافة الطالب', 'error');
            }
        }
        
        // تحديث جدول الطلاب
        function updateStudentsTable() {
            try {
                const container = document.getElementById('studentsTableContainer');
                const countElement = document.getElementById('studentsCount');
                
                if (studentsList.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">لا توجد طلاب مسجلين بعد</p>';
                    countElement.textContent = '0';
                    return;
                }
                
                let html = `
                    <div class="students-table-container">
                        <table class="students-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>رقم السجل المدني</th>
                                    <th>اسم الطالب</th>
                                    <th>تاريخ التسجيل</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                studentsList.forEach((student, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${student.ssn}</strong></td>
                            <td>${student.name}</td>
                            <td>${student.registeredAt}</td>
                            <td>
                                <button onclick="editStudent(${index})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteStudent(${index})" class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                countElement.textContent = studentsList.length;
            } catch (error) {
                console.error('خطأ في تحديث جدول الطلاب:', error);
                showAlert('حدث خطأ في تحديث جدول الطلاب', 'error');
            }
        }
        
        // معالجة استيراد Excel
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showAlert('الملف لا يحتوي على بيانات', 'error');
                        return;
                    }
                    
                    const importedStudents = [];
                    const duplicates = [];
                    
                    jsonData.forEach(row => {
                        const ssn = row['السجل المدني'] || row['ssn'] || row['رقم'] || '';
                        const name = row['الاسم'] || row['name'] || '';
                        
                        if (ssn && name) {
                            const ssnStr = ssn.toString().trim();
                            const nameStr = name.toString().trim();
                            
                            // التحقق من التكرار
                            const isDuplicate = studentsList.some(s => s.ssn === ssnStr);
                            if (!isDuplicate) {
                                importedStudents.push({
                                    id: 'STU-' + Date.now() + Math.random(),
                                    ssn: ssnStr,
                                    name: nameStr,
                                    registeredAt: new Date().toLocaleString('ar-SA')
                                });
                            } else {
                                duplicates.push(ssnStr);
                            }
                        }
                    });
                    
                    // إضافة الطلاب الجدد
                    studentsList = studentsList.concat(importedStudents);
                    localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                    
                    updateStudentsTable();
                    
                    let message = `تم استيراد ${importedStudents.length} طالب بنجاح`;
                    if (duplicates.length > 0) {
                        message += ` (تم تجاهل ${duplicates.length} طالب مكرر)`;
                    }
                    
                    showAlert(message, 'success');
                    updateDashboard();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('حدث خطأ في قراءة الملف. تأكد من صحة التنسيق', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // تحميل نموذج Excel
        function downloadTemplate() {
            const templateData = [
                { 'السجل المدني': '1011121314', 'الاسم': 'أحمد محمد علي' },
                { 'السجل المدني': '2011121315', 'الاسم': 'سارة خالد حسن' },
                { 'السجل المدني': '3011121316', 'الاسم': 'علي سعيد محمود' }
            ];
            
            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'الطلاب');
            
            XLSX.writeFile(workbook, 'نموذج_قائمة_الطلاب.xlsx');
        }
        
        // تصدير إلى Excel
        function exportToExcel() {
            try {
                if (studentsList.length === 0) {
                    showAlert('لا توجد بيانات للتصدير', 'error');
                    return;
                }
                
                const exportData = studentsList.map(s => ({
                    'السجل المدني': s.ssn,
                    'الاسم': s.name,
                    'تاريخ التسجيل': s.registeredAt
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'قائمة الطلاب');
                
                XLSX.writeFile(workbook, 'قائمة_الطلاب_المسجلين.xlsx');
            } catch (error) {
                console.error('خطأ في التصدير:', error);
                showAlert('حدث خطأ في التصدير', 'error');
            }
        }
        
        // تحرير طالب
        function editStudent(index) {
            try {
                const student = studentsList[index];
                
                const newName = prompt('تعديل اسم الطالب:', student.name);
                if (newName !== null) student.name = newName;
                
                const newSsn = prompt('تعديل السجل المدني:', student.ssn);
                if (newSsn !== null) student.ssn = newSsn;
                
                localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                updateStudentsTable();
            } catch (error) {
                console.error('خطأ في تحرير الطالب:', error);
                showAlert('حدث خطأ في تحرير الطالب', 'error');
            }
        }
        
        // حذف طالب
        function deleteStudent(index) {
            try {
                if (confirm('هل أنت متأكد من حذف هذا الطالب؟')) {
                    studentsList.splice(index, 1);
                    localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                    updateStudentsTable();
                    updateDashboard();
                }
            } catch (error) {
                console.error('خطأ في حذف الطالب:', error);
                showAlert('حدث خطأ في حذف الطالب', 'error');
            }
        }
        
        // حذف جميع الطلاب
        function clearAllStudents() {
            try {
                if (studentsList.length === 0) {
                    showAlert('لا توجد بيانات طلاب للحذف', 'error');
                    return;
                }
                
                if (confirm('هل أنت متأكد من حذف جميع الطلاب؟')) {
                    studentsList = [];
                    localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                    updateStudentsTable();
                    updateDashboard();
                    showAlert('تم حذف جميع الطلاب', 'success');
                }
            } catch (error) {
                console.error('خطأ في حذف الطلاب:', error);
                showAlert('حدث خطأ في حذف الطلاب', 'error');
            }
        }
        
        // تصفية الاختبارات
        function filterTests(type) {
            updateTestsList(type);
        }
        
        // تحديث قائمة الاختبارات
        function updateTestsList(filter = 'all') {
            try {
                const container = document.getElementById('testsList');
                
                let filteredTests = testsList;
                
                if (filter === 'published') {
                    filteredTests = testsList.filter(t => t.isPublished);
                } else if (filter === 'draft') {
                    filteredTests = testsList.filter(t => !t.isPublished);
                } else if (filter === 'active') {
                    const now = new Date();
                    filteredTests = testsList.filter(t => {
                        if (!t.isPublished) return false;
                        const start = new Date(t.startTime);
                        const end = new Date(t.endTime);
                        return now >= start && now <= end;
                    });
                }
                
                if (filteredTests.length === 0) {
                    let message = 'لا توجد اختبارات';
                    if (filter === 'published') message = 'لا توجد اختبارات منشورة';
                    else if (filter === 'draft') message = 'لا توجد اختبارات مسودة';
                    else if (filter === 'active') message = 'لا توجد اختبارات نشطة الآن';
                    
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; grid-column: 1/-1;">
                            <i class="fas fa-clipboard" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">${message}</h3>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                filteredTests.forEach((test, index) => {
                    const start = new Date(test.startTime);
                    const end = new Date(test.endTime);
                    const now = new Date();
                    const isActive = now >= start && now <= end && test.isPublished;
                    
                    const studentCount = resultsList.filter(r => r.testId === test.id).length;
                    
                    html += `
                        <div class="test-card ${test.isPublished ? 'published' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <h3>${test.title}</h3>
                                ${isActive ? 
                                    '<span style="background: #4a6fa5; color: white; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">نشط الآن</span>' : 
                                    ''
                                }
                            </div>
                            <p style="color: #666; margin-bottom: 15px;">${test.description || 'بدون وصف'}</p>
                            <div class="test-meta">
                                <p><i class="fas fa-book"></i> المادة: ${test.subject}</p>
                                <p><i class="fas fa-clock"></i> المدة: ${test.duration} دقيقة</p>
                                <p><i class="fas fa-graduation-cap"></i> النجاح: ${test.passingScore}%</p>
                                <p><i class="fas fa-question-circle"></i> الأسئلة: ${test.questions.length}</p>
                                <p><i class="fas fa-calendar-alt"></i> البدء: ${start.toLocaleString('ar-SA')}</p>
                                <p><i class="fas fa-calendar-times"></i> الانتهاء: ${end.toLocaleString('ar-SA')}</p>
                                <p><i class="fas fa-users"></i> أداء الاختبار: ${studentCount} طالب</p>
                                <p><i class="fas fa-calendar"></i> الإنشاء: ${new Date(test.createdAt).toLocaleString('ar-SA')}</p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button onclick="viewTestDetails(${index})" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> عرض
                                </button>
                                <button onclick="deleteTest(${index})" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                                ${!test.isPublished ? 
                                    `<button onclick="publishExistingTest(${index})" class="btn btn-publish">
                                        <i class="fas fa-paper-plane"></i> نشر
                                    </button>` : 
                                    ''
                                }
                                ${studentCount > 0 ? 
                                    `<button onclick="viewTestResults('${test.id}')" class="btn btn-success">
                                        <i class="fas fa-chart-bar"></i> النتائج
                                    </button>` : 
                                    ''
                                }
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحديث قائمة الاختبارات:', error);
                showAlert('حدث خطأ في تحديث قائمة الاختبارات', 'error');
            }
        }
        
        // نشر اختبار موجود
        function publishExistingTest(index) {
            try {
                if (testsList[index]) {
                    testsList[index].isPublished = true;
                    testsList[index].publishedAt = new Date().toISOString();
                    localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                    
                    showAlert('تم نشر الاختبار بنجاح!', 'success');
                    updateTestsList();
                    updateDashboard();
                }
            } catch (error) {
                console.error('خطأ في نشر الاختبار:', error);
                showAlert('حدث خطأ في نشر الاختبار', 'error');
            }
        }
        
        // عرض تفاصيل الاختبار
        function viewTestDetails(index) {
            try {
                const test = testsList[index];
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 1000; padding: 20px;
                    backdrop-filter: blur(5px);
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                            style="position: absolute; top: 15px; left: 15px; background: #dc3545; color: white; 
                            border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px;">
                            ×
                        </button>
                        
                        <h2 style="margin: 0 0 25px 0; color: #1a237e; text-align: center;">${test.title}</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #e8f0fe; padding: 20px; border-radius: 10px;">
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>المادة:</strong> ${test.subject}</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>زمن الاختبار:</strong> ${test.duration} دقيقة</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>درجة النجاح:</strong> ${test.passingScore}%</p>
                            </div>
                            <div style="background: #f3e5f5; padding: 20px; border-radius: 10px;">
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>تاريخ البدء:</strong> ${new Date(test.startTime).toLocaleString('ar-SA')}</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>تاريخ الانتهاء:</strong> ${new Date(test.endTime).toLocaleString('ar-SA')}</p>
                                <p style="margin: 0; color: #2c3e50;"><strong>الحالة:</strong> ${test.isPublished ? 'منشور' : 'مسودة'}</p>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
                            <h3 style="margin-top: 0; color: #2c3e50;">وصف الاختبار:</h3>
                            <p style="color: #666; line-height: 1.6;">${test.description || 'بدون وصف'}</p>
                        </div>
                        
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">الأسئلة (${test.questions.length})</h3>
                        ${test.questions.map((q, i) => `
                            <div style="background: white; padding: 25px; border-radius: 10px; margin: 15px 0; border: 1px solid #e1e5eb; border-right: 5px solid ${q.type === 'mcq' ? '#4a6fa5' : '#9c27b0'}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: #2c3e50;">سؤال ${i+1}: ${q.text}</h4>
                                    <span style="background: ${q.type === 'mcq' ? '#e8f0fe' : '#f3e5f5'}; 
                                          color: ${q.type === 'mcq' ? '#4a6fa5' : '#9c27b0'}; 
                                          padding: 5px 15px; border-radius: 20px; font-size: 13px;">
                                        ${q.type === 'mcq' ? 'اختيار من متعدد' : 'مقالي'}
                                    </span>
                                </div>
                                <p style="color: #666; margin-bottom: 15px;"><strong>الدرجة:</strong> ${q.points}</p>
                                
                                ${q.type === 'mcq' ? `
                                    <div style="margin-top: 15px;">
                                        ${q.options.map((opt, j) => `
                                            <div style="padding: 12px; margin-bottom: 10px; background: ${j === q.correctAnswer ? '#d4edda' : '#f8f9fa'}; 
                                                 border-radius: 8px; border-right: 3px solid ${j === q.correctAnswer ? '#28a745' : '#ddd'};">
                                                ${opt} ${j === q.correctAnswer ? ' ✓ الإجابة الصحيحة' : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p style="color: #666;"><strong>تعليمات الإجابة:</strong> ${q.instructions || 'بدون تعليمات'}</p>
                                `}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('خطأ في عرض تفاصيل الاختبار:', error);
                showAlert('حدث خطأ في عرض تفاصيل الاختبار', 'error');
            }
        }
        
        // حذف اختبار
        function deleteTest(index) {
            try {
                if (confirm('هل أنت متأكد من حذف هذا الاختبار؟')) {
                    testsList.splice(index, 1);
                    localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                    updateTestsList();
                    updateDashboard();
                    showAlert('تم حذف الاختبار', 'success');
                }
            } catch (error) {
                console.error('خطأ في حذف الاختبار:', error);
                showAlert('حدث خطأ في حذف الاختبار', 'error');
            }
        }
        
        // عرض نتائج اختبار
        function viewTestResults(testId) {
            try {
                const testResults = resultsList.filter(r => r.testId === testId);
                const test = testsList.find(t => t.id === testId);
                
                if (!testResults.length) {
                    showAlert('لا توجد نتائج لهذا الاختبار', 'error');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 1000; padding: 20px;
                    backdrop-filter: blur(5px);
                `;
                
                let resultsHtml = '';
                testResults.forEach((result, i) => {
                    resultsHtml += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${result.studentName}</td>
                            <td>${result.studentSsn}</td>
                            <td>${result.score}/${result.total}</td>
                            <td>${result.percentage}%</td>
                            <td>
                                <span style="background: ${result.passed ? '#d4edda' : '#f8d7da'}; 
                                      color: ${result.passed ? '#155724' : '#721c24'}; 
                                      padding: 5px 15px; border-radius: 20px; font-size: 13px;">
                                    ${result.passed ? 'ناجح' : 'راسب'}
                                </span>
                            </td>
                            <td>${new Date(result.completedAt).toLocaleString('ar-SA')}</td>
                        </tr>
                    `;
                });
                
                const avgPercentage = testResults.reduce((sum, r) => sum + r.percentage, 0) / testResults.length;
                const passRate = (testResults.filter(r => r.passed).length / testResults.length) * 100;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                            style="position: absolute; top: 15px; left: 15px; background: #dc3545; color: white; 
                            border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px;">
                            ×
                        </button>
                        
                        <h2 style="margin: 0 0 25px 0; color: #1a237e; text-align: center;">نتائج اختبار: ${test ? test.title : 'غير معروف'}</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #e8f0fe; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">عدد الطلاب</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #4a6fa5; margin: 0;">${testResults.length}</p>
                            </div>
                            <div style="background: #f3e5f5; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">متوسط النسبة</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #9c27b0; margin: 0;">${avgPercentage.toFixed(1)}%</p>
                            </div>
                            <div style="background: #e8f5e9; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">نسبة النجاح</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #28a745; margin: 0;">${passRate.toFixed(1)}%</p>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 15px; text-align: right;">#</th>
                                        <th style="padding: 15px; text-align: right;">اسم الطالب</th>
                                        <th style="padding: 15px; text-align: right;">السجل المدني</th>
                                        <th style="padding: 15px; text-align: right;">الدرجة</th>
                                        <th style="padding: 15px; text-align: right;">النسبة</th>
                                        <th style="padding: 15px; text-align: right;">الحالة</th>
                                        <th style="padding: 15px; text-align: right;">تاريخ الإكمال</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${resultsHtml}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                            <button onclick="exportResultsToExcel('${testId}')" class="btn btn-excel" style="padding: 12px 25px;">
                                <i class="fas fa-file-export"></i> تصدير إلى Excel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('خطأ في عرض النتائج:', error);
                showAlert('حدث خطأ في عرض النتائج', 'error');
            }
        }
        
        // تصدير النتائج إلى Excel
        function exportResultsToExcel(testId) {
            try {
                const testResults = resultsList.filter(r => r.testId === testId);
                const test = testsList.find(t => t.id === testId);
                
                if (!testResults.length) return;
                
                const exportData = testResults.map((r, i) => ({
                    'م': i + 1,
                    'اسم الطالب': r.studentName,
                    'السجل المدني': r.studentSsn,
                    'الدرجة': `${r.score}/${r.total}`,
                    'النسبة': `${r.percentage}%`,
                    'الحالة': r.passed ? 'ناجح' : 'راسب',
                    'تاريخ الإكمال': new Date(r.completedAt).toLocaleString('ar-SA')
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'النتائج');
                
                const testTitle = test ? test.title.replace(/[^\w\u0600-\u06FF]/g, '_') : 'نتائج';
                XLSX.writeFile(workbook, `${testTitle}_النتائج.xlsx`);
                
                showAlert('تم تصدير النتائج بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير النتائج:', error);
                showAlert('حدث خطأ في تصدير النتائج', 'error');
            }
        }
        
        // تحديث قائمة النتائج
        function updateResultsList() {
            try {
                const container = document.getElementById('resultsContainer');
                
                if (resultsList.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 60px;">لا توجد نتائج متاحة بعد</p>';
                    return;
                }
                
                // تجميع النتائج حسب الاختبار
                const resultsByTest = {};
                resultsList.forEach(result => {
                    if (!resultsByTest[result.testId]) {
                        resultsByTest[result.testId] = [];
                    }
                    resultsByTest[result.testId].push(result);
                });
                
                let html = '';
                Object.keys(resultsByTest).forEach(testId => {
                    const testResults = resultsByTest[testId];
                    const test = testsList.find(t => t.id === testId);
                    
                    if (!test) return;
                    
                    const avgPercentage = testResults.reduce((sum, r) => sum + r.percentage, 0) / testResults.length;
                    const passRate = (testResults.filter(r => r.passed).length / testResults.length) * 100;
                    
                    html += `
                        <div class="test-card published" style="margin-bottom: 30px;">
                            <h3>${test.title}</h3>
                            <p style="color: #666; margin-bottom: 15px;">${test.subject} - ${new Date(test.createdAt).toLocaleDateString('ar-SA')}</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: #e8f0fe; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">عدد الطلاب</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #4a6fa5;">${testResults.length}</p>
                                </div>
                                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">متوسط النسبة</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #9c27b0;">${avgPercentage.toFixed(1)}%</p>
                                </div>
                                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">نسبة النجاح</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #28a745;">${passRate.toFixed(1)}%</p>
                                </div>
                            </div>
                            
                            <button onclick="viewTestResults('${testId}')" class="btn btn-primary">
                                <i class="fas fa-eye"></i> عرض التفاصيل
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحديث قائمة النتائج:', error);
                showAlert('حدث خطأ في تحديث قائمة النتائج', 'error');
            }
        }
        
        // إظهار رسالة تنبيه
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('importAlert');
            if (!alertDiv) {
                // إنشاء div للتنبيهات إذا لم يكن موجوداً
                const newAlert = document.createElement('div');
                newAlert.id = 'importAlert';
                newAlert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
                newAlert.textContent = message;
                newAlert.style.display = 'block';
                
                // إضافة التنبيه في المكان المناسب
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab) {
                    currentTab.insertBefore(newAlert, currentTab.firstChild);
                } else {
                    document.body.appendChild(newAlert);
                }
            } else {
                alertDiv.textContent = message;
                alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
                alertDiv.style.display = 'block';
            }
            
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.style.display = 'none';
                }
            }, 5000);
        }
    </script>
</body>
</html>

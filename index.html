<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ø¹ Firebase</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(to right, #1a237e, #283593);
            color: white;
            padding: 25px 40px;
            border-bottom: 5px solid #4a6fa5;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 36px;
            color: #4fc3f7;
        }
        
        .logo h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }
        
        .header-info {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .info-item i {
            color: #4fc3f7;
        }
        
        .test-header-form {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .header-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .header-form-group {
            margin-bottom: 10px;
        }
        
        .header-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e3f2fd;
            font-weight: 600;
            font-size: 14px;
        }
        
        .header-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            font-size: 15px;
            color: #333;
        }
        
        .tabs-container {
            background: #fff;
            border-bottom: 2px solid #e1e5eb;
            overflow-x: auto;
            display: flex;
        }
        
        .tabs {
            display: flex;
            min-width: max-content;
            padding: 0 40px;
        }
        
        .tab {
            padding: 20px 35px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #555;
            position: relative;
            white-space: nowrap;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            color: #1a237e;
            background: #f8f9fa;
        }
        
        .tab.active {
            color: #1a237e;
            border-bottom-color: #1a237e;
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-top: 5px solid #4a6fa5;
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card i {
            font-size: 40px;
            color: #4a6fa5;
            margin-bottom: 20px;
        }
        
        .dashboard-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 24px;
        }
        
        .dashboard-card p {
            margin: 0;
            color: #666;
            font-size: 15px;
        }
        
        .create-test-form {
            background: white;
            border-radius: 12px;
            padding: 35px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #1a237e;
            margin-top: 0;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f0fe;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 15px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a6fa5;
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        .datetime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .question-type-container {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .question-type-btn {
            padding: 12px 25px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-type-btn:hover {
            border-color: #4a6fa5;
            color: #4a6fa5;
        }
        
        .question-type-btn.active {
            border-color: #4a6fa5;
            background: #e8f0fe;
            color: #4a6fa5;
        }
        
        .options-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
        }
        
        .option-item input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .correct-option {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .essay-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        
        .essay-container textarea {
            min-height: 150px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #4a6fa5, #3a5a85);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #3a5a85, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 90, 133, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(to right, #28a745, #218838);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(to right, #218838, #1e7e34);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #dc3545, #c82333);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(to right, #c82333, #bd2130);
            transform: translateY(-2px);
        }
        
        .btn-excel {
            background: linear-gradient(to right, #1d6f42, #165a34);
            color: white;
        }
        
        .btn-excel:hover {
            background: linear-gradient(to right, #165a34, #0d4526);
            transform: translateY(-2px);
        }
        
        .btn-publish {
            background: linear-gradient(to right, #9c27b0, #7b1fa2);
            color: white;
        }
        
        .btn-publish:hover {
            background: linear-gradient(to right, #7b1fa2, #6a1b9a);
            transform: translateY(-2px);
        }
        
        .questions-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #e1e5eb;
            border-radius: 10px;
            background: #f8f9fa;
            margin-top: 25px;
        }
        
        .question-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4a6fa5;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .question-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .question-type-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .badge-mcq {
            background: #e8f0fe;
            color: #4a6fa5;
        }
        
        .badge-essay {
            background: #f3e5f5;
            color: #9c27b0;
        }
        
        .publish-controls {
            background: #e8f0fe;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #4a6fa5;
        }
        
        .publish-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .test-card {
            background: white;
            border: 1px solid #e1e5eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .test-card.published {
            border-color: #28a745;
            background: linear-gradient(to bottom right, #ffffff, #f8fff9);
        }
        
        .test-card.published::before {
            content: 'Ù…Ù†Ø´ÙˆØ±';
            position: absolute;
            top: 15px;
            left: 15px;
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .test-card h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 22px;
        }
        
        .test-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .test-meta p {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 3px dashed #4a6fa5;
            border-radius: 12px;
            padding: 60px 30px;
            text-align: center;
            background: #f8fafc;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #e8f0fe;
            border-color: #3a5a85;
        }
        
        .students-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            border: 1px solid #e1e5eb;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .students-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .students-table th {
            background: #2c3e50;
            color: white;
            padding: 18px 15px;
            text-align: right;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .students-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #e1e5eb;
            text-align: right;
        }
        
        .alert {
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: none;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6fa5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        .loader.active {
            display: block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
            
            .tabs {
                padding: 0 20px;
            }
            
            .tab-content {
                padding: 30px 20px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }
            
            .header-top {
                flex-direction: column;
                text-align: center;
            }
            
            .header-info {
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
                width: 100%;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tests-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="logo">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù…Ø¹ Firebase</h1>
                </div>
                <div class="header-info">
                    <div class="info-item">
                        <i class="fas fa-user-tie"></i>
                        <span>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="currentDate"></span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-plug"></i>
                        <span id="firebaseStatus">ğŸ”Œ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
                    </div>
                </div>
            </div>
            
            <div class="test-header-form">
                <div class="header-form-grid">
                    <div class="header-form-group">
                        <label><i class="fas fa-flag"></i> Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                        <input type="text" id="country" placeholder="Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-building"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                        <input type="text" id="administration" placeholder="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-school"></i> Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                        <input type="text" id="school" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-book"></i> Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                        <input type="text" id="subject" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                    </div>
                </div>
                <button onclick="saveHeaderData()" class="btn btn-primary" style="margin-top: 15px;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                </button>
            </div>
        </div>
        
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                <button class="tab" onclick="switchTab('createTest')"><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±</button>
                <button class="tab" onclick="switchTab('manageStudents')"><i class="fas fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                <button class="tab" onclick="switchTab('viewTests')"><i class="fas fa-clipboard-list"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
                <button class="tab" onclick="switchTab('results')"><i class="fas fa-chart-bar"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            </div>
        </div>
        
        <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
        <div id="dashboard" class="tab-content active">
            <div id="dashboardLoader" class="loader"></div>
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <i class="fas fa-clipboard-list"></i>
                    <h3 id="totalTests">0</h3>
                    <p>Ø¥Ø®ØªØ¨Ø§Ø± Ù…Ù†Ø´ÙˆØ±</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-users"></i>
                    <h3 id="totalStudents">0</h3>
                    <p>Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-question-circle"></i>
                    <h3 id="totalQuestions">0</h3>
                    <p>Ø³Ø¤Ø§Ù„ Ù…Ø®Ø²Ù†</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-check-circle"></i>
                    <h3 id="completedTests">0</h3>
                    <p>Ø¥Ø®ØªØ¨Ø§Ø± Ù…ÙƒØªÙ…Ù„</p>
                </div>
            </div>
        </div>
        
        <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± -->
        <div id="createTest" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="testTitle"><i class="fas fa-heading"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                        <input type="text" id="testTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø¶Ø­ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±">
                    </div>
                    
                    <div class="form-group">
                        <label for="testSubject"><i class="fas fa-book"></i> Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
                        <input type="text" id="testSubject" placeholder="Ù…Ø«Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŒ Ø§Ù„Ø¹Ù„ÙˆÙ…ØŒ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
                    </div>
                    
                    <div class="form-group">
                        <label for="testDuration"><i class="fas fa-clock"></i> Ø²Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¯Ù‚Ø§Ø¦Ù‚):</label>
                        <input type="number" id="testDuration" min="1" value="45">
                    </div>
                    
                    <div class="form-group">
                        <label for="passingScore"><i class="fas fa-graduation-cap"></i> Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (%):</label>
                        <input type="number" id="passingScore" min="0" max="100" value="60">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="testDescription"><i class="fas fa-align-left"></i> ÙˆØµÙ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                    <textarea id="testDescription" placeholder="ØµÙ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©" rows="3"></textarea>
                </div>
                
                <h3 class="section-title"><i class="fas fa-calendar-alt"></i> ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                <div class="datetime-grid">
                    <div class="form-group">
                        <label for="startDate"><i class="fas fa-calendar-plus"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                        <input type="datetime-local" id="startTime">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate"><i class="fas fa-calendar-minus"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
                        <input type="datetime-local" id="endTime">
                    </div>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-question-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>
                
                <div class="form-group">
                    <label><i class="fas fa-tasks"></i> Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                    <div class="question-type-container">
                        <button class="question-type-btn active" onclick="setQuestionType('mcq')">
                            <i class="fas fa-list-ol"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
                        </button>
                        <button class="question-type-btn" onclick="setQuestionType('essay')">
                            <i class="fas fa-edit"></i> Ù…Ù‚Ø§Ù„ÙŠ (Ø±Ø³Ù… ÙˆÙƒØªØ§Ø¨Ø©)
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="questionText"><i class="fas fa-pencil-alt"></i> Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                    <textarea id="questionText" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." rows="3"></textarea>
                </div>
                
                <!-- Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ -->
                <div id="mcqOptions" class="options-container">
                    <label style="display: block; margin-bottom: 15px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-list-ol"></i> Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
                    </label>
                    <div id="optionsList">
                        <div class="option-item">
                            <input type="radio" name="correctOption" value="0" class="correct-option" checked>
                            <input type="text" class="option-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„">
                            <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="correctOption" value="1" class="correct-option">
                            <input type="text" class="option-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
                            <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button onclick="addOption()" class="btn btn-secondary" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
                
                <!-- Ù‚Ø³Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ -->
                <div id="essayOptions" class="essay-container" style="display: none;">
                    <label style="display: block; margin-bottom: 15px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-edit"></i> ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ:
                    </label>
                    <textarea id="essayInstructions" placeholder="Ø£Ø¯Ø®Ù„ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø£Ùˆ ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ©..." rows="2"></textarea>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="questionPoints"><i class="fas fa-star"></i> Ø¯Ø±Ø¬Ø© Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                        <input type="number" id="questionPoints" min="1" value="5">
                    </div>
                </div>
                
                <button onclick="addQuestion()" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                </button>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-list-check"></i> Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (<span id="questionsCount">0</span>)</h2>
                
                <div id="questionsList" class="questions-list">
                    <p style="text-align: center; color: #666; padding: 40px;">Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯</p>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button onclick="saveTest()" class="btn btn-success" id="saveTestBtn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Firebase
                    </button>
                    <button onclick="clearTest()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                    </button>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-share-square"></i> Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                
                <div id="publishSection" style="display: none;">
                    <div class="publish-info">
                        <div>
                            <p style="margin: 0; color: #2c3e50;"><strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> <span id="publishTitle"></span></p>
                        </div>
                        <div>
                            <p style="margin: 0; color: #2c3e50;"><strong>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡:</strong> <span id="publishStart"></span></p>
                        </div>
                        <div>
                            <p style="margin: 0; color: #2c3e50;"><strong>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> <span id="publishEnd"></span></p>
                        </div>
                    </div>
                    
                    <button onclick="publishTest()" class="btn btn-publish" id="publishTestBtn">
                        <i class="fas fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø·Ù„Ø§Ø¨
                    </button>
                </div>
                
                <div id="noTestSaved" style="text-align: center; padding: 20px;">
                    <i class="fas fa-clipboard" style="font-size: 50px; color: #ddd; margin-bottom: 15px;"></i>
                    <p style="color: #666;">ÙŠØ¬Ø¨ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ù†Ø´Ø±Ù‡</p>
                </div>
            </div>
        </div>
        
        <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
        <div id="manageStudents" class="tab-content">
            <div id="studentsLoader" class="loader"></div>
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
                    <div style="background: #f3e5f5; padding: 25px; border-radius: 10px;">
                        <h3 style="margin-top: 0; color: #2c3e50;"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                        <div class="form-group">
                            <label for="studentSsn"><i class="fas fa-id-card"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ:</label>
                            <input type="text" id="studentSsn" placeholder="10 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="studentName"><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                            <input type="text" id="studentName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ">
                        </div>
                        <button onclick="addStudent()" class="btn btn-primary">
                            <i class="fas fa-cloud-upload-alt"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Firebase
                        </button>
                    </div>
                    
                    <div style="background: #e8f0fe; padding: 25px; border-radius: 10px;">
                        <h3 style="margin-top: 0; color: #2c3e50;"><i class="fas fa-sync-alt"></i> Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase</h3>
                        <p style="color: #666; margin-bottom: 15px;">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</p>
                        <button onclick="loadStudentsFromFirebase()" class="btn btn-success">
                            <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Excel</h2>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-excel"></i>
                    <h3>Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ Ù…Ù„Ù Excel</h3>
                    <p>Ø§Ø³Ø­Ø¨ ÙˆØ£Ø³Ù‚Ø· Ù…Ù„Ù Excel Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                    <p style="color: #4a6fa5; font-weight: 600;">
                        <i class="fas fa-download"></i> 
                        <a href="#" onclick="downloadTemplate()" style="color: #2c3e50; text-decoration: none;">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ù†Ù…ÙˆØ°Ø¬</a>
                    </p>
                </div>
                
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
                
                <div id="importAlert" class="alert"></div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button onclick="exportToExcel()" class="btn btn-excel">
                        <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                    </button>
                    <button onclick="clearAllStudents()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Firebase
                    </button>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="studentsCount">0</span>)</h2>
                
                <div id="studentsTableContainer">
                    <p style="text-align: center; color: #666; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</p>
                </div>
            </div>
        </div>
        
        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª -->
        <div id="viewTests" class="tab-content">
            <div id="testsLoader" class="loader"></div>
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button onclick="filterTests('all')" class="btn btn-secondary">
                        <i class="fas fa-list"></i> Ø§Ù„ÙƒÙ„
                    </button>
                    <button onclick="filterTests('published')" class="btn btn-success">
                        <i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©
                    </button>
                    <button onclick="filterTests('draft')" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
                    </button>
                    <button onclick="filterTests('active')" class="btn btn-primary">
                        <i class="fas fa-play-circle"></i> Ø§Ù„Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†
                    </button>
                </div>
                
                <div id="testsList" class="tests-grid">
                    <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‡Ù†Ø§ -->
                </div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="results" class="tab-content">
            <div id="resultsLoader" class="loader"></div>
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
                
                <div id="resultsContainer">
                    <p style="text-align: center; color: #666; padding: 60px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯</p>
                </div>
            </div>
        </div>
        
        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div id="systemAlert" class="alert"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAYMb0gkHb44Qjy05OJrj0AMpXHXAMx7mU",
            authDomain: "m1t1-1b066.firebaseapp.com",
            projectId: "m1t1-1b066",
            storageBucket: "m1t1-1b066.firebasestorage.app",
            messagingSenderId: "882725081382",
            appId: "1:882725081382:web:4ed556cc7c3f51c52231e7",
            measurementId: "G-ZMNWTL2WY8"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let currentTest = {
            id: '',
            title: '',
            subject: '',
            description: '',
            duration: 45,
            passingScore: 60,
            startTime: '',
            endTime: '',
            questions: [],
            createdAt: '',
            isPublished: false,
            publishedAt: ''
        };
        
        let studentsList = [];
        let testsList = [];
        let resultsList = [];
        let currentQuestionType = 'mcq';
        let savedTestId = null;
        let currentTeacherId = null;
        
        // ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© ==========
        document.addEventListener('DOMContentLoaded', function() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            updateCurrentDate();
            
            // ØªØ¹ÙŠÙŠÙ† ØªÙˆØ§Ø±ÙŠØ® Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            setDefaultDates();
            
            // ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ù…Ø¹Ù„Ù…
            initializeFirebase();
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            loadHeaderData();
        });
        
        // ========== ØªÙ‡ÙŠØ¦Ø© Firebase ==========
        async function initializeFirebase() {
            try {
                document.getElementById('firebaseStatus').innerHTML = '<i class="fas fa-sync-alt spinning"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„Ø§Ù‹ Ø£Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…
                await auth.signInAnonymously().catch(async () => {
                    // Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø¹Ù„Ù…
                    const teacherEmail = `teacher_${Date.now()}@testsystem.com`;
                    const teacherPassword = 'teacher123';
                    await auth.createUserWithEmailAndPassword(teacherEmail, teacherPassword);
                });
                
                const user = auth.currentUser;
                currentTeacherId = user.uid;
                
                document.getElementById('firebaseStatus').innerHTML = '<i class="fas fa-check-circle"></i> Ù…ØªØµÙ„ Ø¨Ù€ Firebase';
                document.getElementById('firebaseStatus').style.color = '#28a745';
                
                // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await loadAllData();
                
                // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                updateDashboard();
                
                showSystemAlert('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase:', error);
                document.getElementById('firebaseStatus').innerHTML = '<i class="fas fa-times-circle"></i> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
                document.getElementById('firebaseStatus').style.color = '#dc3545';
                showSystemAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('ar-SA', options);
        }
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        function setDefaultDates() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù€ input type="datetime-local"
            const formatDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            document.getElementById('startTime').value = formatDateTime(now);
            document.getElementById('endTime').value = formatDateTime(tomorrow);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø£Ø³
        function loadHeaderData() {
            const savedCountry = localStorage.getItem('teacher_country');
            const savedAdmin = localStorage.getItem('teacher_administration');
            const savedSchool = localStorage.getItem('teacher_school');
            const savedSubject = localStorage.getItem('teacher_subject');
            
            if (savedCountry) document.getElementById('country').value = savedCountry;
            if (savedAdmin) document.getElementById('administration').value = savedAdmin;
            if (savedSchool) document.getElementById('school').value = savedSchool;
            if (savedSubject) document.getElementById('subject').value = savedSubject;
        }
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø£Ø³
        async function saveHeaderData() {
            try {
                const country = document.getElementById('country').value;
                const administration = document.getElementById('administration').value;
                const school = document.getElementById('school').value;
                const subject = document.getElementById('subject').value;
                
                localStorage.setItem('teacher_country', country);
                localStorage.setItem('teacher_administration', administration);
                localStorage.setItem('teacher_school', school);
                localStorage.setItem('teacher_subject', subject);
                
                // Ø­ÙØ¸ ÙÙŠ Firebase Ø£ÙŠØ¶Ø§Ù‹
                await db.collection('teacherSettings').doc(currentTeacherId).set({
                    country: country,
                    administration: administration,
                    school: school,
                    subject: subject,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showSystemAlert('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø£Ø³:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
        async function loadAllData() {
            try {
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                showLoader('dashboardLoader', true);
                showLoader('studentsLoader', true);
                showLoader('testsLoader', true);
                showLoader('resultsLoader', true);
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
                const studentsSnapshot = await db.collection('students')
                    .where('teacherId', '==', currentTeacherId)
                    .get();
                
                studentsList = [];
                studentsSnapshot.forEach(doc => {
                    studentsList.push({ id: doc.id, ...doc.data() });
                });
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                const testsSnapshot = await db.collection('tests')
                    .where('teacherId', '==', currentTeacherId)
                    .get();
                
                testsList = [];
                testsSnapshot.forEach(doc => {
                    testsList.push({ id: doc.id, ...doc.data() });
                });
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const resultsSnapshot = await db.collection('results')
                    .where('teacherId', '==', currentTeacherId)
                    .get();
                
                resultsList = [];
                resultsSnapshot.forEach(doc => {
                    resultsList.push({ id: doc.id, ...doc.data() });
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
                updateStudentsTable();
                updateTestsList();
                updateResultsList();
                
                // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
                showLoader('dashboardLoader', false);
                showLoader('studentsLoader', false);
                showLoader('testsLoader', false);
                showLoader('resultsLoader', false);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase', 'error');
                
                // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                showLoader('dashboardLoader', false);
                showLoader('studentsLoader', false);
                showLoader('testsLoader', false);
                showLoader('resultsLoader', false);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function updateDashboard() {
            try {
                document.getElementById('totalTests').textContent = 
                    testsList.filter(t => t.isPublished).length;
                document.getElementById('totalStudents').textContent = studentsList.length;
                
                let totalQuestions = 0;
                testsList.forEach(test => {
                    totalQuestions += test.questions.length;
                });
                document.getElementById('totalQuestions').textContent = totalQuestions;
                
                document.getElementById('completedTests').textContent = resultsList.length;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', error);
            }
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showLoader(loaderId, show) {
            const loader = document.getElementById(loaderId);
            if (loader) {
                loader.style.display = show ? 'block' : 'none';
            }
        }
        
        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        function switchTab(tabName) {
            try {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');
                
                if (tabName === 'viewTests') {
                    updateTestsList();
                } else if (tabName === 'results') {
                    updateResultsList();
                } else if (tabName === 'manageStudents') {
                    updateStudentsTable();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª:', error);
            }
        }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ==========
        function setQuestionType(type) {
            currentQuestionType = type;
            
            document.querySelectorAll('.question-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (type === 'mcq') {
                document.getElementById('mcqOptions').style.display = 'block';
                document.getElementById('essayOptions').style.display = 'none';
            } else {
                document.getElementById('mcqOptions').style.display = 'none';
                document.getElementById('essayOptions').style.display = 'block';
            }
        }
        
        function addOption() {
            const optionsList = document.getElementById('optionsList');
            const optionCount = optionsList.children.length;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'option-item';
            optionItem.innerHTML = `
                <input type="radio" name="correctOption" value="${optionCount}" class="correct-option">
                <input type="text" class="option-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± ${optionCount + 1}">
                <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            optionsList.appendChild(optionItem);
        }
        
        function removeOption(button) {
            const optionsList = document.getElementById('optionsList');
            if (optionsList.children.length > 2) {
                button.closest('.option-item').remove();
            } else {
                showSystemAlert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
            }
        }
        
        function addQuestion() {
            try {
                const questionText = document.getElementById('questionText').value.trim();
                const questionPoints = parseInt(document.getElementById('questionPoints').value) || 1;
                
                if (!questionText) {
                    showSystemAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
                    return;
                }
                
                let question;
                
                if (currentQuestionType === 'mcq') {
                    // Ø¬Ù…Ø¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
                    const options = [];
                    const optionInputs = document.querySelectorAll('.option-input');
                    optionInputs.forEach(input => {
                        if (input.value.trim() !== '') {
                            options.push(input.value.trim());
                        }
                    });
                    
                    if (options.length < 2) {
                        showSystemAlert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                        return;
                    }
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
                    const correctAnswer = parseInt(document.querySelector('input[name="correctOption"]:checked').value);
                    
                    question = {
                        id: Date.now().toString(),
                        type: 'mcq',
                        text: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        points: questionPoints
                    };
                    
                } else {
                    const essayInstructions = document.getElementById('essayInstructions').value.trim();
                    
                    question = {
                        id: Date.now().toString(),
                        type: 'essay',
                        text: questionText,
                        instructions: essayInstructions,
                        points: questionPoints
                    };
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„
                currentTest.questions.push(question);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                updateQuestionsList();
                
                // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸
                document.getElementById('saveTestBtn').disabled = false;
                
                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('questionText').value = '';
                document.getElementById('essayInstructions').value = '';
                
                if (currentQuestionType === 'mcq') {
                    document.querySelectorAll('.option-input').forEach(input => {
                        input.value = '';
                    });
                    document.querySelectorAll('input[name="correctOption"]')[0].checked = true;
                }
                
                showSystemAlert('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
            }
        }
        
        function updateQuestionsList() {
            try {
                const container = document.getElementById('questionsList');
                const countElement = document.getElementById('questionsCount');
                
                if (currentTest.questions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯</p>';
                    countElement.textContent = '0';
                    return;
                }
                
                let html = '';
                currentTest.questions.forEach((question, index) => {
                    html += `
                        <div class="question-card">
                            <span class="question-type-badge ${question.type === 'mcq' ? 'badge-mcq' : 'badge-essay'}">
                                ${question.type === 'mcq' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 'Ù…Ù‚Ø§Ù„ÙŠ'}
                            </span>
                            <h4>Ø³Ø¤Ø§Ù„ ${index + 1}: ${question.text}</h4>
                            <p><strong>Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong> ${question.points}</p>
                    `;
                    
                    if (question.type === 'mcq') {
                        html += '<div style="margin-top: 15px;">';
                        question.options.forEach((option, optIndex) => {
                            const isCorrect = optIndex === question.correctAnswer;
                            html += `
                                <div style="padding: 10px; margin-bottom: 8px; background: ${isCorrect ? '#d4edda' : '#f8f9fa'}; 
                                     border-radius: 5px; border-right: 3px solid ${isCorrect ? '#28a745' : '#ddd'};">
                                    ${option} ${isCorrect ? ' âœ“' : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html += `<p><strong>Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong> ${question.instructions || 'Ø¨Ø¯ÙˆÙ† ØªØ¹Ù„ÙŠÙ…Ø§Øª'}</p>`;
                    }
                    
                    html += `
                            <button onclick="removeQuestion(${index})" class="btn btn-danger" style="padding: 8px 15px; font-size: 14px; margin-top: 15px;">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                countElement.textContent = currentTest.questions.length;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
            }
        }
        
        function removeQuestion(index) {
            try {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
                    currentTest.questions.splice(index, 1);
                    updateQuestionsList();
                    
                    if (currentTest.questions.length === 0) {
                        document.getElementById('saveTestBtn').disabled = true;
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
            }
        }
        
        // ========== Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Firebase ==========
        async function saveTest() {
            try {
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø£Ø³ Ø£ÙˆÙ„Ø§Ù‹
                saveHeaderData();
                
                // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                currentTest.title = document.getElementById('testTitle').value.trim();
                currentTest.subject = document.getElementById('testSubject').value.trim();
                currentTest.description = document.getElementById('testDescription').value.trim();
                currentTest.duration = parseInt(document.getElementById('testDuration').value) || 45;
                currentTest.passingScore = parseInt(document.getElementById('passingScore').value) || 60;
                
                // Ø¬Ù…Ø¹ ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                currentTest.startTime = document.getElementById('startTime').value;
                currentTest.endTime = document.getElementById('endTime').value;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!currentTest.title || !currentTest.subject || currentTest.questions.length === 0) {
                    showSystemAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ù…Ø§Ø¯Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                    return;
                }
                
                if (!currentTest.startTime || !currentTest.endTime) {
                    showSystemAlert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆÙ‚ÙŠØª Ø¨Ø¯Ø¡ ÙˆØ§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØª
                const start = new Date(currentTest.startTime);
                const end = new Date(currentTest.endTime);
                
                if (start >= end) {
                    showSystemAlert('ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡', 'error');
                    return;
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…
                currentTest.teacherId = currentTeacherId;
                currentTest.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                currentTest.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                
                let testId;
                
                if (currentTest.id) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯
                    testId = currentTest.id;
                    await db.collection('tests').doc(testId).update({
                        title: currentTest.title,
                        subject: currentTest.subject,
                        description: currentTest.description,
                        duration: currentTest.duration,
                        passingScore: currentTest.passingScore,
                        startTime: currentTest.startTime,
                        endTime: currentTest.endTime,
                        questions: currentTest.questions,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                    testId = 'TEST-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    currentTest.id = testId;
                    
                    await db.collection('tests').doc(testId).set({
                        ...currentTest,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                savedTestId = testId;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const existingIndex = testsList.findIndex(t => t.id === testId);
                if (existingIndex !== -1) {
                    testsList[existingIndex] = { ...currentTest };
                } else {
                    testsList.push({ ...currentTest });
                }
                
                // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø±
                document.getElementById('publishTitle').textContent = currentTest.title;
                document.getElementById('publishStart').textContent = 
                    new Date(currentTest.startTime).toLocaleString('ar-SA');
                document.getElementById('publishEnd').textContent = 
                    new Date(currentTest.endTime).toLocaleString('ar-SA');
                
                document.getElementById('publishSection').style.display = 'block';
                document.getElementById('noTestSaved').style.display = 'none';
                
                // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­ÙØ¸
                document.getElementById('saveTestBtn').innerHTML = '<i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
                
                showSystemAlert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                updateTestsList();
                updateDashboard();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'error');
            }
        }
        
        // Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        function clearTest() {
            try {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŸ')) {
                    currentTest.questions = [];
                    updateQuestionsList();
                    document.getElementById('saveTestBtn').disabled = true;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
            }
        }
        
        // Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        async function publishTest() {
            try {
                if (!currentTest.id && !savedTestId) {
                    showSystemAlert('ÙŠØ¬Ø¨ Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ù†Ø´Ø±Ù‡', 'error');
                    return;
                }
                
                const testId = currentTest.id || savedTestId;
                
                // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
                await db.collection('tests').doc(testId).update({
                    isPublished: true,
                    publishedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠØ§Ù‹
                const testIndex = testsList.findIndex(t => t.id === testId);
                if (testIndex !== -1) {
                    testsList[testIndex].isPublished = true;
                    testsList[testIndex].publishedAt = new Date().toISOString();
                    
                    if (currentTest.id === testId) {
                        currentTest.isPublished = true;
                        currentTest.publishedAt = testsList[testIndex].publishedAt;
                    }
                }
                
                showSystemAlert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ† Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¢Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡', 'success');
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                updateTestsList();
                updateDashboard();
                
                // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù†Ø´Ø±
                const publishBtn = document.getElementById('publishTestBtn');
                if (publishBtn) {
                    publishBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø´Ø±';
                    publishBtn.disabled = true;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message, 'error');
            }
        }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø¹ Firebase ==========
        async function addStudent() {
            try {
                const ssn = document.getElementById('studentSsn').value.trim();
                const name = document.getElementById('studentName').value.trim();
                
                if (!ssn || !name) {
                    showSystemAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ ÙˆØ§Ù„Ø§Ø³Ù…', 'error');
                    return;
                }
                
                if (ssn.length < 10) {
                    showSystemAlert('Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ
                const existingStudent = await db.collection('students')
                    .where('teacherId', '==', currentTeacherId)
                    .where('ssn', '==', ssn)
                    .get();
                
                if (!existingStudent.empty) {
                    showSystemAlert('Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error');
                    return;
                }
                
                const studentId = 'STU-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const student = {
                    id: studentId,
                    ssn: ssn,
                    name: name,
                    teacherId: currentTeacherId,
                    registeredAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Ø­ÙØ¸ ÙÙŠ Firebase
                await db.collection('students').doc(studentId).set(student);
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹
                studentsList.push(student);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
                updateStudentsTable();
                
                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('studentSsn').value = '';
                document.getElementById('studentName').value = '';
                
                showSystemAlert('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­', 'success');
                updateDashboard();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨: ' + error.message, 'error');
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
        function updateStudentsTable() {
            try {
                const container = document.getElementById('studentsTableContainer');
                const countElement = document.getElementById('studentsCount');
                
                if (studentsList.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</p>';
                    countElement.textContent = '0';
                    return;
                }
                
                let html = `
                    <div class="students-table-container">
                        <table class="students-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                studentsList.forEach((student, index) => {
                    const date = student.registeredAt && student.registeredAt.toDate ? 
                        student.registeredAt.toDate().toLocaleString('ar-SA') : 
                        'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${student.ssn}</strong></td>
                            <td>${student.name}</td>
                            <td>${date}</td>
                            <td>
                                <button onclick="editStudent('${student.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteStudent('${student.id}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                countElement.textContent = studentsList.length;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨', 'error');
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Firebase
        async function loadStudentsFromFirebase() {
            try {
                showLoader('studentsLoader', true);
                
                const studentsSnapshot = await db.collection('students')
                    .where('teacherId', '==', currentTeacherId)
                    .get();
                
                studentsList = [];
                studentsSnapshot.forEach(doc => {
                    studentsList.push({ id: doc.id, ...doc.data() });
                });
                
                updateStudentsTable();
                showLoader('studentsLoader', false);
                
                showSystemAlert(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${studentsList.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Firebase`, 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨: ' + error.message, 'error');
                showLoader('studentsLoader', false);
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel
        async function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    showLoader('studentsLoader', true);
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showSystemAlert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                        showLoader('studentsLoader', false);
                        return;
                    }
                    
                    let importedCount = 0;
                    let duplicateCount = 0;
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
                    const currentStudents = await db.collection('students')
                        .where('teacherId', '==', currentTeacherId)
                        .get();
                    
                    const existingSsns = new Set();
                    currentStudents.forEach(doc => {
                        existingSsns.add(doc.data().ssn);
                    });
                    
                    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ„ Ø·Ø§Ù„Ø¨
                    for (const row of jsonData) {
                        const ssn = (row['Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'] || row['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ'] || row['ssn'] || '').toString().trim();
                        const name = (row['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'] || row['Ø§Ù„Ø§Ø³Ù…'] || row['name'] || '').toString().trim();
                        
                        if (ssn && name && ssn.length >= 10) {
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
                            if (existingSsns.has(ssn)) {
                                duplicateCount++;
                                continue;
                            }
                            
                            const studentId = 'STU-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                            
                            const student = {
                                id: studentId,
                                ssn: ssn,
                                name: name,
                                teacherId: currentTeacherId,
                                registeredAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            // Ø­ÙØ¸ ÙÙŠ Firebase
                            await db.collection('students').doc(studentId).set(student);
                            
                            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                            studentsList.push(student);
                            existingSsns.add(ssn);
                            importedCount++;
                        }
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    updateStudentsTable();
                    showLoader('studentsLoader', false);
                    
                    let message = `âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Firebase`;
                    if (duplicateCount > 0) {
                        message += ` (ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${duplicateCount} Ø·Ø§Ù„Ø¨ Ù…ÙƒØ±Ø±)`;
                    }
                    
                    showSystemAlert(message, 'success');
                    updateDashboard();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showSystemAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚', 'error');
                    showLoader('studentsLoader', false);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel
        function downloadTemplate() {
            const templateData = [
                { 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': '1011121314' },
                { 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': 'Ø³Ø§Ø±Ø© Ø®Ø§Ù„Ø¯ Ø­Ø³Ù†', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': '2011121315' },
                { 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': 'Ø¹Ù„ÙŠ Ø³Ø¹ÙŠØ¯ Ù…Ø­Ù…ÙˆØ¯', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': '3011121316' }
            ];
            
            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
            
            XLSX.writeFile(workbook, 'Ù†Ù…ÙˆØ°Ø¬_Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø·Ù„Ø§Ø¨.xlsx');
        }
        
        // ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
        function exportToExcel() {
            try {
                if (studentsList.length === 0) {
                    showSystemAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
                    return;
                }
                
                const exportData = studentsList.map(s => ({
                    'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': s.name,
                    'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': s.ssn,
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„': s.registeredAt && s.registeredAt.toDate ? 
                        s.registeredAt.toDate().toLocaleString('ar-SA') : 
                        'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨');
                
                XLSX.writeFile(workbook, 'Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø·Ù„Ø§Ø¨_Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†.xlsx');
                
                showSystemAlert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'error');
            }
        }
        
        // ØªØ­Ø±ÙŠØ± Ø·Ø§Ù„Ø¨
        async function editStudent(studentId) {
            try {
                const student = studentsList.find(s => s.id === studentId);
                if (!student) return;
                
                const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:', student.name);
                if (newName !== null) {
                    const newSsn = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ:', student.ssn);
                    
                    if (newSsn !== null) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ
                        const duplicate = studentsList.find(s => s.ssn === newSsn && s.id !== studentId);
                        if (duplicate) {
                            showSystemAlert('Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error');
                            return;
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
                        await db.collection('students').doc(studentId).update({
                            name: newName,
                            ssn: newSsn,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠØ§Ù‹
                        student.name = newName;
                        student.ssn = newSsn;
                        
                        updateStudentsTable();
                        showSystemAlert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨', 'success');
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
            }
        }
        
        // Ø­Ø°Ù Ø·Ø§Ù„Ø¨
        async function deleteStudent(studentId) {
            try {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                    // Ø­Ø°Ù Ù…Ù† Firebase
                    await db.collection('students').doc(studentId).delete();
                    
                    // Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹
                    studentsList = studentsList.filter(s => s.id !== studentId);
                    
                    updateStudentsTable();
                    updateDashboard();
                    
                    showSystemAlert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
            }
        }
        
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
        async function clearAllStudents() {
            try {
                if (studentsList.length === 0) {
                    showSystemAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ Ù„Ù„Ø­Ø°Ù', 'error');
                    return;
                }
                
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
                    showLoader('studentsLoader', true);
                    
                    // Ø­Ø°Ù ÙƒÙ„ ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø·Ù„Ø§Ø¨
                    const batch = db.batch();
                    studentsList.forEach(student => {
                        const studentRef = db.collection('students').doc(student.id);
                        batch.delete(studentRef);
                    });
                    
                    await batch.commit();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    studentsList = [];
                    updateStudentsTable();
                    showLoader('studentsLoader', false);
                    
                    showSystemAlert('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Firebase', 'success');
                    updateDashboard();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø§Ø¨:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø§Ø¨', 'error');
                showLoader('studentsLoader', false);
            }
        }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ==========
        function filterTests(type) {
            updateTestsList(type);
        }
        
        function updateTestsList(filter = 'all') {
            try {
                const container = document.getElementById('testsList');
                
                let filteredTests = testsList;
                
                if (filter === 'published') {
                    filteredTests = testsList.filter(t => t.isPublished);
                } else if (filter === 'draft') {
                    filteredTests = testsList.filter(t => !t.isPublished);
                } else if (filter === 'active') {
                    const now = new Date();
                    filteredTests = testsList.filter(t => {
                        if (!t.isPublished) return false;
                        const start = new Date(t.startTime);
                        const end = new Date(t.endTime);
                        return now >= start && now <= end;
                    });
                }
                
                if (filteredTests.length === 0) {
                    let message = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª';
                    if (filter === 'published') message = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø©';
                    else if (filter === 'draft') message = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø³ÙˆØ¯Ø©';
                    else if (filter === 'active') message = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†';
                    
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; grid-column: 1/-1;">
                            <i class="fas fa-clipboard" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">${message}</h3>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                filteredTests.forEach((test, index) => {
                    const start = new Date(test.startTime);
                    const end = new Date(test.endTime);
                    const now = new Date();
                    const isActive = now >= start && now <= end && test.isPublished;
                    
                    const studentCount = resultsList.filter(r => r.testId === test.id).length;
                    
                    const createdAt = test.createdAt && test.createdAt.toDate ? 
                        test.createdAt.toDate().toLocaleString('ar-SA') : 
                        'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    html += `
                        <div class="test-card ${test.isPublished ? 'published' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <h3>${test.title}</h3>
                                ${isActive ? 
                                    '<span style="background: #4a6fa5; color: white; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span>' : 
                                    ''
                                }
                            </div>
                            <p style="color: #666; margin-bottom: 15px;">${test.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</p>
                            <div class="test-meta">
                                <p><i class="fas fa-book"></i> Ø§Ù„Ù…Ø§Ø¯Ø©: ${test.subject}</p>
                                <p><i class="fas fa-clock"></i> Ø§Ù„Ù…Ø¯Ø©: ${test.duration} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                                <p><i class="fas fa-graduation-cap"></i> Ø§Ù„Ù†Ø¬Ø§Ø­: ${test.passingScore}%</p>
                                <p><i class="fas fa-question-circle"></i> Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${test.questions.length}</p>
                                <p><i class="fas fa-calendar-alt"></i> Ø§Ù„Ø¨Ø¯Ø¡: ${start.toLocaleString('ar-SA')}</p>
                                <p><i class="fas fa-calendar-times"></i> Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${end.toLocaleString('ar-SA')}</p>
                                <p><i class="fas fa-users"></i> Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${studentCount} Ø·Ø§Ù„Ø¨</p>
                                <p><i class="fas fa-calendar"></i> Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${createdAt}</p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button onclick="viewTestDetails('${test.id}')" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                                </button>
                                <button onclick="deleteTest('${test.id}')" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                                </button>
                                ${!test.isPublished ? 
                                    `<button onclick="publishExistingTest('${test.id}')" class="btn btn-publish">
                                        <i class="fas fa-paper-plane"></i> Ù†Ø´Ø±
                                    </button>` : 
                                    ''
                                }
                                ${studentCount > 0 ? 
                                    `<button onclick="viewTestResults('${test.id}')" class="btn btn-success">
                                        <i class="fas fa-chart-bar"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                                    </button>` : 
                                    ''
                                }
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª', 'error');
            }
        }
        
        // Ù†Ø´Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯
        async function publishExistingTest(testId) {
            try {
                await db.collection('tests').doc(testId).update({
                    isPublished: true,
                    publishedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠØ§Ù‹
                const testIndex = testsList.findIndex(t => t.id === testId);
                if (testIndex !== -1) {
                    testsList[testIndex].isPublished = true;
                    testsList[testIndex].publishedAt = new Date().toISOString();
                }
                
                showSystemAlert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                updateTestsList();
                updateDashboard();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }
        
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        async function viewTestDetails(testId) {
            try {
                const test = testsList.find(t => t.id === testId);
                if (!test) return;
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 1000; padding: 20px;
                    backdrop-filter: blur(5px);
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                            style="position: absolute; top: 15px; left: 15px; background: #dc3545; color: white; 
                            border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px;">
                            Ã—
                        </button>
                        
                        <h2 style="margin: 0 0 25px 0; color: #1a237e; text-align: center;">${test.title}</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #e8f0fe; padding: 20px; border-radius: 10px;">
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${test.subject}</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>Ø²Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> ${test.duration} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­:</strong> ${test.passingScore}%</p>
                            </div>
                            <div style="background: #f3e5f5; padding: 20px; border-radius: 10px;">
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</strong> ${new Date(test.startTime).toLocaleString('ar-SA')}</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> ${new Date(test.endTime).toLocaleString('ar-SA')}</p>
                                <p style="margin: 0; color: #2c3e50;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${test.isPublished ? 'Ù…Ù†Ø´ÙˆØ±' : 'Ù…Ø³ÙˆØ¯Ø©'}</p>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
                            <h3 style="margin-top: 0; color: #2c3e50;">ÙˆØµÙ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h3>
                            <p style="color: #666; line-height: 1.6;">${test.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</p>
                        </div>
                        
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (${test.questions.length})</h3>
                        ${test.questions.map((q, i) => `
                            <div style="background: white; padding: 25px; border-radius: 10px; margin: 15px 0; border: 1px solid #e1e5eb; border-right: 5px solid ${q.type === 'mcq' ? '#4a6fa5' : '#9c27b0'}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: #2c3e50;">Ø³Ø¤Ø§Ù„ ${i+1}: ${q.text}</h4>
                                    <span style="background: ${q.type === 'mcq' ? '#e8f0fe' : '#f3e5f5'}; 
                                          color: ${q.type === 'mcq' ? '#4a6fa5' : '#9c27b0'}; 
                                          padding: 5px 15px; border-radius: 20px; font-size: 13px;">
                                        ${q.type === 'mcq' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 'Ù…Ù‚Ø§Ù„ÙŠ'}
                                    </span>
                                </div>
                                <p style="color: #666; margin-bottom: 15px;"><strong>Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong> ${q.points}</p>
                                
                                ${q.type === 'mcq' ? `
                                    <div style="margin-top: 15px;">
                                        ${q.options.map((opt, j) => `
                                            <div style="padding: 12px; margin-bottom: 10px; background: ${j === q.correctAnswer ? '#d4edda' : '#f8f9fa'}; 
                                                 border-radius: 8px; border-right: 3px solid ${j === q.correctAnswer ? '#28a745' : '#ddd'};">
                                                ${opt} ${j === q.correctAnswer ? ' âœ“ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©' : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p style="color: #666;"><strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</strong> ${q.instructions || 'Ø¨Ø¯ÙˆÙ† ØªØ¹Ù„ÙŠÙ…Ø§Øª'}</p>
                                `}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }
        
        // Ø­Ø°Ù Ø§Ø®ØªØ¨Ø§Ø±
        async function deleteTest(testId) {
            try {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) {
                    // Ø­Ø°Ù Ù…Ù† Firebase
                    await db.collection('tests').doc(testId).delete();
                    
                    // Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹
                    testsList = testsList.filter(t => t.id !== testId);
                    updateTestsList();
                    updateDashboard();
                    
                    showSystemAlert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'success');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }
        
        // ========== Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
        async function viewTestResults(testId) {
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Firebase
                const resultsSnapshot = await db.collection('results')
                    .where('testId', '==', testId)
                    .get();
                
                const testResults = [];
                resultsSnapshot.forEach(doc => {
                    testResults.push({ id: doc.id, ...doc.data() });
                });
                
                const test = testsList.find(t => t.id === testId);
                
                if (!testResults.length) {
                    showSystemAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 1000; padding: 20px;
                    backdrop-filter: blur(5px);
                `;
                
                let resultsHtml = '';
                testResults.forEach((result, i) => {
                    const completedAt = result.completedAt && result.completedAt.toDate ? 
                        result.completedAt.toDate().toLocaleString('ar-SA') : 
                        'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    const passed = result.percentage >= test.passingScore;
                    
                    resultsHtml += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${result.studentName}</td>
                            <td>${result.studentSsn}</td>
                            <td>${result.score}/${result.total}</td>
                            <td>${result.percentage}%</td>
                            <td>
                                <span style="background: ${passed ? '#d4edda' : '#f8d7da'}; 
                                      color: ${passed ? '#155724' : '#721c24'}; 
                                      padding: 5px 15px; border-radius: 20px; font-size: 13px;">
                                    ${passed ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨'}
                                </span>
                            </td>
                            <td>${completedAt}</td>
                        </tr>
                    `;
                });
                
                const avgPercentage = testResults.reduce((sum, r) => sum + r.percentage, 0) / testResults.length;
                const passRate = (testResults.filter(r => r.percentage >= test.passingScore).length / testResults.length) * 100;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                            style="position: absolute; top: 15px; left: 15px; background: #dc3545; color: white; 
                            border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px;">
                            Ã—
                        </button>
                        
                        <h2 style="margin: 0 0 25px 0; color: #1a237e; text-align: center;">Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±: ${test ? test.title : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #e8f0fe; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #4a6fa5; margin: 0;">${testResults.length}</p>
                            </div>
                            <div style="background: #f3e5f5; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ø³Ø¨Ø©</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #9c27b0; margin: 0;">${avgPercentage.toFixed(1)}%</p>
                            </div>
                            <div style="background: #e8f5e9; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #28a745; margin: 0;">${passRate.toFixed(1)}%</p>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 15px; text-align: right;">#</th>
                                        <th style="padding: 15px; text-align: right;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th style="padding: 15px; text-align: right;">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</th>
                                        <th style="padding: 15px; text-align: right;">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                        <th style="padding: 15px; text-align: right;">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                        <th style="padding: 15px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        <th style="padding: 15px; text-align: right;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${resultsHtml}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                            <button onclick="exportResultsToExcel('${testId}')" class="btn btn-excel" style="padding: 12px 25px;">
                                <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'error');
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Excel
        async function exportResultsToExcel(testId) {
            try {
                const resultsSnapshot = await db.collection('results')
                    .where('testId', '==', testId)
                    .get();
                
                const testResults = [];
                resultsSnapshot.forEach(doc => {
                    testResults.push({ id: doc.id, ...doc.data() });
                });
                
                const test = testsList.find(t => t.id === testId);
                
                if (!testResults.length) return;
                
                const exportData = testResults.map((r, i) => {
                    const completedAt = r.completedAt && r.completedAt.toDate ? 
                        r.completedAt.toDate().toLocaleString('ar-SA') : 
                        'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    const passed = r.percentage >= (test?.passingScore || 60);
                    
                    return {
                        'Ù…': i + 1,
                        'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': r.studentName,
                        'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ': r.studentSsn,
                        'Ø§Ù„Ø¯Ø±Ø¬Ø©': `${r.score}/${r.total}`,
                        'Ø§Ù„Ù†Ø³Ø¨Ø©': `${r.percentage}%`,
                        'Ø§Ù„Ø­Ø§Ù„Ø©': passed ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨',
                        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„': completedAt
                    };
                });
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ø§Ù„Ù†ØªØ§Ø¦Ø¬');
                
                const testTitle = test ? test.title.replace(/[^\w\u0600-\u06FF]/g, '_') : 'Ù†ØªØ§Ø¦Ø¬';
                XLSX.writeFile(workbook, `${testTitle}_Ø§Ù„Ù†ØªØ§Ø¦Ø¬.xlsx`);
                
                showSystemAlert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'error');
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        function updateResultsList() {
            try {
                const container = document.getElementById('resultsContainer');
                
                if (resultsList.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 60px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯</p>';
                    return;
                }
                
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                const resultsByTest = {};
                resultsList.forEach(result => {
                    if (!resultsByTest[result.testId]) {
                        resultsByTest[result.testId] = [];
                    }
                    resultsByTest[result.testId].push(result);
                });
                
                let html = '';
                Object.keys(resultsByTest).forEach(testId => {
                    const testResults = resultsByTest[testId];
                    const test = testsList.find(t => t.id === testId);
                    
                    if (!test) return;
                    
                    const avgPercentage = testResults.reduce((sum, r) => sum + r.percentage, 0) / testResults.length;
                    const passRate = (testResults.filter(r => r.percentage >= test.passingScore).length / testResults.length) * 100;
                    
                    html += `
                        <div class="test-card published" style="margin-bottom: 30px;">
                            <h3>${test.title}</h3>
                            <p style="color: #666; margin-bottom: 15px;">${test.subject} - ${test.createdAt && test.createdAt.toDate ? test.createdAt.toDate().toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: #e8f0fe; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #4a6fa5;">${testResults.length}</p>
                                </div>
                                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ø³Ø¨Ø©</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #9c27b0;">${avgPercentage.toFixed(1)}%</p>
                                </div>
                                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #28a745;">${passRate.toFixed(1)}%</p>
                                </div>
                            </div>
                            
                            <button onclick="viewTestResults('${testId}')" class="btn btn-primary">
                                <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', error);
                showSystemAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'error');
            }
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
        function showSystemAlert(message, type = 'info') {
            const alertDiv = document.getElementById('systemAlert');
            if (alertDiv) {
                alertDiv.textContent = message;
                alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
                alertDiv.style.display = 'block';
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† div Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ø¤Ù‚ØªØ§Ù‹
                const tempAlert = document.createElement('div');
                tempAlert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
                tempAlert.textContent = message;
                tempAlert.style.position = 'fixed';
                tempAlert.style.top = '20px';
                tempAlert.style.right = '20px';
                tempAlert.style.zIndex = '9999';
                tempAlert.style.maxWidth = '400px';
                document.body.appendChild(tempAlert);
                
                setTimeout(() => {
                    document.body.removeChild(tempAlert);
                }, 5000);
            }
        }
        
        // Ø¥Ø¶Ø§ÙØ© style Ù„Ù„Ø¯ÙˆØ±Ø§Ù†
        const style = document.createElement('style');
        style.textContent = `
            .spinning {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

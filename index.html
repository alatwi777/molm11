<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الاختبارات - لوحة المعلم</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(to right, #1a237e, #283593);
            color: white;
            padding: 25px 40px;
            border-bottom: 5px solid #4a6fa5;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 36px;
            color: #4fc3f7;
        }
        
        .logo h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }
        
        .header-info {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .info-item i {
            color: #4fc3f7;
        }
        
        .test-header-form {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .header-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .header-form-group {
            margin-bottom: 10px;
        }
        
        .header-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e3f2fd;
            font-weight: 600;
            font-size: 14px;
        }
        
        .header-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            font-size: 15px;
            color: #333;
        }
        
        .tabs-container {
            background: #fff;
            border-bottom: 2px solid #e1e5eb;
            overflow-x: auto;
            display: flex;
        }
        
        .tabs {
            display: flex;
            min-width: max-content;
            padding: 0 40px;
        }
        
        .tab {
            padding: 20px 35px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #555;
            position: relative;
            white-space: nowrap;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            color: #1a237e;
            background: #f8f9fa;
        }
        
        .tab.active {
            color: #1a237e;
            border-bottom-color: #1a237e;
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-top: 5px solid #4a6fa5;
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card i {
            font-size: 40px;
            color: #4a6fa5;
            margin-bottom: 20px;
        }
        
        .dashboard-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 24px;
        }
        
        .dashboard-card p {
            margin: 0;
            color: #666;
            font-size: 15px;
        }
        
        .create-test-form {
            background: white;
            border-radius: 12px;
            padding: 35px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #1a237e;
            margin-top: 0;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f0fe;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 15px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a6fa5;
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        .datetime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .question-type-container {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .question-type-btn {
            padding: 12px 25px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-type-btn:hover {
            border-color: #4a6fa5;
            color: #4a6fa5;
        }
        
        .question-type-btn.active {
            border-color: #4a6fa5;
            background: #e8f0fe;
            color: #4a6fa5;
        }
        
        .options-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
        }
        
        .option-item input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .correct-option {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .essay-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ddd;
        }
        
        .essay-container textarea {
            min-height: 150px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #4a6fa5, #3a5a85);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #3a5a85, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 90, 133, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(to right, #28a745, #218838);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(to right, #218838, #1e7e34);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #dc3545, #c82333);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(to right, #c82333, #bd2130);
            transform: translateY(-2px);
        }
        
        .btn-excel {
            background: linear-gradient(to right, #1d6f42, #165a34);
            color: white;
        }
        
        .btn-excel:hover {
            background: linear-gradient(to right, #165a34, #0d4526);
            transform: translateY(-2px);
        }
        
        .btn-publish {
            background: linear-gradient(to right, #9c27b0, #7b1fa2);
            color: white;
        }
        
        .btn-publish:hover {
            background: linear-gradient(to right, #7b1fa2, #6a1b9a);
            transform: translateY(-2px);
        }
        
        .questions-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #e1e5eb;
            border-radius: 10px;
            background: #f8f9fa;
            margin-top: 25px;
        }
        
        .question-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4a6fa5;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .question-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .question-type-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .badge-mcq {
            background: #e8f0fe;
            color: #4a6fa5;
        }
        
        .badge-essay {
            background: #f3e5f5;
            color: #9c27b0;
        }
        
        .publish-controls {
            background: #e8f0fe;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #4a6fa5;
        }
        
        .publish-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .test-card {
            background: white;
            border: 1px solid #e1e5eb;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .test-card.published {
            border-color: #28a745;
            background: linear-gradient(to bottom right, #ffffff, #f8fff9);
        }
        
        .test-card.published::before {
            content: 'منشور';
            position: absolute;
            top: 15px;
            left: 15px;
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .test-card.draft::before {
            content: 'مسودة';
            position: absolute;
            top: 15px;
            left: 15px;
            background: #6c757d;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .test-card h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 22px;
        }
        
        .test-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .test-meta p {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 3px dashed #4a6fa5;
            border-radius: 12px;
            padding: 60px 30px;
            text-align: center;
            background: #f8fafc;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #e8f0fe;
            border-color: #3a5a85;
        }
        
        .students-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            border: 1px solid #e1e5eb;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .students-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .students-table th {
            background: #2c3e50;
            color: white;
            padding: 18px 15px;
            text-align: right;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .students-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #e1e5eb;
            text-align: right;
        }
        
        .alert {
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: none;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .answers-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .answers-content {
            background: white;
            border-radius: 15px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .student-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5eb;
        }

        .student-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .student-selector select {
            padding: 10px 15px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            min-width: 250px;
        }

        .question-answers-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-top: 20px;
        }

        .answer-view {
            background: white;
            border: 1px solid #e1e5eb;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .answer-type-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .mcq-answer {
            background: #e8f0fe;
            color: #4a6fa5;
        }

        .essay-answer {
            background: #f3e5f5;
            color: #9c27b0;
        }

        .student-answer {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e1e5eb;
        }

        .drawing-answer {
            background: white;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
        }

        .drawing-answer img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .grading-panel {
            background: #f8fff9;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            padding: 25px;
            position: sticky;
            top: 20px;
        }

        .grade-input {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .grade-input input {
            padding: 12px 15px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            width: 120px;
        }

        .total-score-card {
            background: linear-gradient(to right, #2c3e50, #4a6fa5);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .total-score {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .question-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .question-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #4a6fa5;
            background: white;
            color: #4a6fa5;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .question-nav-btn:hover {
            background: #4a6fa5;
            color: white;
        }

        .question-nav-btn.active {
            background: #4a6fa5;
            color: white;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .graded {
            background: #d4edda;
            color: #155724;
        }

        .pending {
            background: #fff3cd;
            color: #856404;
        }

        .correct-answer {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .wrong-answer {
            background: #f8d7da;
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .manual-grade-section {
            background: #e8f0fe;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #4a6fa5;
        }

        .grade-history {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        .grading-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pen-tools {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .pen-tool {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #ddd;
            background: white;
            font-weight: bold;
        }

        .pen-tool.active {
            border-color: #4a6fa5;
            background: #e8f0fe;
        }

        .btn-info {
            background: linear-gradient(to right, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(to right, #138496, #117a8b);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(to right, #ffc107, #e0a800);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(to right, #e0a800, #d39e00);
            transform: translateY(-2px);
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            justify-content: center;
        }

        .progress-bar-container {
            flex: 1;
            max-width: 300px;
            background: #e1e5eb;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #4a6fa5, #3a5a85);
            transition: width 0.3s;
        }

        .pen-tool-marker {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #4a6fa5;
            background: white;
            font-size: 24px;
            margin: 0 5px;
        }

        .pen-tool-marker.active {
            background: #e8f0fe;
            transform: scale(1.1);
        }

        .student-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e1e5eb;
        }

        .student-nav-btn {
            padding: 10px 20px;
            border: 2px solid #4a6fa5;
            background: white;
            color: #4a6fa5;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .student-nav-btn:hover {
            background: #4a6fa5;
            color: white;
        }

        .pen-touch-tool {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid #4a6fa5;
            background: white;
            font-size: 28px;
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .pen-touch-tool.active {
            background: #4a6fa5;
            color: white;
            transform: scale(1.1);
        }

        .grade-watermark {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(74, 111, 165, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .print-btn {
            position: fixed;
            top: 100px;
            left: 30px;
            background: #4a6fa5;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-modal-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #dc3545;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grade-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .grade-input-overlay {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            border: 3px solid #4a6fa5;
        }

        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
            
            .tabs {
                padding: 0 20px;
            }
            
            .tab-content {
                padding: 30px 20px;
            }

            .question-answers-container {
                grid-template-columns: 1fr;
            }
            
            .grading-panel {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }
            
            .header-top {
                flex-direction: column;
                text-align: center;
            }
            
            .header-info {
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
                width: 100%;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tests-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .student-nav {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .student-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .student-selector select {
                width: 100%;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="logo">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h1>نظام إدارة الاختبارات الإلكترونية</h1>
                </div>
                <div class="header-info">
                    <div class="info-item">
                        <i class="fas fa-user-tie"></i>
                        <span>لوحة تحكم المعلم</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="currentDate"></span>
                    </div>
                </div>
            </div>
            
            <div class="test-header-form">
                <div class="header-form-grid">
                    <div class="header-form-group">
                        <label><i class="fas fa-flag"></i> الدولة</label>
                        <input type="text" id="country" placeholder="المملكة العربية السعودية">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-building"></i> الإدارة</label>
                        <input type="text" id="administration" placeholder="إدارة التعليم">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-school"></i> المدرسة</label>
                        <input type="text" id="school" placeholder="اسم المدرسة">
                    </div>
                    <div class="header-form-group">
                        <label><i class="fas fa-book"></i> المادة</label>
                        <input type="text" id="subject" placeholder="اسم المادة">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</button>
                <button class="tab" onclick="switchTab('createTest')"><i class="fas fa-plus-circle"></i> إنشاء اختبار</button>
                <button class="tab" onclick="switchTab('manageStudents')"><i class="fas fa-users"></i> إدارة الطلاب</button>
                <button class="tab" onclick="switchTab('viewTests')"><i class="fas fa-clipboard-list"></i> الاختبارات</button>
                <button class="tab" onclick="switchTab('results')"><i class="fas fa-chart-bar"></i> النتائج</button>
            </div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <i class="fas fa-clipboard-list"></i>
                    <h3 id="totalTests">0</h3>
                    <p>إختبار منشور</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-users"></i>
                    <h3 id="totalStudents">0</h3>
                    <p>طالب مسجل</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-question-circle"></i>
                    <h3 id="totalQuestions">0</h3>
                    <p>سؤال مخزن</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-check-circle"></i>
                    <h3 id="completedTests">0</h3>
                    <p>إختبار مكتمل</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-edit"></i>
                    <h3 id="pendingGrading">0</h3>
                    <p>إجابات تحتاج تصحيح</p>
                </div>
            </div>
        </div>
        
        <div id="createTest" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> إنشاء اختبار جديد</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="testTitle"><i class="fas fa-heading"></i> عنوان الاختبار:</label>
                        <input type="text" id="testTitle" placeholder="أدخل عنوان واضح للاختبار">
                    </div>
                    
                    <div class="form-group">
                        <label for="testSubject"><i class="fas fa-book"></i> المادة الدراسية:</label>
                        <input type="text" id="testSubject" placeholder="مثل: الرياضيات، العلوم، اللغة العربية">
                    </div>
                    
                    <div class="form-group">
                        <label for="testDuration"><i class="fas fa-clock"></i> زمن الاختبار (دقائق):</label>
                        <input type="number" id="testDuration" min="1" value="45">
                    </div>
                    
                    <div class="form-group">
                        <label for="passingScore"><i class="fas fa-graduation-cap"></i> درجة النجاح (%):</label>
                        <input type="number" id="passingScore" min="0" max="100" value="60">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="testDescription"><i class="fas fa-align-left"></i> وصف الاختبار:</label>
                    <textarea id="testDescription" placeholder="صف محتوى الاختبار والأهداف التعليمية" rows="3"></textarea>
                </div>
                
                <h3 class="section-title"><i class="fas fa-calendar-alt"></i> توقيت الاختبار</h3>
                <div class="datetime-grid">
                    <div class="form-group">
                        <label for="startDate"><i class="fas fa-calendar-plus"></i> تاريخ البدء:</label>
                        <input type="datetime-local" id="startTime">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate"><i class="fas fa-calendar-minus"></i> تاريخ الانتهاء:</label>
                        <input type="datetime-local" id="endTime">
                    </div>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-question-circle"></i> إضافة سؤال جديد</h2>
                
                <div class="form-group">
                    <label><i class="fas fa-tasks"></i> نوع السؤال:</label>
                    <div class="question-type-container">
                        <button class="question-type-btn active" onclick="setQuestionType('mcq')">
                            <i class="fas fa-list-ol"></i> اختيار من متعدد
                        </button>
                        <button class="question-type-btn" onclick="setQuestionType('essay')">
                            <i class="fas fa-edit"></i> مقالي (رسم وكتابة)
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="questionText"><i class="fas fa-pencil-alt"></i> نص السؤال:</label>
                    <textarea id="questionText" placeholder="اكتب نص السؤال هنا..." rows="3"></textarea>
                </div>
                
                <div id="mcqOptions" class="options-container">
                    <label style="display: block; margin-bottom: 15px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-list-ol"></i> خيارات الإجابة:
                    </label>
                    <div id="optionsList">
                        <div class="option-item">
                            <input type="radio" name="correctOption" value="0" class="correct-option" checked>
                            <input type="text" class="option-input" placeholder="الخيار الأول">
                            <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="correctOption" value="1" class="correct-option">
                            <input type="text" class="option-input" placeholder="الخيار الثاني">
                            <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button onclick="addOption()" class="btn btn-secondary" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> إضافة خيار جديد
                    </button>
                </div>
                
                <div id="essayOptions" class="essay-container" style="display: none;">
                    <label style="display: block; margin-bottom: 15px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-edit"></i> تعليمات السؤال المقالي:
                    </label>
                    <textarea id="essayInstructions" placeholder="أدخل تعليمات الإجابة أو تركها فارغة..." rows="2"></textarea>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="questionPoints"><i class="fas fa-star"></i> درجة السؤال:</label>
                        <input type="number" id="questionPoints" min="1" value="5">
                    </div>
                </div>
                
                <button onclick="addQuestion()" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> إضافة السؤال إلى الاختبار
                </button>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-list-check"></i> الأسئلة المضافة (<span id="questionsCount">0</span>)</h2>
                
                <div id="questionsList" class="questions-list">
                    <p style="text-align: center; color: #666; padding: 40px;">لم تتم إضافة أي أسئلة بعد</p>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button onclick="saveTestAsDraft()" class="btn btn-success" id="saveTestBtn" disabled>
                        <i class="fas fa-save"></i> حفظ الاختبار (مسودة)
                    </button>
                    <button onclick="clearTest()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> مسح الكل
                    </button>
                </div>
            </div>
        </div>
        
        <div id="manageStudents" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-users"></i> إدارة الطلاب</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
                    <div style="background: #f3e5f5; padding: 25px; border-radius: 10px;">
                        <h3 style="margin-top: 0; color: #2c3e50;"><i class="fas fa-plus-circle"></i> إضافة طالب جديد</h3>
                        <div class="form-group">
                            <label for="studentSsn"><i class="fas fa-id-card"></i> السجل المدني:</label>
                            <input type="text" id="studentSsn" placeholder="10 أرقام على الأقل" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label for="studentName"><i class="fas fa-user"></i> الاسم الكامل:</label>
                            <input type="text" id="studentName" placeholder="الاسم ثلاثي">
                        </div>
                        <button onclick="addStudent()" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> إضافة طالب
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-file-import"></i> استيراد الطلاب من Excel</h2>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-excel"></i>
                    <h3>انقر لرفع ملف Excel</h3>
                    <p>اسحب وأسقط ملف Excel هنا أو انقر للاختيار</p>
                    <p style="color: #4a6fa5; font-weight: 600;">
                        <i class="fas fa-download"></i> 
                        <a href="#" onclick="downloadTemplate()" style="color: #2c3e50; text-decoration: none;">تحميل ملف نموذج</a>
                    </p>
                </div>
                
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleExcelImport(event)" style="display: none;">
                
                <div id="importAlert" class="alert"></div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button onclick="exportToExcel()" class="btn btn-excel">
                        <i class="fas fa-file-export"></i> تصدير إلى Excel
                    </button>
                    <button onclick="clearAllStudents()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> حذف جميع الطلاب
                    </button>
                </div>
            </div>
            
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-list"></i> قائمة الطلاب (<span id="studentsCount">0</span>)</h2>
                
                <div id="studentsTableContainer">
                    <p style="text-align: center; color: #666; padding: 40px;">لا توجد طلاب مسجلين بعد</p>
                </div>
            </div>
        </div>
        
        <div id="viewTests" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> الاختبارات</h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button onclick="filterTests('all')" class="btn btn-secondary">
                        <i class="fas fa-list"></i> الكل
                    </button>
                    <button onclick="filterTests('published')" class="btn btn-success">
                        <i class="fas fa-check-circle"></i> المنشورة
                    </button>
                    <button onclick="filterTests('draft')" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> المسودة
                    </button>
                    <button onclick="filterTests('active')" class="btn btn-primary">
                        <i class="fas fa-play-circle"></i> النشطة الآن
                    </button>
                </div>
                
                <div id="testsList" class="tests-grid">
                </div>
            </div>
        </div>
        
        <div id="results" class="tab-content">
            <div class="create-test-form">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> نتائج الاختبارات</h2>
                
                <div id="resultsContainer">
                    <p style="text-align: center; color: #666; padding: 60px;">لا توجد نتائج متاحة بعد</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTest = {
            id: '',
            title: '',
            subject: '',
            description: '',
            duration: 45,
            passingScore: 60,
            startTime: '',
            endTime: '',
            questions: [],
            createdAt: '',
            isPublished: false,
            publishedAt: '',
            status: 'draft'
        };
        
        let studentsList = [];
        let testsList = [];
        let resultsList = [];
        let currentQuestionType = 'mcq';
        
        let currentGradingTest = null;
        let currentGradingStudent = null;
        let currentGradingAnswers = null;
        let currentQuestionIdx = 0;
        let manualGrades = {};
        let currentStudentIndex = 0;
        let gradingResults = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            setDefaultDates();
            loadAllData();
            updateDashboard();
            loadHeaderData();
        });
        
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('ar-SA', options);
        }
        
        function setDefaultDates() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const formatDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            document.getElementById('startTime').value = formatDateTime(now);
            document.getElementById('endTime').value = formatDateTime(tomorrow);
        }
        
        function loadHeaderData() {
            const savedCountry = localStorage.getItem('teacher_country');
            const savedAdmin = localStorage.getItem('teacher_administration');
            const savedSchool = localStorage.getItem('teacher_school');
            const savedSubject = localStorage.getItem('teacher_subject');
            
            if (savedCountry) document.getElementById('country').value = savedCountry;
            if (savedAdmin) document.getElementById('administration').value = savedAdmin;
            if (savedSchool) document.getElementById('school').value = savedSchool;
            if (savedSubject) document.getElementById('subject').value = savedSubject;
        }
        
        function saveHeaderData() {
            const country = document.getElementById('country').value;
            const administration = document.getElementById('administration').value;
            const school = document.getElementById('school').value;
            const subject = document.getElementById('subject').value;
            
            localStorage.setItem('teacher_country', country);
            localStorage.setItem('teacher_administration', administration);
            localStorage.setItem('teacher_school', school);
            localStorage.setItem('teacher_subject', subject);
        }
        
        function loadAllData() {
            try {
                studentsList = JSON.parse(localStorage.getItem('teacher_students')) || [];
                testsList = JSON.parse(localStorage.getItem('teacher_tests')) || [];
                resultsList = JSON.parse(localStorage.getItem('teacher_results')) || [];
                
                updateStudentsTable();
                updateTestsList();
                updateResultsList();
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showAlert('حدث خطأ في تحميل البيانات', 'error');
            }
        }
        
        function updateDashboard() {
            try {
                document.getElementById('totalTests').textContent = 
                    testsList.filter(t => t.isPublished).length;
                document.getElementById('totalStudents').textContent = studentsList.length;
                
                let totalQuestions = 0;
                testsList.forEach(test => {
                    totalQuestions += test.questions.length;
                });
                document.getElementById('totalQuestions').textContent = totalQuestions;
                
                document.getElementById('completedTests').textContent = resultsList.length;
                
                let pendingGrading = 0;
                resultsList.forEach(result => {
                    if (result.needsManualGrading && !result.isManuallyGraded) {
                        pendingGrading++;
                    }
                });
                document.getElementById('pendingGrading').textContent = pendingGrading;
            } catch (error) {
                console.error('خطأ في تحديث لوحة التحكم:', error);
            }
        }
        
        function switchTab(tabName) {
            try {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');
                
                if (tabName === 'viewTests') {
                    updateTestsList();
                } else if (tabName === 'results') {
                    updateResultsList();
                }
            } catch (error) {
                console.error('خطأ في تبديل التبويبات:', error);
            }
        }
        
        function setQuestionType(type) {
            currentQuestionType = type;
            
            document.querySelectorAll('.question-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (type === 'mcq') {
                document.getElementById('mcqOptions').style.display = 'block';
                document.getElementById('essayOptions').style.display = 'none';
            } else {
                document.getElementById('mcqOptions').style.display = 'none';
                document.getElementById('essayOptions').style.display = 'block';
            }
        }
        
        function addOption() {
            const optionsList = document.getElementById('optionsList');
            const optionCount = optionsList.children.length;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'option-item';
            optionItem.innerHTML = `
                <input type="radio" name="correctOption" value="${optionCount}" class="correct-option">
                <input type="text" class="option-input" placeholder="الخيار ${optionCount + 1}">
                <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            optionsList.appendChild(optionItem);
        }
        
        function removeOption(button) {
            const optionsList = document.getElementById('optionsList');
            if (optionsList.children.length > 2) {
                button.closest('.option-item').remove();
            } else {
                showAlert('يجب أن يحتوي السؤال على خيارين على الأقل', 'error');
            }
        }
        
        function addQuestion() {
            try {
                const questionText = document.getElementById('questionText').value.trim();
                const questionPoints = parseInt(document.getElementById('questionPoints').value) || 1;
                
                if (!questionText) {
                    showAlert('يرجى إدخال نص السؤال', 'error');
                    return;
                }
                
                let question;
                
                if (currentQuestionType === 'mcq') {
                    const options = [];
                    const optionInputs = document.querySelectorAll('.option-input');
                    optionInputs.forEach(input => {
                        if (input.value.trim() !== '') {
                            options.push(input.value.trim());
                        }
                    });
                    
                    if (options.length < 2) {
                        showAlert('يجب إدخال خيارين على الأقل', 'error');
                        return;
                    }
                    
                    const correctAnswer = parseInt(document.querySelector('input[name="correctOption"]:checked').value);
                    
                    question = {
                        id: Date.now(),
                        type: 'mcq',
                        text: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        points: questionPoints
                    };
                    
                } else {
                    const essayInstructions = document.getElementById('essayInstructions').value.trim();
                    
                    question = {
                        id: Date.now(),
                        type: 'essay',
                        text: questionText,
                        instructions: essayInstructions,
                        points: questionPoints
                    };
                }
                
                currentTest.questions.push(question);
                
                updateQuestionsList();
                
                document.getElementById('saveTestBtn').disabled = false;
                
                document.getElementById('questionText').value = '';
                document.getElementById('essayInstructions').value = '';
                
                if (currentQuestionType === 'mcq') {
                    document.querySelectorAll('.option-input').forEach(input => {
                        input.value = '';
                    });
                    document.querySelectorAll('input[name="correctOption"]')[0].checked = true;
                }
                
                showAlert('تمت إضافة السؤال بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في إضافة السؤال:', error);
                showAlert('حدث خطأ في إضافة السؤال', 'error');
            }
        }
        
        function updateQuestionsList() {
            try {
                const container = document.getElementById('questionsList');
                const countElement = document.getElementById('questionsCount');
                
                if (currentTest.questions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">لم تتم إضافة أي أسئلة بعد</p>';
                    countElement.textContent = '0';
                    return;
                }
                
                let html = '';
                currentTest.questions.forEach((question, index) => {
                    html += `
                        <div class="question-card">
                            <span class="question-type-badge ${question.type === 'mcq' ? 'badge-mcq' : 'badge-essay'}">
                                ${question.type === 'mcq' ? 'اختيار من متعدد' : 'مقالي'}
                            </span>
                            <h4>سؤال ${index + 1}: ${question.text}</h4>
                            <p><strong>الدرجة:</strong> ${question.points}</p>
                    `;
                    
                    if (question.type === 'mcq') {
                        html += '<div style="margin-top: 15px;">';
                        question.options.forEach((option, optIndex) => {
                            const isCorrect = optIndex === question.correctAnswer;
                            html += `
                                <div style="padding: 10px; margin-bottom: 8px; background: ${isCorrect ? '#d4edda' : '#f8f9fa'}; 
                                     border-radius: 5px; border-right: 3px solid ${isCorrect ? '#28a745' : '#ddd'};">
                                    ${option} ${isCorrect ? ' ✓' : ''}
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html += `<p><strong>التعليمات:</strong> ${question.instructions || 'بدون تعليمات'}</p>`;
                    }
                    
                    html += `
                            <button onclick="removeQuestion(${index})" class="btn btn-danger" style="padding: 8px 15px; font-size: 14px; margin-top: 15px;">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                countElement.textContent = currentTest.questions.length;
            } catch (error) {
                console.error('خطأ في تحديث قائمة الأسئلة:', error);
                showAlert('حدث خطأ في تحديث قائمة الأسئلة', 'error');
            }
        }
        
        function removeQuestion(index) {
            try {
                if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
                    currentTest.questions.splice(index, 1);
                    updateQuestionsList();
                    
                    if (currentTest.questions.length === 0) {
                        document.getElementById('saveTestBtn').disabled = true;
                    }
                }
            } catch (error) {
                console.error('خطأ في حذف السؤال:', error);
                showAlert('حدث خطأ في حذف السؤال', 'error');
            }
        }
        
        function saveTestAsDraft() {
            try {
                saveHeaderData();
                
                currentTest.title = document.getElementById('testTitle').value.trim();
                currentTest.subject = document.getElementById('testSubject').value.trim();
                currentTest.description = document.getElementById('testDescription').value.trim();
                currentTest.duration = parseInt(document.getElementById('testDuration').value) || 45;
                currentTest.passingScore = parseInt(document.getElementById('passingScore').value) || 60;
                
                currentTest.startTime = document.getElementById('startTime').value;
                currentTest.endTime = document.getElementById('endTime').value;
                
                if (!currentTest.title || !currentTest.subject || currentTest.questions.length === 0) {
                    showAlert('يرجى إدخال عنوان الاختبار والمادة وإضافة أسئلة على الأقل', 'error');
                    return;
                }
                
                if (!currentTest.startTime || !currentTest.endTime) {
                    showAlert('يرجى تحديد توقيت بدء وانتهاء الاختبار', 'error');
                    return;
                }
                
                const start = new Date(currentTest.startTime);
                const end = new Date(currentTest.endTime);
                
                if (start >= end) {
                    showAlert('وقت الانتهاء يجب أن يكون بعد وقت البدء', 'error');
                    return;
                }
                
                currentTest.id = 'TEST-' + Date.now();
                currentTest.createdAt = new Date().toISOString();
                currentTest.isPublished = false;
                currentTest.status = 'draft';
                
                testsList.push(JSON.parse(JSON.stringify(currentTest)));
                localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                
                showAlert('تم حفظ الاختبار كمسودة بنجاح! انتقل إلى تبويب "الاختبارات" لمشاهدته وإرساله للطلاب', 'success');
                
                updateDashboard();
                
                switchTab('viewTests');
                
                resetTestForm();
                
            } catch (error) {
                console.error('خطأ في حفظ الاختبار:', error);
                showAlert('حدث خطأ في حفظ الاختبار', 'error');
            }
        }
        
        function clearTest() {
            try {
                if (confirm('هل أنت متأكد من حذف جميع الأسئلة؟')) {
                    currentTest.questions = [];
                    updateQuestionsList();
                    document.getElementById('saveTestBtn').disabled = true;
                }
            } catch (error) {
                console.error('خطأ في مسح الأسئلة:', error);
                showAlert('حدث خطأ في مسح الأسئلة', 'error');
            }
        }
        
        function resetTestForm() {
            document.getElementById('testTitle').value = '';
            document.getElementById('testSubject').value = '';
            document.getElementById('testDescription').value = '';
            document.getElementById('testDuration').value = '45';
            document.getElementById('passingScore').value = '60';
            document.getElementById('questionText').value = '';
            document.getElementById('questionPoints').value = '5';
            document.getElementById('essayInstructions').value = '';
            
            const container = document.getElementById('optionsList');
            container.innerHTML = `
                <div class="option-item">
                    <input type="radio" name="correctOption" value="0" class="correct-option" checked>
                    <input type="text" class="option-input" placeholder="الخيار الأول">
                    <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="option-item">
                    <input type="radio" name="correctOption" value="1" class="correct-option">
                    <input type="text" class="option-input" placeholder="الخيار الثاني">
                    <button onclick="removeOption(this)" class="btn btn-danger" style="padding: 8px 15px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            currentTest = {
                id: '',
                title: '',
                subject: '',
                description: '',
                duration: 45,
                passingScore: 60,
                startTime: '',
                endTime: '',
                questions: [],
                createdAt: '',
                isPublished: false,
                publishedAt: '',
                status: 'draft'
            };
            
            updateQuestionsList();
            document.getElementById('saveTestBtn').disabled = true;
        }
        
        function sendTestToStudents(testIndex) {
            try {
                if (!testsList[testIndex]) {
                    showAlert('لم يتم العثور على الاختبار', 'error');
                    return;
                }
                
                if (studentsList.length === 0) {
                    showAlert('لا يوجد طلاب مسجلين لإرسال الاختبار لهم. يرجى إضافة طلاب أولاً', 'error');
                    return;
                }
                
                testsList[testIndex].isPublished = true;
                testsList[testIndex].publishedAt = new Date().toISOString();
                testsList[testIndex].status = 'published';
                
                localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                
                showAlert(`تم إرسال الاختبار "${testsList[testIndex].title}" للطلاب بنجاح!`, 'success');
                
                updateTestsList();
                updateDashboard();
                
            } catch (error) {
                console.error('خطأ في إرسال الاختبار:', error);
                showAlert('حدث خطأ في إرسال الاختبار', 'error');
            }
        }
        
        function addStudent() {
            try {
                const ssn = document.getElementById('studentSsn').value.trim();
                const name = document.getElementById('studentName').value.trim();
                
                if (!ssn || !name) {
                    showAlert('يرجى إدخال السجل المدني والاسم', 'error');
                    return;
                }
                
                if (ssn.length < 10) {
                    showAlert('رقم السجل المدني يجب أن يكون 10 أرقام على الأقل', 'error');
                    return;
                }
                
                if (studentsList.some(student => student.ssn === ssn)) {
                    showAlert('رقم السجل المدني مسجل مسبقاً', 'error');
                    return;
                }
                
                const student = {
                    id: 'STU-' + Date.now(),
                    ssn: ssn,
                    name: name,
                    registeredAt: new Date().toLocaleString('ar-SA')
                };
                
                studentsList.push(student);
                localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                
                updateStudentsTable();
                
                document.getElementById('studentSsn').value = '';
                document.getElementById('studentName').value = '';
                
                showAlert('تمت إضافة الطالب بنجاح', 'success');
                updateDashboard();
            } catch (error) {
                console.error('خطأ في إضافة الطالب:', error);
                showAlert('حدث خطأ في إضافة الطالب', 'error');
            }
        }
        
        function updateStudentsTable() {
            try {
                const container = document.getElementById('studentsTableContainer');
                const countElement = document.getElementById('studentsCount');
                
                if (studentsList.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">لا توجد طلاب مسجلين بعد</p>';
                    countElement.textContent = '0';
                    return;
                }
                
                let html = `
                    <div class="students-table-container">
                        <table class="students-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>رقم السجل المدني</th>
                                    <th>اسم الطالب</th>
                                    <th>تاريخ التسجيل</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                studentsList.forEach((student, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${student.ssn}</strong></td>
                            <td>${student.name}</td>
                            <td>${student.registeredAt}</td>
                            <td>
                                <button onclick="editStudent(${index})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteStudent(${index})" class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                countElement.textContent = studentsList.length;
            } catch (error) {
                console.error('خطأ في تحديث جدول الطلاب:', error);
                showAlert('حدث خطأ في تحديث جدول الطلاب', 'error');
            }
        }
        
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showAlert('الملف لا يحتوي على بيانات', 'error');
                        return;
                    }
                    
                    const importedStudents = [];
                    const duplicates = [];
                    
                    jsonData.forEach(row => {
                        const ssn = row['السجل المدني'] || row['ssn'] || row['رقم'] || '';
                        const name = row['الاسم'] || row['name'] || '';
                        
                        if (ssn && name) {
                            const ssnStr = ssn.toString().trim();
                            const nameStr = name.toString().trim();
                            
                            const isDuplicate = studentsList.some(s => s.ssn === ssnStr);
                            if (!isDuplicate) {
                                importedStudents.push({
                                    id: 'STU-' + Date.now() + Math.random(),
                                    ssn: ssnStr,
                                    name: nameStr,
                                    registeredAt: new Date().toLocaleString('ar-SA')
                                });
                            } else {
                                duplicates.push(ssnStr);
                            }
                        }
                    });
                    
                    studentsList = studentsList.concat(importedStudents);
                    localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                    
                    updateStudentsTable();
                    
                    let message = `تم استيراد ${importedStudents.length} طالب بنجاح`;
                    if (duplicates.length > 0) {
                        message += ` (تم تجاهل ${duplicates.length} طالب مكرر)`;
                    }
                    
                    showAlert(message, 'success');
                    updateDashboard();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('حدث خطأ في قراءة الملف. تأكد من صحة التنسيق', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function downloadTemplate() {
            const templateData = [
                { 'السجل المدني': '1011121314', 'الاسم': 'أحمد محمد علي' },
                { 'السجل المدني': '2011121315', 'الاسم': 'سارة خالد حسن' },
                { 'السجل المدني': '3011121316', 'الاسم': 'علي سعيد محمود' }
            ];
            
            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'الطلاب');
            
            XLSX.writeFile(workbook, 'نموذج_قائمة_الطلاب.xlsx');
        }
        
        function exportToExcel() {
            try {
                if (studentsList.length === 0) {
                    showAlert('لا توجد بيانات للتصدير', 'error');
                    return;
                }
                
                const exportData = studentsList.map(s => ({
                    'السجل المدني': s.ssn,
                    'الاسم': s.name,
                    'تاريخ التسجيل': s.registeredAt
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'قائمة الطلاب');
                
                XLSX.writeFile(workbook, 'قائمة_الطلاب_المسجلين.xlsx');
            } catch (error) {
                console.error('خطأ في التصدير:', error);
                showAlert('حدث خطأ في التصدير', 'error');
            }
        }
        
        function editStudent(index) {
            try {
                const student = studentsList[index];
                
                const newName = prompt('تعديل اسم الطالب:', student.name);
                if (newName !== null) student.name = newName;
                
                const newSsn = prompt('تعديل السجل المدني:', student.ssn);
                if (newSsn !== null) student.ssn = newSsn;
                
                localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                updateStudentsTable();
            } catch (error) {
                console.error('خطأ في تحرير الطالب:', error);
                showAlert('حدث خطأ في تحرير الطالب', 'error');
            }
        }
        
        function deleteStudent(index) {
            try {
                if (confirm('هل أنت متأكد من حذف هذا الطالب؟')) {
                    studentsList.splice(index, 1);
                    localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                    updateStudentsTable();
                    updateDashboard();
                }
            } catch (error) {
                console.error('خطأ في حذف الطالب:', error);
                showAlert('حدث خطأ في حذف الطالب', 'error');
            }
        }
        
        function clearAllStudents() {
            try {
                if (studentsList.length === 0) {
                    showAlert('لا توجد بيانات طلاب للحذف', 'error');
                    return;
                }
                
                if (confirm('هل أنت متأكد من حذف جميع الطلاب؟')) {
                    studentsList = [];
                    localStorage.setItem('teacher_students', JSON.stringify(studentsList));
                    updateStudentsTable();
                    updateDashboard();
                    showAlert('تم حذف جميع الطلاب', 'success');
                }
            } catch (error) {
                console.error('خطأ في حذف الطلاب:', error);
                showAlert('حدث خطأ في حذف الطلاب', 'error');
            }
        }
        
        function filterTests(type) {
            updateTestsList(type);
        }
        
        function updateTestsList(filter = 'all') {
            try {
                const container = document.getElementById('testsList');
                
                let filteredTests = testsList;
                
                if (filter === 'published') {
                    filteredTests = testsList.filter(t => t.isPublished);
                } else if (filter === 'draft') {
                    filteredTests = testsList.filter(t => !t.isPublished);
                } else if (filter === 'active') {
                    const now = new Date();
                    filteredTests = testsList.filter(t => {
                        if (!t.isPublished) return false;
                        const start = new Date(t.startTime);
                        const end = new Date(t.endTime);
                        return now >= start && now <= end;
                    });
                }
                
                if (filteredTests.length === 0) {
                    let message = 'لا توجد اختبارات';
                    if (filter === 'published') message = 'لا توجد اختبارات منشورة';
                    else if (filter === 'draft') message = 'لا توجد اختبارات مسودة';
                    else if (filter === 'active') message = 'لا توجد اختبارات نشطة الآن';
                    
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; grid-column: 1/-1;">
                            <i class="fas fa-clipboard" style="font-size: 60px; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">${message}</h3>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                filteredTests.forEach((test, index) => {
                    const start = new Date(test.startTime);
                    const end = new Date(test.endTime);
                    const now = new Date();
                    const isActive = now >= start && now <= end && test.isPublished;
                    
                    const studentCount = resultsList.filter(r => r.testId === test.id).length;
                    const needsGrading = resultsList.some(r => 
                        r.testId === test.id && r.needsManualGrading && !r.isManuallyGraded
                    );
                    
                    html += `
                        <div class="test-card ${test.isPublished ? 'published' : 'draft'}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <h3>${test.title}</h3>
                                ${isActive ? 
                                    '<span style="background: #4a6fa5; color: white; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">نشط الآن</span>' : 
                                    ''
                                }
                                ${needsGrading ? 
                                    '<span style="background: #ffc107; color: white; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;">يحتاج تصحيح</span>' : 
                                    ''
                                }
                            </div>
                            <p style="color: #666; margin-bottom: 15px;">${test.description || 'بدون وصف'}</p>
                            <div class="test-meta">
                                <p><i class="fas fa-book"></i> المادة: ${test.subject}</p>
                                <p><i class="fas fa-clock"></i> المدة: ${test.duration} دقيقة</p>
                                <p><i class="fas fa-graduation-cap"></i> النجاح: ${test.passingScore}%</p>
                                <p><i class="fas fa-question-circle"></i> الأسئلة: ${test.questions.length}</p>
                                <p><i class="fas fa-calendar-alt"></i> البدء: ${start.toLocaleString('ar-SA')}</p>
                                <p><i class="fas fa-calendar-times"></i> الانتهاء: ${end.toLocaleString('ar-SA')}</p>
                                <p><i class="fas fa-users"></i> أداء الاختبار: ${studentCount} طالب</p>
                                <p><i class="fas fa-calendar"></i> الإنشاء: ${new Date(test.createdAt).toLocaleString('ar-SA')}</p>
                                <p><i class="fas fa-info-circle"></i> الحالة: ${test.isPublished ? 'منشور' : 'مسودة'}</p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button onclick="viewTestDetails(${index})" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> عرض
                                </button>
                                <button onclick="deleteTest(${index})" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                                ${!test.isPublished ? 
                                    `<button onclick="sendTestToStudents(${index})" class="btn btn-publish">
                                        <i class="fas fa-paper-plane"></i> إرسال للطلاب
                                    </button>` : 
                                    ''
                                }
                                ${studentCount > 0 ? 
                                    `<button onclick="viewTestResults('${test.id}')" class="btn btn-success">
                                        <i class="fas fa-chart-bar"></i> النتائج
                                    </button>` : 
                                    ''
                                }
                                ${studentCount > 0 ? 
                                    `<button onclick="viewStudentAnswers('${test.id}')" class="btn btn-info">
                                        <i class="fas fa-edit"></i> تصحيح الإجابات
                                    </button>` : 
                                    ''
                                }
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحديث قائمة الاختبارات:', error);
                showAlert('حدث خطأ في تحديث قائمة الاختبارات', 'error');
            }
        }
        
        function publishExistingTest(index) {
            try {
                if (testsList[index]) {
                    testsList[index].isPublished = true;
                    testsList[index].publishedAt = new Date().toISOString();
                    localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                    
                    showAlert('تم نشر الاختبار بنجاح!', 'success');
                    updateTestsList();
                    updateDashboard();
                }
            } catch (error) {
                console.error('خطأ في نشر الاختبار:', error);
                showAlert('حدث خطأ في نشر الاختبار', 'error');
            }
        }
        
        function viewTestDetails(index) {
            try {
                const test = testsList[index];
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 1000; padding: 20px;
                    backdrop-filter: blur(5px);
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                        <button class="close-modal-btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">✖</button>
                        
                        <h2 style="margin: 0 0 25px 0; color: #1a237e; text-align: center;">${test.title}</h2>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                            <button onclick="printTestDetails(${index})" class="btn btn-primary" style="padding: 10px 20px;">
                                <i class="fas fa-print"></i> طباعة الاختبار
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #e8f0fe; padding: 20px; border-radius: 10px;">
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>المادة:</strong> ${test.subject}</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>زمن الاختبار:</strong> ${test.duration} دقيقة</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>درجة النجاح:</strong> ${test.passingScore}%</p>
                            </div>
                            <div style="background: #f3e5f5; padding: 20px; border-radius: 10px;">
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>تاريخ البدء:</strong> ${new Date(test.startTime).toLocaleString('ar-SA')}</p>
                                <p style="margin: 0 0 10px 0; color: #2c3e50;"><strong>تاريخ الانتهاء:</strong> ${new Date(test.endTime).toLocaleString('ar-SA')}</p>
                                <p style="margin: 0; color: #2c3e50;"><strong>الحالة:</strong> ${test.isPublished ? 'منشور' : 'مسودة'}</p>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
                            <h3 style="margin-top: 0; color: #2c3e50;">وصف الاختبار:</h3>
                            <p style="color: #666; line-height: 1.6;">${test.description || 'بدون وصف'}</p>
                        </div>
                        
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">الأسئلة (${test.questions.length})</h3>
                        ${test.questions.map((q, i) => `
                            <div style="background: white; padding: 25px; border-radius: 10px; margin: 15px 0; border: 1px solid #e1e5eb; border-right: 5px solid ${q.type === 'mcq' ? '#4a6fa5' : '#9c27b0'}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: #2c3e50;">سؤال ${i+1}: ${q.text}</h4>
                                    <span style="background: ${q.type === 'mcq' ? '#e8f0fe' : '#f3e5f5'}; 
                                          color: ${q.type === 'mcq' ? '#4a6fa5' : '#9c27b0'}; 
                                          padding: 5px 15px; border-radius: 20px; font-size: 13px;">
                                        ${q.type === 'mcq' ? 'اختيار من متعدد' : 'مقالي'}
                                    </span>
                                </div>
                                <p style="color: #666; margin-bottom: 15px;"><strong>الدرجة:</strong> ${q.points}</p>
                                
                                ${q.type === 'mcq' ? `
                                    <div style="margin-top: 15px;">
                                        ${q.options.map((opt, j) => `
                                            <div style="padding: 12px; margin-bottom: 10px; background: ${j === q.correctAnswer ? '#d4edda' : '#f8f9fa'}; 
                                                 border-radius: 8px; border-right: 3px solid ${j === q.correctAnswer ? '#28a745' : '#ddd'};">
                                                ${opt} ${j === q.correctAnswer ? ' ✓ الإجابة الصحيحة' : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p style="color: #666;"><strong>تعليمات الإجابة:</strong> ${q.instructions || 'بدون تعليمات'}</p>
                                `}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('خطأ في عرض تفاصيل الاختبار:', error);
                showAlert('حدث خطأ في عرض تفاصيل الاختبار', 'error');
            }
        }
        
        function deleteTest(index) {
            try {
                if (confirm('هل أنت متأكد من حذف هذا الاختبار؟')) {
                    testsList.splice(index, 1);
                    localStorage.setItem('teacher_tests', JSON.stringify(testsList));
                    updateTestsList();
                    updateDashboard();
                    showAlert('تم حذف الاختبار', 'success');
                }
            } catch (error) {
                console.error('خطأ في حذف الاختبار:', error);
                showAlert('حدث خطأ في حذف الاختبار', 'error');
            }
        }
        
        function viewTestResults(testId) {
            try {
                const testResults = resultsList.filter(r => r.testId === testId);
                const test = testsList.find(t => t.id === testId);
                
                if (!testResults.length) {
                    showAlert('لا توجد نتائج لهذا الاختبار', 'error');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 1000; padding: 20px;
                    backdrop-filter: blur(5px);
                `;
                
                let resultsHtml = '';
                testResults.forEach((result, i) => {
                    const finalScore = result.isManuallyGraded ? result.finalScore : result.score;
                    const finalTotal = result.total;
                    const finalPercentage = result.isManuallyGraded ? result.finalPercentage : result.percentage;
                    const passed = finalPercentage >= (test?.passingScore || 60);
                    
                    resultsHtml += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${result.studentName}</td>
                            <td>${result.studentSsn}</td>
                            <td>${finalScore}/${finalTotal}</td>
                            <td>${finalPercentage}%</td>
                            <td>
                                <span style="background: ${passed ? '#d4edda' : '#f8d7da'}; 
                                      color: ${passed ? '#155724' : '#721c24'}; 
                                      padding: 5px 15px; border-radius: 20px; font-size: 13px;">
                                    ${passed ? 'ناجح' : 'راسب'}
                                </span>
                                ${result.isManuallyGraded ? 
                                    '<span style="background: #e8f0fe; color: #4a6fa5; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 5px;">يدوي</span>' : 
                                    ''
                                }
                                ${result.needsManualGrading && !result.isManuallyGraded ? 
                                    '<span style="background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 5px;">يحتاج تصحيح</span>' : 
                                    ''
                                }
                            </td>
                            <td>${new Date(result.completedAt).toLocaleString('ar-SA')}</td>
                            <td>
                                <button onclick="viewStudentSpecificAnswers('${testId}', '${result.studentSsn}')" class="btn btn-info" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                const avgPercentage = testResults.reduce((sum, r) => {
                    const percentage = r.isManuallyGraded ? r.finalPercentage : r.percentage;
                    return sum + percentage;
                }, 0) / testResults.length;
                
                const passRate = (testResults.filter(r => {
                    const percentage = r.isManuallyGraded ? r.finalPercentage : r.percentage;
                    return percentage >= (test?.passingScore || 60);
                }).length / testResults.length) * 100;
                
                const needsGradingCount = testResults.filter(r => r.needsManualGrading && !result.isManuallyGraded).length;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                        <button class="close-modal-btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">✖</button>
                        
                        <h2 style="margin: 0 0 25px 0; color: #1a237e; text-align: center;">نتائج اختبار: ${test ? test.title : 'غير معروف'}</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #e8f0fe; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">عدد الطلاب</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #4a6fa5; margin: 0;">${testResults.length}</p>
                            </div>
                            <div style="background: #f3e5f5; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">متوسط النسبة</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #9c27b0; margin: 0;">${avgPercentage.toFixed(1)}%</p>
                            </div>
                            <div style="background: #e8f5e9; padding: 25px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">نسبة النجاح</h3>
                                <p style="font-size: 32px; font-weight: bold; color: #28a745; margin: 0;">${passRate.toFixed(1)}%</p>
                            </div>
                            ${needsGradingCount > 0 ? `
                                <div style="background: #fff3cd; padding: 25px; border-radius: 10px; text-align: center;">
                                    <h3 style="margin: 0 0 10px 0; color: #856404;">يحتاج تصحيح</h3>
                                    <p style="font-size: 32px; font-weight: bold; color: #ffc107; margin: 0;">${needsGradingCount}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 15px; text-align: right;">#</th>
                                        <th style="padding: 15px; text-align: right;">اسم الطالب</th>
                                        <th style="padding: 15px; text-align: right;">السجل المدني</th>
                                        <th style="padding: 15px; text-align: right;">الدرجة</th>
                                        <th style="padding: 15px; text-align: right;">النسبة</th>
                                        <th style="padding: 15px; text-align: right;">الحالة</th>
                                        <th style="padding: 15px; text-align: right;">تاريخ الإكمال</th>
                                        <th style="padding: 15px; text-align: right;">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${resultsHtml}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportResultsToExcel('${testId}')" class="btn btn-excel" style="padding: 12px 25px;">
                                <i class="fas fa-file-export"></i> تصدير إلى Excel
                            </button>
                            <button onclick="viewStudentAnswers('${testId}')" class="btn btn-info" style="padding: 12px 25px;">
                                <i class="fas fa-edit"></i> تصحيح الإجابات
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('خطأ في عرض النتائج:', error);
                showAlert('حدث خطأ في عرض النتائج', 'error');
            }
        }
        
        function exportResultsToExcel(testId) {
            try {
                const testResults = resultsList.filter(r => r.testId === testId);
                const test = testsList.find(t => t.id === testId);
                
                if (!testResults.length) return;
                
                const exportData = testResults.map((r, i) => ({
                    'م': i + 1,
                    'اسم الطالب': r.studentName,
                    'السجل المدني': r.studentSsn,
                    'الدرجة': r.isManuallyGraded ? `${r.finalScore}/${r.total}` : `${r.score}/${r.total}`,
                    'النسبة': r.isManuallyGraded ? `${r.finalPercentage}%` : `${r.percentage}%`,
                    'الحالة': (r.isManuallyGraded ? r.finalPercentage : r.percentage) >= (test?.passingScore || 60) ? 'ناجح' : 'راسب',
                    'نوع التصحيح': r.isManuallyGraded ? 'يدوي' : 'تلقائي',
                    'تاريخ الإكمال': new Date(r.completedAt).toLocaleString('ar-SA')
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'النتائج');
                
                const testTitle = test ? test.title.replace(/[^\w\u0600-\u06FF]/g, '_') : 'نتائج';
                XLSX.writeFile(workbook, `${testTitle}_النتائج.xlsx`);
                
                showAlert('تم تصدير النتائج بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير النتائج:', error);
                showAlert('حدث خطأ في تصدير النتائج', 'error');
            }
        }
        
        function updateResultsList() {
            try {
                const container = document.getElementById('resultsContainer');
                
                if (resultsList.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 60px;">لا توجد نتائج متاحة بعد</p>';
                    return;
                }
                
                const resultsByTest = {};
                resultsList.forEach(result => {
                    if (!resultsByTest[result.testId]) {
                        resultsByTest[result.testId] = [];
                    }
                    resultsByTest[result.testId].push(result);
                });
                
                let html = '';
                Object.keys(resultsByTest).forEach(testId => {
                    const testResults = resultsByTest[testId];
                    const test = testsList.find(t => t.id === testId);
                    
                    if (!test) return;
                    
                    const avgPercentage = testResults.reduce((sum, r) => {
                        const percentage = r.isManuallyGraded ? r.finalPercentage : r.percentage;
                        return sum + percentage;
                    }, 0) / testResults.length;
                    
                    const passRate = (testResults.filter(r => {
                        const percentage = r.isManuallyGraded ? r.finalPercentage : r.percentage;
                        return percentage >= test.passingScore;
                    }).length / testResults.length) * 100;
                    
                    const needsGradingCount = testResults.filter(r => r.needsManualGrading && !r.isManuallyGraded).length;
                    
                    html += `
                        <div class="test-card published" style="margin-bottom: 30px;">
                            <h3>${test.title}</h3>
                            <p style="color: #666; margin-bottom: 15px;">${test.subject} - ${new Date(test.createdAt).toLocaleDateString('ar-SA')}</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: #e8f0fe; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">عدد الطلاب</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #4a6fa5;">${testResults.length}</p>
                                </div>
                                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">متوسط النسبة</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #9c27b0;">${avgPercentage.toFixed(1)}%</p>
                                </div>
                                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #666;">نسبة النجاح</p>
                                    <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #28a745;">${passRate.toFixed(1)}%</p>
                                </div>
                                ${needsGradingCount > 0 ? `
                                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                                        <p style="margin: 0; font-size: 14px; color: #856404;">يحتاج تصحيح</p>
                                        <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: #ffc107;">${needsGradingCount}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="viewTestResults('${testId}')" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> عرض التفاصيل
                                </button>
                                <button onclick="viewStudentAnswers('${testId}')" class="btn btn-info">
                                    <i class="fas fa-edit"></i> تصحيح الإجابات
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('خطأ في تحديث قائمة النتائج:', error);
                showAlert('حدث خطأ في تحديث قائمة النتائج', 'error');
            }
        }
        
        function viewStudentAnswers(testId) {
            try {
                const test = testsList.find(t => t.id === testId);
                if (!test) {
                    showAlert('الاختبار غير موجود', 'error');
                    return;
                }

                gradingResults = resultsList.filter(r => r.testId === testId);
                if (gradingResults.length === 0) {
                    showAlert('لا توجد إجابات لهذا الاختبار', 'error');
                    return;
                }

                currentGradingTest = test;
                currentStudentIndex = 0;
                
                const modal = document.createElement('div');
                modal.className = 'answers-modal';
                modal.innerHTML = `
                    <div class="answers-content">
                        <button class="close-modal-btn" onclick="closeGradingModal()">✖</button>
                        
                        <div class="student-nav">
                            <div>
                                <h2 style="margin: 0; color: #1a237e;">تصحيح إجابات الطلاب</h2>
                                <p style="color: #666; margin: 5px 0 0;">${test.title} - ${test.subject}</p>
                            </div>
                            
                            <div class="student-selector">
                                <select id="gradingStudentSelect" onchange="switchGradingStudent(this.value)">
                                    <option value="">اختر طالباً للتصحيح</option>
                                    ${gradingResults.map((r, i) => `
                                        <option value="${i}">${r.studentName} (${r.studentSsn}) - ${r.isManuallyGraded ? r.finalPercentage : r.percentage}%</option>
                                    `).join('')}
                                </select>
                                
                                <span class="status-badge ${test.questions.some(q => q.type === 'essay') ? 'pending' : 'graded'}">
                                    ${test.questions.some(q => q.type === 'essay') ? 'يحتاج تصحيح يدوي' : 'مصحح تلقائياً'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="student-navigation" id="studentNavigation" style="display: none;">
                            <button onclick="prevStudent()" class="student-nav-btn">
                                <i class="fas fa-arrow-right"></i> الطالب السابق
                            </button>
                            <span id="studentCounter" style="font-weight: 600; color: #4a6fa5;"></span>
                            <button onclick="nextStudent()" class="student-nav-btn">
                                الطالب التالي <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                        
                        <div id="gradingContainer" style="display: none;">
                            <div class="progress-indicator" id="progressIndicator"></div>
                            <div class="question-nav" id="questionNav"></div>
                            
                            <div class="question-answers-container">
                                <div id="answersView"></div>
                                
                                <div class="grading-panel" id="gradingPanel"></div>
                            </div>
                            
                            <div class="navigation-buttons">
                                <button onclick="previousGradingQuestion()" class="btn btn-secondary">
                                    <i class="fas fa-arrow-right"></i> السؤال السابق
                                </button>
                                
                                <button onclick="saveAllGrades()" class="btn btn-success">
                                    <i class="fas fa-save"></i> حفظ جميع الدرجات
                                </button>
                                
                                <button onclick="nextGradingQuestion()" class="btn btn-primary">
                                    السؤال التالي <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="print-btn" id="printAnswersBtn" style="display: none;" onclick="printStudentAnswers()">
                            <i class="fas fa-print"></i> طباعة الإجابات
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                
                const penTool = document.createElement('div');
                penTool.className = 'pen-touch-tool';
                penTool.innerHTML = '<i class="fas fa-pen"></i>';
                penTool.onclick = function() {
                    this.classList.toggle('active');
                    showGradeOverlay();
                };
                modal.querySelector('.answers-content').appendChild(penTool);
                
            } catch (error) {
                console.error('خطأ في عرض الإجابات:', error);
                showAlert('حدث خطأ في عرض الإجابات', 'error');
            }
        }
        
        function showGradeOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'grade-overlay';
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <div class="grade-input-overlay">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50;">إدخال الدرجة</h3>
                    <input type="number" id="overlayGradeInput" style="padding: 15px; font-size: 24px; width: 150px; text-align: center; border: 3px solid #4a6fa5; border-radius: 10px;" min="0" max="${currentGradingTest.questions[currentQuestionIdx]?.points || 10}">
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="setOverlayGrade()" class="btn btn-success" style="padding: 10px 20px;">
                            <i class="fas fa-check"></i> حفظ
                        </button>
                        <button onclick="this.closest('.grade-overlay').remove()" class="btn btn-danger" style="padding: 10px 20px;">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                </div>
            `;
            
            const answersView = document.getElementById('answersView');
            if (answersView) {
                answersView.appendChild(overlay);
            }
        }
        
        function setOverlayGrade() {
            const gradeInput = document.getElementById('overlayGradeInput');
            if (gradeInput) {
                const grade = parseFloat(gradeInput.value) || 0;
                updateManualGrade(currentQuestionIdx, grade);
                saveManualGrade(currentQuestionIdx);
                
                const overlay = document.querySelector('.grade-overlay');
                if (overlay) {
                    overlay.remove();
                }
                
                addGradeWatermark(grade);
            }
        }
        
        function addGradeWatermark(grade) {
            const answerElement = document.querySelector('.student-answer');
            if (answerElement) {
                const existingWatermark = answerElement.querySelector('.grade-watermark');
                if (existingWatermark) {
                    existingWatermark.remove();
                }
                
                const watermark = document.createElement('div');
                watermark.className = 'grade-watermark';
                watermark.textContent = `الدرجة: ${grade}/${currentGradingTest.questions[currentQuestionIdx]?.points || 10}`;
                answerElement.style.position = 'relative';
                answerElement.appendChild(watermark);
            }
        }
        
        function viewStudentSpecificAnswers(testId, studentSsn) {
            const test = testsList.find(t => t.id === testId);
            if (!test) return;
            
            const results = resultsList.filter(r => r.testId === testId);
            const studentIndex = results.findIndex(r => r.studentSsn === studentSsn);
            
            if (studentIndex !== -1) {
                viewStudentAnswers(testId);
                
                setTimeout(() => {
                    const select = document.getElementById('gradingStudentSelect');
                    if (select) {
                        select.value = studentIndex;
                        switchGradingStudent(studentIndex.toString());
                    }
                }, 100);
            }
        }
        
        function switchGradingStudent(resultIndex) {
            const select = document.getElementById('gradingStudentSelect');
            const gradingContainer = document.getElementById('gradingContainer');
            const studentNavigation = document.getElementById('studentNavigation');
            const printBtn = document.getElementById('printAnswersBtn');
            
            if (select.value === '') {
                gradingContainer.style.display = 'none';
                studentNavigation.style.display = 'none';
                if (printBtn) printBtn.style.display = 'none';
                return;
            }

            currentStudentIndex = parseInt(resultIndex);
            currentGradingStudent = gradingResults[currentStudentIndex];
            currentGradingAnswers = currentGradingStudent.answers;
            currentQuestionIdx = 0;
            manualGrades = {};

            const savedGrades = JSON.parse(localStorage.getItem(`manual_grades_${currentGradingTest.id}_${currentGradingStudent.studentSsn}`)) || {};
            manualGrades = savedGrades;

            gradingContainer.style.display = 'block';
            studentNavigation.style.display = 'flex';
            if (printBtn) printBtn.style.display = 'flex';
            
            updateStudentCounter();
            updateGradingDisplay();
        }
        
        function updateStudentCounter() {
            const counter = document.getElementById('studentCounter');
            if (counter) {
                counter.textContent = `الطالب ${currentStudentIndex + 1} من ${gradingResults.length}`;
            }
        }
        
        function prevStudent() {
            if (currentStudentIndex > 0) {
                currentStudentIndex--;
                document.getElementById('gradingStudentSelect').value = currentStudentIndex;
                switchGradingStudent(currentStudentIndex.toString());
            }
        }
        
        function nextStudent() {
            if (currentStudentIndex < gradingResults.length - 1) {
                currentStudentIndex++;
                document.getElementById('gradingStudentSelect').value = currentStudentIndex;
                switchGradingStudent(currentStudentIndex.toString());
            }
        }
        
        function updateGradingDisplay() {
            updateQuestionNavigation();
            updateProgressIndicator();
            displayCurrentAnswer();
            updateGradingPanel();
        }
        
        function updateQuestionNavigation() {
            const nav = document.getElementById('questionNav');
            let html = '<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;">';
            
            currentGradingTest.questions.forEach((q, index) => {
                const isGraded = q.type === 'mcq' || manualGrades[index] !== undefined;
                const isCurrent = index === currentQuestionIdx;
                
                html += `
                    <button class="question-nav-btn ${isCurrent ? 'active' : ''}" 
                            onclick="goToGradingQuestion(${index})" 
                            style="${isGraded ? 'background: #d4edda; border-color: #28a745;' : ''}
                                   ${isCurrent ? 'transform: scale(1.1); box-shadow: 0 0 10px rgba(74, 111, 165, 0.5);' : ''}
                                   position: relative;">
                        ${index + 1}
                        ${isCurrent ? '<div style="position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: #4a6fa5; border-radius: 50%;"></div>' : ''}
                    </button>
                `;
            });
            
            html += '</div>';
            nav.innerHTML = html;
        }
        
        function updateProgressIndicator() {
            const totalQuestions = currentGradingTest.questions.length;
            const currentQuestion = currentQuestionIdx + 1;
            const progress = (currentQuestion / totalQuestions) * 100;
            
            const progressHtml = `
                <div style="display: flex; align-items: center; gap: 15px; margin: 10px 0; justify-content: center;">
                    <div style="font-size: 14px; color: #4a6fa5; font-weight: 600;">
                        السؤال ${currentQuestion} من ${totalQuestions}
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ${Math.round(progress)}% مكتمل
                    </div>
                </div>
            `;
            
            const existingProgress = document.getElementById('progressIndicator');
            if (existingProgress) {
                existingProgress.innerHTML = progressHtml;
            } else {
                const nav = document.getElementById('questionNav');
                const progressDiv = document.createElement('div');
                progressDiv.id = 'progressIndicator';
                progressDiv.innerHTML = progressHtml;
                nav.parentNode.insertBefore(progressDiv, nav.nextSibling);
            }
        }
        
        function goToGradingQuestion(index) {
            currentQuestionIdx = index;
            updateGradingDisplay();
        }
        
        function displayCurrentAnswer() {
            const container = document.getElementById('answersView');
            const question = currentGradingTest.questions[currentQuestionIdx];
            const studentAnswer = currentGradingAnswers[currentQuestionIdx];
            
            let html = `
                <div class="answer-view">
                    <div class="answer-header">
                        <h3 style="margin: 0; color: #2c3e50;">سؤال ${currentQuestionIdx + 1}</h3>
                        <span class="answer-type-badge ${question.type === 'mcq' ? 'mcq-answer' : 'essay-answer'}">
                            ${question.type === 'mcq' ? 'اختيار من متعدد' : 'مقالي (رسم وكتابة)'}
                        </span>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">نص السؤال:</h4>
                        <p style="color: #666; line-height: 1.6; margin: 0;">${question.text}</p>
                        <p style="color: #4a6fa5; margin: 10px 0 0; font-weight: 600;">
                            <i class="fas fa-star"></i> الدرجة: ${question.points}
                        </p>
                    </div>
                    
                    <div class="student-answer">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">
                            <i class="fas fa-user-graduate"></i> إجابة الطالب:
                        </h4>
            `;

            if (question.type === 'mcq') {
                const selectedOption = studentAnswer;
                const isCorrect = selectedOption === question.correctAnswer;
                
                html += `
                    <div class="${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                        <p style="margin: 0; font-weight: 600;">
                            ${isCorrect ? '✓ إجابة صحيحة' : '✗ إجابة خاطئة'}
                        </p>
                        <p style="margin: 10px 0 0; color: #2c3e50;">اختيار الطالب: ${question.options[selectedOption] || 'لم يجيب'}</p>
                        ${!isCorrect ? `
                            <p style="margin: 10px 0 0; color: #28a745;">
                                <strong>الإجابة الصحيحة:</strong> ${question.options[question.correctAnswer]}
                            </p>
                        ` : ''}
                    </div>
                `;
            } else {
                html += `<div style="margin-bottom: 20px;">`;
                
                if (studentAnswer && studentAnswer.text) {
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e1e5eb;">
                            <h5 style="margin: 0 0 10px 0; color: #2c3e50;">النص المكتوب:</h5>
                            <p style="color: #666; line-height: 1.6; margin: 0; white-space: pre-wrap;">${studentAnswer.text}</p>
                        </div>
                    `;
                }
                
                if (studentAnswer && studentAnswer.drawing) {
                    html += `
                        <div class="drawing-answer">
                            <h5 style="margin: 0 0 15px 0; color: #2c3e50;">الرسم:</h5>
                            <img src="${studentAnswer.drawing}" alt="رسم الطالب" 
                                 style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;"
                                 onclick="this.style.maxHeight = this.style.maxHeight === '500px' ? '300px' : '500px'">
                            <p style="color: #888; margin: 10px 0 0; font-size: 14px;">
                                <i class="fas fa-expand-arrows-alt"></i> انقر على الصورة للتكبير/التصغير
                            </p>
                        </div>
                    `;
                }
                
                if (!studentAnswer || (!studentAnswer.text && !studentAnswer.drawing)) {
                    html += `
                        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                            <i class="fas fa-times-circle" style="font-size: 48px; color: #dc3545; margin-bottom: 15px;"></i>
                            <p style="color: #666; margin: 0;">لم يجب الطالب على هذا السؤال</p>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                const savedGrade = manualGrades[currentQuestionIdx];
                if (savedGrade !== undefined) {
                    html += `
                        <div class="grade-watermark">
                            الدرجة: ${savedGrade}/${question.points}
                        </div>
                    `;
                }
            }
            
            html += `</div></div>`;
            container.innerHTML = html;
        }
        
        function updateGradingPanel() {
            const panel = document.getElementById('gradingPanel');
            const question = currentGradingTest.questions[currentQuestionIdx];
            
            if (question.type === 'mcq') {
                const studentAnswer = currentGradingAnswers[currentQuestionIdx];
                const isCorrect = studentAnswer === question.correctAnswer;
                const autoScore = isCorrect ? question.points : 0;
                
                panel.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50;">
                        <i class="fas fa-check-circle"></i> التصحيح التلقائي
                    </h3>
                    
                    <div style="background: ${isCorrect ? '#d4edda' : '#f8d7da'}; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: ${isCorrect ? '#155724' : '#721c24'}; font-weight: 600;">
                            ${isCorrect ? '✓ الإجابة صحيحة' : '✗ الإجابة خاطئة'}
                        </p>
                        <p style="margin: 10px 0 0; color: ${isCorrect ? '#155724' : '#721c24'}">
                            الدرجة التلقائية: <strong>${autoScore}/${question.points}</strong>
                        </p>
                    </div>
                    
                    <div class="total-score-card">
                        <p style="margin: 0; font-size: 14px;">الدرجة لهذا السؤال</p>
                        <div class="total-score">${autoScore}/${question.points}</div>
                        <p style="margin: 5px 0 0; opacity: 0.9;">(${Math.round((autoScore/question.points)*100)}%)</p>
                    </div>
                `;
            } else {
                const currentGrade = manualGrades[currentQuestionIdx] || 0;
                const maxGrade = question.points;
                
                panel.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50;">
                        <i class="fas fa-edit"></i> التصحيح اليدوي
                    </h3>
                    
                    <div class="manual-grade-section">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-marker" style="color: #4a6fa5; font-size: 20px;"></i>
                                <span style="font-weight: 600; color: #2c3e50;">أدوات التصحيح:</span>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div class="pen-tool-marker ${currentGrade === maxGrade * 0.25 ? 'active' : ''}" 
                                     onclick="setQuickGrade(${currentQuestionIdx}, ${maxGrade * 0.25})" 
                                     title="25%" style="font-size: 16px;">
                                    25%
                                </div>
                                <div class="pen-tool-marker ${currentGrade === maxGrade * 0.5 ? 'active' : ''}" 
                                     onclick="setQuickGrade(${currentQuestionIdx}, ${maxGrade * 0.5})" 
                                     title="50%" style="font-size: 16px;">
                                    50%
                                </div>
                                <div class="pen-tool-marker ${currentGrade === maxGrade * 0.75 ? 'active' : ''}" 
                                     onclick="setQuickGrade(${currentQuestionIdx}, ${maxGrade * 0.75})" 
                                     title="75%" style="font-size: 16px;">
                                    75%
                                </div>
                                <div class="pen-tool-marker ${currentGrade === maxGrade ? 'active' : ''}" 
                                     onclick="setQuickGrade(${currentQuestionIdx}, ${maxGrade})" 
                                     title="100%" style="font-size: 16px;">
                                    ✓
                                </div>
                            </div>
                        </div>
                        
                        <div class="grade-input">
                            <label style="font-weight: 600; color: #2c3e50;">أدخل الدرجة:</label>
                            <input type="number" id="manualGradeInput" min="0" max="${maxGrade}" 
                                   value="${currentGrade}" step="0.5" 
                                   onchange="updateManualGrade(${currentQuestionIdx}, this.value)">
                            <span style="color: #666;">من ${maxGrade}</span>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 10px;">ملاحظات التصحيح:</label>
                            <textarea id="gradeNotes" rows="3" placeholder="أدخل ملاحظاتك على إجابة الطالب..." 
                                      style="width: 100%; padding: 12px; border: 2px solid #e1e5eb; border-radius: 8px; font-size: 14px;"></textarea>
                        </div>
                        
                        <div class="grading-controls">
                            <button onclick="saveManualGrade(${currentQuestionIdx})" class="btn btn-success">
                                <i class="fas fa-save"></i> حفظ
                            </button>
                            <button onclick="resetManualGrade(${currentQuestionIdx})" class="btn btn-danger">
                                <i class="fas fa-undo"></i> إعادة تعيين
                            </button>
                        </div>
                    </div>
                    
                    ${currentGrade > 0 ? `
                        <div class="grade-history">
                            <p style="margin: 0; color: #666;">
                                <i class="fas fa-history"></i> آخر تحديث: ${new Date().toLocaleString('ar-SA')}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="total-score-card">
                        <p style="margin: 0; font-size: 14px;">الدرجة الحالية</p>
                        <div class="total-score">${currentGrade}/${maxGrade}</div>
                        <p style="margin: 5px 0 0; opacity: 0.9;">(${maxGrade > 0 ? Math.round((currentGrade/maxGrade)*100) : 0}%)</p>
                    </div>
                `;
                
                const savedNotes = JSON.parse(localStorage.getItem(`grade_notes_${currentGradingTest.id}_${currentGradingStudent.studentSsn}`)) || {};
                if (savedNotes[currentQuestionIdx]) {
                    document.getElementById('gradeNotes').value = savedNotes[currentQuestionIdx];
                }
            }
            
            updateTotalScoreDisplay();
        }
        
        function setQuickGrade(questionIndex, grade) {
            document.getElementById('manualGradeInput').value = grade;
            updateManualGrade(questionIndex, grade);
            
            document.querySelectorAll('.pen-tool-marker').forEach(tool => {
                tool.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function updateManualGrade(questionIndex, grade) {
            const maxGrade = currentGradingTest.questions[questionIndex].points;
            const numericGrade = Math.min(Math.max(parseFloat(grade) || 0, 0), maxGrade);
            
            manualGrades[questionIndex] = numericGrade;
            updateTotalScoreDisplay();
        }
        
        function saveManualGrade(questionIndex) {
            const gradeInput = document.getElementById('manualGradeInput');
            const notesInput = document.getElementById('gradeNotes');
            
            if (gradeInput) {
                const grade = parseFloat(gradeInput.value) || 0;
                manualGrades[questionIndex] = grade;
            }
            
            if (notesInput) {
                const savedNotes = JSON.parse(localStorage.getItem(`grade_notes_${currentGradingTest.id}_${currentGradingStudent.studentSsn}`)) || {};
                savedNotes[questionIndex] = notesInput.value;
                localStorage.setItem(`grade_notes_${currentGradingTest.id}_${currentGradingStudent.studentSsn}`, JSON.stringify(savedNotes));
            }
            
            updateQuestionNavigation();
            updateTotalScoreDisplay();
            
            addGradeWatermark(manualGrades[questionIndex] || 0);
            
            showAlert('تم حفظ الدرجة بنجاح', 'success');
        }
        
        function resetManualGrade(questionIndex) {
            if (confirm('هل تريد إعادة تعيين درجة هذا السؤال؟')) {
                delete manualGrades[questionIndex];
                
                const notesInput = document.getElementById('gradeNotes');
                if (notesInput) notesInput.value = '';
                
                const gradeInput = document.getElementById('manualGradeInput');
                if (gradeInput) gradeInput.value = 0;
                
                document.querySelectorAll('.pen-tool-marker').forEach(tool => {
                    tool.classList.remove('active');
                });
                
                const watermark = document.querySelector('.grade-watermark');
                if (watermark) {
                    watermark.remove();
                }
                
                updateGradingPanel();
                showAlert('تم إعادة تعيين الدرجة', 'success');
            }
        }
        
        function saveAllGrades() {
            try {
                const totalScore = calculateTotalScore();
                
                const studentIndex = resultsList.findIndex(r => 
                    r.testId === currentGradingTest.id && 
                    r.studentSsn === currentGradingStudent.studentSsn
                );
                
                if (studentIndex !== -1) {
                    resultsList[studentIndex].manualGrades = {...manualGrades};
                    resultsList[studentIndex].finalScore = totalScore.total;
                    resultsList[studentIndex].finalPercentage = totalScore.percentage;
                    resultsList[studentIndex].gradedAt = new Date().toISOString();
                    resultsList[studentIndex].isManuallyGraded = true;
                    
                    localStorage.setItem('teacher_results', JSON.stringify(resultsList));
                    
                    localStorage.setItem(`manual_grades_${currentGradingTest.id}_${currentGradingStudent.studentSsn}`, 
                                       JSON.stringify(manualGrades));
                    
                    showAlert('تم حفظ جميع الدرجات بنجاح!', 'success');
                    
                    updateResultsList();
                    updateDashboard();
                    
                    setTimeout(() => {
                        closeGradingModal();
                        if (document.querySelector('.tab-content.active').id === 'viewTests') {
                            updateTestsList();
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('خطأ في حفظ الدرجات:', error);
                showAlert('حدث خطأ في حفظ الدرجات', 'error');
            }
        }
        
        function calculateTotalScore() {
            let autoScore = 0;
            let manualScore = 0;
            let totalPossible = 0;
            
            currentGradingTest.questions.forEach((question, index) => {
                totalPossible += question.points;
                
                if (question.type === 'mcq') {
                    const studentAnswer = currentGradingAnswers[index];
                    const isCorrect = studentAnswer === question.correctAnswer;
                    autoScore += isCorrect ? question.points : 0;
                } else {
                    manualScore += manualGrades[index] || 0;
                }
            });
            
            const totalScore = autoScore + manualScore;
            const percentage = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;
            
            return {
                autoScore,
                manualScore,
                total: totalScore,
                totalPossible,
                percentage
            };
        }
        
        function updateTotalScoreDisplay() {
            const totalScore = calculateTotalScore();
            const panel = document.getElementById('gradingPanel');
            
            const scoreCards = panel.querySelectorAll('.total-score-card');
            scoreCards.forEach(card => {
                const scoreElement = card.querySelector('.total-score');
                if (scoreElement) {
                    scoreElement.textContent = `${totalScore.total}/${totalScore.totalPossible}`;
                    
                    const percentageElement = card.querySelector('p:nth-child(3)');
                    if (percentageElement) {
                        percentageElement.textContent = `(${totalScore.percentage}%)`;
                    }
                }
            });
            
            const studentSelect = document.getElementById('gradingStudentSelect');
            if (studentSelect && currentGradingStudent) {
                const option = studentSelect.options[studentSelect.selectedIndex];
                if (option) {
                    option.text = `${currentGradingStudent.studentName} (${currentGradingStudent.studentSsn}) - ${totalScore.percentage}%`;
                }
            }
        }
        
        function previousGradingQuestion() {
            if (currentQuestionIdx > 0) {
                currentQuestionIdx--;
                updateGradingDisplay();
            }
        }
        
        function nextGradingQuestion() {
            if (currentQuestionIdx < currentGradingTest.questions.length - 1) {
                currentQuestionIdx++;
                updateGradingDisplay();
            }
        }
        
        function closeGradingModal() {
            const modal = document.querySelector('.answers-modal');
            if (modal) {
                modal.remove();
            }
            currentGradingTest = null;
            currentGradingStudent = null;
            currentGradingAnswers = null;
            currentQuestionIdx = 0;
            manualGrades = {};
        }
        
        function printTestDetails(testIndex) {
            const test = testsList[testIndex];
            if (!test) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>${test.title} - طباعة</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .test-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                        .question { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 10px; }
                        .question-number { font-weight: bold; color: #4a6fa5; }
                        .answer-space { height: 100px; border: 1px dashed #ccc; margin: 10px 0; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${test.title}</h1>
                        <h3>${test.subject}</h3>
                        <p>زمن الاختبار: ${test.duration} دقيقة | درجة النجاح: ${test.passingScore}%</p>
                    </div>
                    <div class="test-info">
                        <p><strong>الوصف:</strong> ${test.description || 'بدون وصف'}</p>
                        <p><strong>تاريخ البدء:</strong> ${new Date(test.startTime).toLocaleString('ar-SA')}</p>
                        <p><strong>تاريخ الانتهاء:</strong> ${new Date(test.endTime).toLocaleString('ar-SA')}</p>
                    </div>
                    ${test.questions.map((q, i) => `
                        <div class="question">
                            <div class="question-number">سؤال ${i+1} (${q.points} درجة)</div>
                            <p>${q.text}</p>
                            ${q.type === 'mcq' ? q.options.map((opt, j) => `
                                <div>${j+1}. ${opt}</div>
                            `).join('') : `
                                <div class="answer-space"></div>
                            `}
                        </div>
                    `).join('')}
                    <button class="no-print" onclick="window.print()" style="position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #4a6fa5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        طباعة
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function printStudentAnswers() {
            const printWindow = window.open('', '_blank');
            const test = currentGradingTest;
            const student = currentGradingStudent;
            
            if (!test || !student) return;
            
            let answersHtml = '';
            test.questions.forEach((q, i) => {
                const answer = currentGradingAnswers[i];
                answersHtml += `
                    <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
                        <div style="font-weight: bold; color: #4a6fa5; margin-bottom: 10px;">
                            سؤال ${i+1} (${q.points} درجة)
                        </div>
                        <p style="margin-bottom: 15px;">${q.text}</p>
                `;
                
                if (q.type === 'mcq') {
                    const isCorrect = answer === q.correctAnswer;
                    answersHtml += `
                        <div style="background: ${isCorrect ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px;">
                            <strong>إجابة الطالب:</strong> ${q.options[answer] || 'لم يجيب'}
                            ${!isCorrect ? `<br><strong>الإجابة الصحيحة:</strong> ${q.options[q.correctAnswer]}` : ''}
                        </div>
                    `;
                } else {
                    if (answer && answer.text) {
                        answersHtml += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>الإجابة النصية:</strong><br>
                                ${answer.text}
                            </div>
                        `;
                    }
                    if (answer && answer.drawing) {
                        answersHtml += `
                            <div style="text-align: center; margin: 10px 0;">
                                <strong>الرسم:</strong><br>
                                <img src="${answer.drawing}" style="max-width: 300px; max-height: 200px; border: 1px solid #ddd;">
                            </div>
                        `;
                    }
                    const manualGrade = manualGrades[i];
                    if (manualGrade !== undefined) {
                        answersHtml += `
                            <div style="background: #e8f0fe; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold;">
                                الدرجة: ${manualGrade}/${q.points}
                            </div>
                        `;
                    }
                }
                
                answersHtml += `</div>`;
            });
            
            const totalScore = calculateTotalScore();
            
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>${student.studentName} - ${test.title}</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .student-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                        .score-card { background: #4a6fa5; color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>إجابات الطالب: ${student.studentName}</h1>
                        <h3>الاختبار: ${test.title} - ${test.subject}</h3>
                    </div>
                    <div class="student-info">
                        <p><strong>رقم السجل المدني:</strong> ${student.studentSsn}</p>
                        <p><strong>تاريخ الإكمال:</strong> ${new Date(student.completedAt || new Date()).toLocaleString('ar-SA')}</p>
                    </div>
                    <div class="score-card">
                        <h2>النتيجة النهائية</h2>
                        <div style="font-size: 36px; font-weight: bold; margin: 10px 0;">
                            ${totalScore.total}/${totalScore.totalPossible}
                        </div>
                        <div style="font-size: 24px;">
                            ${totalScore.percentage}%
                        </div>
                        <div style="margin-top: 10px;">
                            ${totalScore.percentage >= test.passingScore ? 'ناجح ✓' : 'راسب ✗'}
                        </div>
                    </div>
                    ${answersHtml}
                    <button class="no-print" onclick="window.print()" style="position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #4a6fa5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        طباعة
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('importAlert');
            if (!alertDiv) {
                const newAlert = document.createElement('div');
                newAlert.id = 'importAlert';
                newAlert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
                newAlert.textContent = message;
                newAlert.style.display = 'block';
                
                const currentTab = document.querySelector('.tab-content.active');
                if (currentTab) {
                    currentTab.insertBefore(newAlert, currentTab.firstChild);
                } else {
                    document.body.appendChild(newAlert);
                }
            } else {
                alertDiv.textContent = message;
                alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
                alertDiv.style.display = 'block';
            }
            
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.style.display = 'none';
                }
            }, 5000);
        }
    </script>
</body>
</html>
